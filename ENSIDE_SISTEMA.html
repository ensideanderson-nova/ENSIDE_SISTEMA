<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤– ENSIDE SYSTEM v10.0 - Sistema Completo + IA + WhatsApp</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* â•â•â•â•â• SISTEMA DE TEMAS â•â•â•â•â• */
        :root {
            --primary: #1a5f2a;
            --secondary: #2e8b3e;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #dc3545;
            --info: #17a2b8;
            --whatsapp: #25D366;
            --dark: #1e293b;
            --bg-gradient-start: #0f172a;
            --bg-gradient-end: #1e293b;
            --header-gradient-start: #4ade80;
            --header-gradient-end: #22c55e;
        }
        
        /* Tema Verde (PadrÃ£o) */
        [data-theme="green"] {
            --primary: #1a5f2a;
            --secondary: #2e8b3e;
            --success: #10b981;
            --header-gradient-start: #4ade80;
            --header-gradient-end: #22c55e;
        }
        
        /* Tema Roxo */
        [data-theme="purple"] {
            --primary: #7c3aed;
            --secondary: #8b5cf6;
            --success: #a78bfa;
            --header-gradient-start: #c084fc;
            --header-gradient-end: #8b5cf6;
        }
        
        /* Tema Azul */
        [data-theme="blue"] {
            --primary: #2563eb;
            --secondary: #3b82f6;
            --success: #60a5fa;
            --header-gradient-start: #93c5fd;
            --header-gradient-end: #3b82f6;
        }
        
        /* Tema Vermelho */
        [data-theme="red"] {
            --primary: #dc2626;
            --secondary: #ef4444;
            --success: #f87171;
            --header-gradient-start: #fca5a5;
            --header-gradient-end: #ef4444;
        }
        
        /* Tema Laranja */
        [data-theme="orange"] {
            --primary: #ea580c;
            --secondary: #f97316;
            --success: #fb923c;
            --header-gradient-start: #fdba74;
            --header-gradient-end: #f97316;
        }
        
        /* Tema Rosa */
        [data-theme="pink"] {
            --primary: #db2777;
            --secondary: #ec4899;
            --success: #f472b6;
            --header-gradient-start: #f9a8d4;
            --header-gradient-end: #ec4899;
        }
        
        /* Modo Claro */
        [data-mode="light"] {
            --bg-gradient-start: #f1f5f9;
            --bg-gradient-end: #e2e8f0;
            --dark: #f8fafc;
            color: #1e293b;
        }
        
        [data-mode="light"] .panel,
        [data-mode="light"] .header,
        [data-mode="light"] .agent-bar,
        [data-mode="light"] .stat-card {
            background: rgba(0,0,0,0.05);
            border-color: rgba(0,0,0,0.1);
            color: #1e293b;
        }
        
        [data-mode="light"] .tab-btn {
            background: rgba(0,0,0,0.05);
            color: #1e293b;
        }
        
        [data-mode="light"] .tab-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: #fff;
        }
        
        [data-mode="light"] table th {
            background: rgba(0,0,0,0.1);
            color: #1e293b;
        }
        
        [data-mode="light"] table td {
            border-color: rgba(0,0,0,0.1);
            color: #1e293b;
        }
        
        [data-mode="light"] input,
        [data-mode="light"] select,
        [data-mode="light"] textarea {
            background: rgba(0,0,0,0.05);
            border-color: rgba(0,0,0,0.2);
            color: #1e293b;
        }
        
        [data-mode="light"] .alert.info {
            background: rgba(23,162,184,0.2);
            color: #0c5460;
        }

        /* BotÃµes de Tema */
        .theme-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .theme-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
        }
        
        .theme-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .theme-btn.active {
            border-color: white;
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }
        
        .mode-toggle {
            display: flex;
            gap: 10px;
        }
        
        .mode-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .mode-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .mode-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: var(--primary);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
            min-height: 100vh;
            color: #fff;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

        /* Header */
        .header {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 1.8em;
            background: linear-gradient(135deg, var(--header-gradient-start), var(--header-gradient-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-badges { display: flex; gap: 10px; flex-wrap: wrap; }

        .badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-success { background: linear-gradient(135deg, var(--success), #059669); }
        .badge-warning { background: linear-gradient(135deg, var(--warning), #d97706); color: #1e293b; }
        .badge-whatsapp { background: linear-gradient(135deg, var(--whatsapp), #128C7E); }
        .badge-info { background: linear-gradient(135deg, var(--info), #0891b2); }

        /* Agent Stats Bar */
        .agent-bar {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 15px 25px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .agent-info { display: flex; align-items: center; gap: 15px; }
        .agent-avatar { font-size: 2.5em; }
        .agent-name { font-weight: 700; font-size: 1.2em; }
        .agent-level { font-size: 0.85em; color: var(--success); }

        .agent-stats-mini { display: flex; gap: 20px; }
        .stat-mini { text-align: center; }
        .stat-mini .value { font-size: 1.3em; font-weight: 700; color: var(--success); }
        .stat-mini .label { font-size: 0.75em; color: rgba(255,255,255,0.6); }

        .xp-bar {
            width: 200px;
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), #22c55e);
            transition: width 0.5s;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .tab-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }
        .tab-btn.active { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #fff; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Panels */
        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .panel-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
        }

        /* Import Zone */
        .import-zone {
            border: 3px dashed rgba(255,255,255,0.3);
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .import-zone:hover, .import-zone.dragover {
            border-color: var(--success);
            background: rgba(16,185,129,0.1);
        }

        .import-zone .icon { font-size: 4em; margin-bottom: 15px; }
        .import-zone h3 { font-size: 1.4em; margin-bottom: 10px; }

        /* Triagem Grid */
        .triagem-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .triagem-card {
            background: rgba(255,255,255,0.08);
            border-radius: 14px;
            padding: 20px;
            border-left: 4px solid var(--primary);
        }

        .triagem-card.pendente { border-left-color: var(--warning); }
        .triagem-card.aprovado { border-left-color: var(--success); }
        .triagem-card.rejeitado { border-left-color: var(--danger); }

        .triagem-card .file-icon { font-size: 2em; margin-bottom: 10px; }
        .triagem-card .file-name { font-weight: 600; margin-bottom: 8px; word-break: break-all; }
        .triagem-card .file-info { font-size: 0.85em; color: rgba(255,255,255,0.6); margin-bottom: 15px; }

        .triagem-card select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.2);
            background: rgba(255,255,255,0.1);
            color: #fff;
            margin-bottom: 10px;
        }

        .triagem-card select option { background: #1e293b; }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: #fff; }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: #fff; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #b91c1c); color: #fff; }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #d97706); color: #1e293b; }
        .btn-whatsapp { background: linear-gradient(135deg, var(--whatsapp), #128C7E); color: #fff; }
        .btn-info { background: linear-gradient(135deg, var(--info), #0891b2); color: #fff; }

        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        .btn-full { width: 100%; justify-content: center; }
        .btn-small { padding: 8px 14px; font-size: 0.85em; }

        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }

        input[type="file"] { display: none; }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.08);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-card .icon { font-size: 2em; margin-bottom: 8px; }
        .stat-card .value { font-size: 2em; font-weight: 700; }
        .stat-card .label { font-size: 0.8em; color: rgba(255,255,255,0.6); }

        /* Categorias */
        .categorias-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }

        .categoria-item {
            background: rgba(255,255,255,0.06);
            border-radius: 10px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .categoria-item:hover {
            background: rgba(255,255,255,0.12);
            transform: translateX(5px);
        }

        .categoria-item .name { font-weight: 600; }
        .categoria-item .count {
            background: var(--primary);
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        /* Forms */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.85em; }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            background: rgba(255,255,255,0.08);
            color: #fff;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: var(--primary);
            outline: none;
        }

        .form-group input::placeholder, .form-group textarea::placeholder { color: rgba(255,255,255,0.4); }
        .form-group select option { background: #1e293b; }

        /* Table */
        .table-container { overflow-x: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        thead { background: rgba(255,255,255,0.1); }
        th, td { padding: 12px; text-align: left; }
        tbody tr { border-bottom: 1px solid rgba(255,255,255,0.1); }
        tbody tr:hover { background: rgba(255,255,255,0.05); }

        /* Alerts */
        .alert {
            padding: 14px 18px;
            border-radius: 10px;
            margin: 12px 0;
            font-size: 0.9em;
            border-left: 4px solid;
        }

        .alert.success { background: rgba(16,185,129,0.15); border-color: var(--success); }
        .alert.error { background: rgba(220,53,69,0.15); border-color: var(--danger); }
        .alert.info { background: rgba(23,162,184,0.15); border-color: var(--info); }
        .alert.warning { background: rgba(245,158,11,0.15); border-color: var(--warning); }

        /* Knowledge Cards */
        .knowledge-card {
            background: rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            border-left: 4px solid var(--success);
        }

        .knowledge-card h4 { color: var(--success); margin-bottom: 8px; }
        .knowledge-card p { color: rgba(255,255,255,0.8); font-size: 0.9em; line-height: 1.5; }
        .knowledge-card .tags { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .knowledge-card .tag { background: var(--primary); color: #fff; padding: 3px 10px; border-radius: 10px; font-size: 0.75em; }
        .knowledge-card .source { font-size: 0.8em; color: rgba(255,255,255,0.5); margin-top: 8px; }

        /* Lists */
        .list-card {
            background: rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .list-card .info strong { display: block; margin-bottom: 5px; }
        .list-card .info span { font-size: 0.85em; color: rgba(255,255,255,0.6); }

        /* Progress */
        .progress-bar {
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--success), #059669);
            transition: width 0.5s;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: rgba(255,255,255,0.5);
        }

        .empty-state .icon { font-size: 4em; margin-bottom: 15px; opacity: 0.5; }

        /* Chat Styles */
        .chat-message {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            align-items: flex-start;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            flex-shrink: 0;
        }

        .chat-message.user .chat-avatar {
            background: var(--primary);
        }

        .chat-bubble {
            background: rgba(255,255,255,0.1);
            padding: 12px 18px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.5;
        }

        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .chat-bubble.typing::after {
            content: '...';
            animation: typing 1s infinite;
        }

        @keyframes typing {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* Tipo Badge */
        .tipo-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .tipo-badge.motorista { background: var(--info); }
        .tipo-badge.fornecedor { background: var(--warning); color: #1e293b; }
        .tipo-badge.cliente { background: var(--success); }
        .tipo-badge.indefinido { background: rgba(255,255,255,0.2); }
        .tipo-badge.cartorio { background: #9333ea; }
        .tipo-badge.particular { background: #ec4899; }

        /* Responsive */
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; }
            .tabs { flex-direction: column; }
            .tab-btn { width: 100%; }
            .agent-bar { flex-direction: column; text-align: center; }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- HEADER -->
    <div class="header">
        <div>
            <h1>ğŸ¤– ENSIDE SYSTEM v10.0</h1>
            <p style="color:rgba(255,255,255,0.6);margin-top:5px;">Sistema Completo + Agente IA + WhatsApp + Auto-Aprendizado</p>
        </div>
        <div class="header-badges">
            <span class="badge badge-success">âœ… Triagem Real</span>
            <span class="badge badge-info">ğŸ§  IA Inteligente</span>
            <span class="badge badge-whatsapp">ğŸ“± WhatsApp</span>
        </div>
    </div>

    <!-- AGENT BAR -->
    <div class="agent-bar">
        <div class="agent-info">
            <div class="agent-avatar">ğŸ¤–</div>
            <div>
                <div class="agent-name">Enside Agent</div>
                <div class="agent-level">NÃ­vel <span id="agentLevel">1</span> â€¢ <span id="agentXP">0</span> XP</div>
                <div class="xp-bar">
                    <div class="xp-fill" id="xpBar" style="width: 0%"></div>
                </div>
            </div>
        </div>
        <div class="agent-stats-mini">
            <div class="stat-mini">
                <div class="value" id="agentConhecimentos">0</div>
                <div class="label">Conhecimentos</div>
            </div>
            <div class="stat-mini">
                <div class="value" id="agentPrecisao">85%</div>
                <div class="label">PrecisÃ£o</div>
            </div>
            <div class="stat-mini">
                <div class="value" id="agentInteracoes">0</div>
                <div class="label">InteraÃ§Ãµes</div>
            </div>
        </div>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab-btn active" onclick="abrirAba('importar')">ğŸ“¤ Importar & Triagem</button>
        <button class="tab-btn" onclick="abrirAba('contatos')">ğŸ“‹ Contatos Importados</button>
        <button class="tab-btn" onclick="abrirAba('organizados')">ğŸ“ Arquivos Organizados</button>
        <button class="tab-btn" onclick="abrirAba('agente')">ğŸ¤– Agente IA</button>
        <button class="tab-btn" onclick="abrirAba('ensinar')">ğŸ“š Ensinar IA</button>
        <button class="tab-btn" onclick="abrirAba('fretes')">ğŸšš Fretes</button>
        <button class="tab-btn" onclick="abrirAba('whatsapp')">ğŸ“± WhatsApp</button>
        <button class="tab-btn" onclick="abrirAba('busca')">ğŸ” Busca CPF/CNPJ</button>
        <button class="tab-btn" onclick="abrirAba('dashboard')">ğŸ“Š Dashboard</button>
        <button class="tab-btn" onclick="abrirAba('config')">âš™ï¸ ConfiguraÃ§Ãµes</button>
    </div>

    <!-- IMPORTAR & TRIAGEM -->
    <div id="importar" class="tab-content active">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">ğŸ“¥</div>
                <div class="value" id="statPendentes">0</div>
                <div class="label">Pendentes</div>
            </div>
            <div class="stat-card">
                <div class="icon">âœ…</div>
                <div class="value" id="statOrganizados">0</div>
                <div class="label">Organizados</div>
            </div>
            <div class="stat-card">
                <div class="icon">ğŸ“</div>
                <div class="value" id="statCategorias">45</div>
                <div class="label">Categorias</div>
            </div>
            <div class="stat-card">
                <div class="icon">ğŸ’¾</div>
                <div class="value" id="statTamanho">0 MB</div>
                <div class="label">Total</div>
            </div>
        </div>

        <div class="panel">
            <div class="import-zone" id="importZone" onclick="document.getElementById('fileInput').click()">
                <div class="icon">ğŸ“¦</div>
                <h3>Arraste arquivos ou pastas aqui</h3>
                <p style="color:rgba(255,255,255,0.6);">Ou clique para selecionar</p>
                <div class="btn-group" style="justify-content:center;margin-top:20px;">
                    <button class="btn btn-primary" onclick="event.stopPropagation(); importarArquivos()">ğŸ“„ Arquivos</button>
                    <button class="btn btn-success" onclick="event.stopPropagation(); importarPastas()">ğŸ“ Pasta</button>
                </div>
                <input type="file" id="fileInput" multiple>
            </div>

            <div class="alert info">
                <strong>ğŸ¯ Como funciona:</strong><br>
                1. Importe arquivos ou pastas<br>
                2. Revise e escolha a categoria de cada arquivo<br>
                3. Clique em "Organizar" para mover para a pasta correta<br>
                4. Arquivos sÃ£o movidos para <code>/Users/andersonenside/Enside_Organizado/[CATEGORIA]/</code>
            </div>
        </div>

        <div class="panel" id="panelTriagem" style="display:none;">
            <div class="panel-title">
                ğŸ” Triagem de Arquivos
                <span style="float:right;font-size:0.8em;color:rgba(255,255,255,0.6);" id="triagemCount">0 arquivos</span>
            </div>

            <div class="btn-group" style="margin-bottom:20px;">
                <button class="btn btn-success" onclick="organizarTodos()">âœ… Organizar Todos</button>
                <button class="btn btn-warning" onclick="autoCategorizarTodos()">ğŸ¤– Auto-Categorizar</button>
                <button class="btn btn-danger" onclick="limparTriagem()">ğŸ—‘ï¸ Limpar</button>
            </div>

            <div class="progress-bar" id="progressBar" style="display:none;">
                <div class="progress-fill" id="progressFill" style="width:0%"></div>
            </div>

            <div class="triagem-grid" id="triagemGrid"></div>
        </div>
    </div>

    <!-- CONTATOS IMPORTADOS - PLANILHA -->
    <div id="contatos" class="tab-content">
        <div class="panel">
            <div class="panel-title">ğŸ“‹ Planilha de Contatos Importados</div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">ğŸšš</div>
                    <div class="value" id="totalMotoristas">0</div>
                    <div class="label">Motoristas</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸ­</div>
                    <div class="value" id="totalFornecedores">0</div>
                    <div class="label">Fornecedores</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸ‘”</div>
                    <div class="value" id="totalRepresentantes">0</div>
                    <div class="label">Representantes</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸ‘¥</div>
                    <div class="value" id="totalClientes">0</div>
                    <div class="label">Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸ“Š</div>
                    <div class="value" id="totalContatos">0</div>
                    <div class="label">Total</div>
                </div>
            </div>

            <div class="btn-group" style="margin-bottom:20px;">
                <button class="btn btn-primary" onclick="abrirModalContato()">â• Novo Contato</button>
                <button class="btn btn-info" onclick="document.getElementById('importContatos').click()">ğŸ“ Importar CSV/Excel</button>
                <button class="btn btn-success" onclick="importarGoogleSheets()">ğŸ“Š Importar Google Sheets</button>
                <button class="btn btn-warning" onclick="autoClassificarContatos()">ğŸ§  Auto-Classificar</button>
                <button class="btn btn-danger" onclick="limparDadosContatos()">ğŸ—‘ï¸ Limpar Contatos</button>
                <button class="btn btn-success" onclick="exportarTodosContatos()">ğŸ“¤ Exportar Todos</button>
                <input type="file" id="importContatos" accept=".csv,.xlsx,.xls" onchange="importarContatosArquivo(event)">
            </div>

            <div class="form-row" style="margin-bottom:15px;">
                <div class="form-group">
                    <input type="text" id="filtroContatos" placeholder="ğŸ” Buscar por nome, telefone..." oninput="filtrarContatos()">
                </div>
                <div class="form-group">
                    <select id="filtroTipoContato" onchange="filtrarContatos()">
                        <option value="">ğŸ“‹ Todos os tipos</option>
                        <option value="motorista">ğŸšš Motoristas</option>
                        <option value="fornecedor">ğŸ­ Fornecedores</option>
                        <option value="representante">ğŸ‘” Representantes</option>
                        <option value="cliente">ğŸ‘¥ Clientes</option>
                        <option value="cartorio">ğŸ›ï¸ CartÃ³rios</option>
                        <option value="particular">ğŸ‘¤ Particulares</option>
                        <option value="indefinido">â“ NÃ£o classificados</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ“Š Tabela de Contatos (<span id="contatosFiltrados">0</span>)</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>WhatsApp/Telefone</th>
                            <th>Tipo</th>
                            <th>Cidade/UF</th>
                            <th>ObservaÃ§Ãµes</th>
                            <th>AÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody id="contatosTable"></tbody>
                </table>
            </div>
        </div>

        <!-- Modal Novo Contato -->
        <div id="modalContato" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:1000;padding:20px;overflow-y:auto;">
            <div class="panel" style="max-width:600px;margin:50px auto;">
                <div class="panel-title">â• Adicionar/Editar Contato</div>

                <input type="hidden" id="contatoEditId">

                <div class="form-row">
                    <div class="form-group">
                        <label>Nome Completo *</label>
                        <input type="text" id="contatoNome" placeholder="Nome do contato">
                    </div>
                    <div class="form-group">
                        <label>WhatsApp/Telefone *</label>
                        <input type="text" id="contatoWhatsapp" placeholder="(00) 00000-0000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Tipo de Contato *</label>
                        <select id="contatoTipo">
                            <option value="cartorio">ğŸ›ï¸ CartÃ³rio</option>
                            <option value="particular">ğŸ‘¤ Particular</option>
                            <option value="indefinido">â“ NÃ£o classificado</option>
                            <option value="motorista">ğŸšš Motorista/Frete</option>
                            <option value="fornecedor">ğŸ­ Fornecedor</option>
                            <option value="cliente">ğŸ‘¥ Cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cidade/UF</label>
                        <input type="text" id="contatoCidade" placeholder="Ex: SÃ£o Paulo/SP">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="contatoEmail" placeholder="email@exemplo.com">
                    </div>
                    <div class="form-group">
                        <label>Empresa</label>
                        <input type="text" id="contatoEmpresa" placeholder="Nome da empresa">
                    </div>
                </div>

                <div class="form-group">
                    <label>ObservaÃ§Ãµes</label>
                    <textarea id="contatoObs" rows="2" placeholder="Notas adicionais..."></textarea>
                </div>

                <div class="btn-group">
                    <button class="btn btn-success" onclick="salvarContato()">ğŸ’¾ Salvar</button>
                    <button class="btn btn-danger" onclick="fecharModalContato()">âŒ Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AGENTE IA COM CHAT -->
    <div id="agente" class="tab-content">
        <div class="panel">
            <div class="panel-title">ğŸ¤– Agente IA - ConfiguraÃ§Ã£o Multi-API</div>

            <div class="alert success">
                <strong>ğŸš€ IA Multi-Provedor Ativa!</strong><br>
                O agente usa mÃºltiplas APIs gratuitas para respostas mais inteligentes.<br>
                Quanto mais APIs configuradas, mais inteligente o agente fica!
            </div>

            <div class="stats-grid" style="margin-bottom:20px;">
                <div class="stat-card">
                    <div class="icon">ğŸ§ </div>
                    <div class="value" id="apisAtivas">0</div>
                    <div class="label">APIs Ativas</div>
                </div>
                <div class="stat-card">
                    <div class="icon">âš¡</div>
                    <div class="value" id="statusIA">Online</div>
                    <div class="label">Status</div>
                </div>
            </div>

            <!-- APIs Gratuitas -->
            <div class="panel-title" style="font-size:1em;margin-top:15px;">ğŸ†“ APIs Gratuitas (Recomendado)</div>

            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ¤— Hugging Face (Gratuito)</label>
                    <input type="text" id="apiHuggingface" placeholder="hf_xxxxxxxxxxxxx">
                    <small style="color:rgba(255,255,255,0.5);font-size:0.75em;">Obtenha em: huggingface.co/settings/tokens</small>
                </div>
                <div class="form-group">
                    <label>ğŸŒ Groq (Gratuito e RÃ¡pido)</label>
                    <input type="text" id="apiGroq" placeholder="gsk_xxxxxxxxxxxxx">
                    <small style="color:rgba(255,255,255,0.5);font-size:0.75em;">Obtenha em: console.groq.com/keys</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ”· Together AI (Gratuito)</label>
                    <input type="text" id="apiTogether" placeholder="xxxxxxxxxxxxx">
                    <small style="color:rgba(255,255,255,0.5);font-size:0.75em;">Obtenha em: api.together.xyz</small>
                </div>
                <div class="form-group">
                    <label>ğŸŸ  Cohere (Gratuito)</label>
                    <input type="text" id="apiCohere" placeholder="xxxxxxxxxxxxx">
                    <small style="color:rgba(255,255,255,0.5);font-size:0.75em;">Obtenha em: dashboard.cohere.com/api-keys</small>
                </div>
            </div>

            <!-- APIs Pagas -->
            <div class="panel-title" style="font-size:1em;margin-top:20px;">ğŸ’³ APIs Premium (Opcional)</div>

            <div class="form-row">
                <div class="form-group">
                    <label>ğŸŸ¢ OpenAI (ChatGPT)</label>
                    <input type="password" id="apiOpenai" placeholder="sk-xxxxxxxxxxxxx">
                </div>
                <div class="form-group">
                    <label>ğŸŸ£ Anthropic (Claude)</label>
                    <input type="password" id="apiAnthropic" placeholder="sk-ant-xxxxxxxxxxxxx">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ”µ Google AI (Gemini)</label>
                    <input type="password" id="apiGoogle" placeholder="AIzaSyxxxxxxxxxxxxx">
                    <small style="color:rgba(255,255,255,0.5);font-size:0.75em;">Gratuito! aistudio.google.com/apikey</small>
                </div>
                <div class="form-group">
                    <label>ğŸ¯ Provedor Preferencial</label>
                    <select id="iaProviderPreferido" onchange="atualizarModelosDisponiveis()">
                        <option value="auto">ğŸ¤– AutomÃ¡tico (Melhor disponÃ­vel)</option>
                        <option value="groq">ğŸŒ Groq (Mais rÃ¡pido)</option>
                        <option value="huggingface">ğŸ¤— Hugging Face</option>
                        <option value="together">ğŸ”· Together AI</option>
                        <option value="cohere">ğŸŸ  Cohere</option>
                        <option value="google">ğŸ”µ Google Gemini</option>
                        <option value="openai">ğŸŸ¢ OpenAI</option>
                        <option value="anthropic">ğŸŸ£ Anthropic</option>
                        <option value="local">ğŸ  Apenas Local</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ§  Modelo de IA</label>
                    <select id="iaModeloSelecionado">
                        <option value="auto">ğŸ¤– AutomÃ¡tico</option>
                        <optgroup label="ğŸŒ Groq (Gratuito e RÃ¡pido)">
                            <option value="groq-llama-3.3-70b">Llama 3.3 70B</option>
                            <option value="groq-llama-3.1-8b">Llama 3.1 8B</option>
                            <option value="groq-mixtral-8x7b">Mixtral 8x7B</option>
                        </optgroup>
                        <optgroup label="ğŸŸ¢ OpenAI (Pago)">
                            <option value="gpt-4o-mini">GPT-4o Mini</option>
                            <option value="gpt-4o">GPT-4o</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        </optgroup>
                        <optgroup label="ğŸŸ£ Anthropic (Pago)">
                            <option value="claude-3-haiku">Claude 3 Haiku</option>
                            <option value="claude-3-sonnet">Claude 3 Sonnet</option>
                            <option value="claude-3-opus">Claude 3 Opus</option>
                        </optgroup>
                        <optgroup label="ğŸ”µ Google (Gratuito)">
                            <option value="gemini-pro">Gemini Pro</option>
                            <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                        </optgroup>
                    </select>
                </div>
                <div class="form-group">
                    <label>ğŸŒ¡ï¸ Temperatura (Criatividade)</label>
                    <input type="range" id="iaTemperatura" min="0" max="100" value="70" oninput="document.getElementById('tempValue').textContent = this.value/100">
                    <small style="color:rgba(255,255,255,0.5);">Valor: <span id="tempValue">0.7</span> (0=preciso, 1=criativo)</small>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-success" onclick="salvarTodasAPIs()">ğŸ’¾ Salvar Todas APIs</button>
                <button class="btn btn-info" onclick="testarAPIs()">ğŸ§ª Testar ConexÃµes</button>
            </div>

            <div id="resultadoTesteAPIs" style="margin-top:15px;"></div>
        </div>

        <div class="panel" style="min-height:400px;display:flex;flex-direction:column;">
            <div class="panel-title">ğŸ’¬ Conversa com o Agente</div>

            <div id="chatContainer" style="flex:1;overflow-y:auto;max-height:400px;padding:15px;background:rgba(0,0,0,0.2);border-radius:10px;margin-bottom:15px;">
                <div class="chat-message agent">
                    <div class="chat-avatar">ğŸ¤–</div>
                    <div class="chat-bubble">OlÃ¡! Sou o Enside Agent. Posso ajudar vocÃª com informaÃ§Ãµes sobre fretes, clientes, fornecedores e muito mais. Como posso ajudar?</div>
                </div>
            </div>

            <div style="display:flex;gap:10px;">
                <input type="text" id="chatInput" placeholder="Digite sua pergunta..." style="flex:1;" onkeypress="if(event.key==='Enter')enviarMensagem()">
                <button class="btn btn-primary" onclick="enviarMensagem()">ğŸ“¤ Enviar</button>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ¯ Triagem Inteligente de Contatos</div>

            <div class="alert warning">
                <strong>ğŸ¤– IA Classifica Automaticamente:</strong><br>
                O agente analisa os contatos nÃ£o classificados e sugere se Ã© Frete, Cliente ou Fornecedor.
            </div>

            <div class="btn-group" style="margin-bottom:20px;">
                <button class="btn btn-warning" onclick="classificarContatosIA()">ğŸ§  Classificar Contatos com IA</button>
                <button class="btn btn-info" onclick="verNaoClassificados()">â“ Ver NÃ£o Classificados (<span id="qtdNaoClassificados">0</span>)</button>
            </div>

            <div id="triagemContatosGrid" class="triagem-grid"></div>
        </div>
    </div>

    <!-- ARQUIVOS ORGANIZADOS -->
    <div id="organizados" class="tab-content">
        <div class="panel">
            <div class="panel-title">ğŸ“ Arquivos Organizados por Categoria</div>
            <div class="alert success">
                <strong>ğŸ“‚ Pasta base:</strong> /Users/andersonenside/Enside_Organizado/
            </div>
            <div class="categorias-grid" id="categoriasGrid"></div>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ“‹ HistÃ³rico de OrganizaÃ§Ãµes</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Arquivo</th><th>Categoria</th><th>Data</th><th>Status</th></tr>
                    </thead>
                    <tbody id="historicoTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ENSINAR IA -->
    <div id="ensinar" class="tab-content">
        <div class="panel">
            <div class="panel-title">ğŸ“š Ensinar a IA - Adicionar Conhecimentos</div>

            <div class="alert info">
                <strong>ğŸ§  Como treinar a IA:</strong><br>
                Adicione conhecimentos manualmente ou importe arquivos (TXT, JSON, CSV).<br>
                Quanto mais conhecimentos, mais precisa a IA fica!
            </div>

            <div class="form-group">
                <label>TÃ­tulo do Conhecimento *</label>
                <input type="text" id="conhecimentoTitulo" placeholder="Ex: PreÃ§o do frete SP-PR">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="conhecimentoCategoria">
                        <option value="geral">ğŸ“‹ Geral</option>
                        <option value="logistica">ğŸšš LogÃ­stica</option>
                        <option value="precos">ğŸ’° PreÃ§os</option>
                        <option value="clientes">ğŸ‘¥ Clientes</option>
                        <option value="fornecedores">ğŸ­ Fornecedores</option>
                        <option value="produtos">ğŸªµ Produtos</option>
                        <option value="procedimentos">ğŸ“ Procedimentos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Fonte</label>
                    <input type="text" id="conhecimentoFonte" placeholder="Ex: Manual interno">
                </div>
            </div>

            <div class="form-group">
                <label>ConteÃºdo *</label>
                <textarea id="conhecimentoConteudo" rows="4" placeholder="Digite o conhecimento detalhado..."></textarea>
            </div>

            <div class="form-group">
                <label>Tags (separadas por vÃ­rgula)</label>
                <input type="text" id="conhecimentoTags" placeholder="Ex: frete, preÃ§o, sÃ£o paulo">
            </div>

            <div class="btn-group">
                <button class="btn btn-success" onclick="adicionarConhecimento()">âœ… Adicionar Conhecimento</button>
                <button class="btn btn-info" onclick="document.getElementById('importConhecimentos').click()">ğŸ“ Importar Arquivo</button>
                <input type="file" id="importConhecimentos" accept=".txt,.json,.csv" onchange="importarConhecimentos(event)">
            </div>

            <div id="alertaConhecimento"></div>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ§  Base de Conhecimentos (<span id="totalConhecimentos">0</span>)</div>
            <div id="conhecimentosContainer"></div>
        </div>
    </div>

    <!-- FRETES -->
    <div id="fretes" class="tab-content">
        <div class="panel">
            <div class="panel-title">ğŸ“Š Google Sheets - Database Completo</div>

            <div class="alert success">
                <strong>ğŸ“Š Planilha conectada:</strong> 1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y<br>
                <a href="https://docs.google.com/spreadsheets/d/1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y/edit" target="_blank" style="color:var(--success);">ğŸ”— Abrir no Google Sheets</a>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon">ğŸšš</div>
                    <div class="value" id="sheetsFretes">0</div>
                    <div class="label">Fretes</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸ‘¥</div>
                    <div class="value" id="sheetsClientes">0</div>
                    <div class="label">Clientes</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸ­</div>
                    <div class="value" id="sheetsFornecedores">0</div>
                    <div class="label">Fornecedores</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸšš</div>
                    <div class="value" id="sheetsMotoristas">0</div>
                    <div class="label">Motoristas</div>
                </div>
            </div>

            <div class="btn-group" style="margin-bottom:20px;">
                <button class="btn btn-success" onclick="sincronizarTudoSheets()">ğŸ”„ Sincronizar Tudo</button>
                <button class="btn btn-primary" onclick="enviarClientesSheets()">ğŸ‘¥ Enviar Clientes</button>
                <button class="btn btn-warning" onclick="enviarFornecedoresSheets()">ğŸ­ Enviar Fornecedores</button>
                <button class="btn btn-info" onclick="enviarMotoristasSheets()">ğŸšš Enviar Motoristas</button>
            </div>

            <div id="statusSheets" class="alert info" style="display:none;"></div>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸšš GestÃ£o de Fretes</div>

            <div class="btn-group" style="margin-bottom:20px;">
                <button class="btn btn-primary" onclick="novoFrete()">â• Novo Frete</button>
                <button class="btn btn-success" onclick="enviarFretesSheets()">ğŸ“¤ Enviar para Sheets</button>
                <button class="btn btn-info" onclick="exportarFretes()">ğŸ’¾ Exportar CSV</button>
            </div>
        </div>

        <div class="panel" id="formFrete" style="display:none;">
            <div class="panel-title">â• Novo Frete</div>

            <div class="form-row">
                <div class="form-group">
                    <label>Motorista *</label>
                    <input type="text" id="freteMotorista" placeholder="Nome do motorista">
                </div>
                <div class="form-group">
                    <label>WhatsApp *</label>
                    <input type="text" id="freteWhatsapp" placeholder="(00) 00000-0000">
                </div>
                <div class="form-group">
                    <label>Placa</label>
                    <input type="text" id="fretePlaca" placeholder="ABC-1234">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Origem *</label>
                    <input type="text" id="freteOrigem" placeholder="Cidade/UF">
                </div>
                <div class="form-group">
                    <label>Destino *</label>
                    <input type="text" id="freteDestino" placeholder="Cidade/UF">
                </div>
                <div class="form-group">
                    <label>Tipo Carga</label>
                    <select id="freteCarga">
                        <option value="madeira">ğŸªµ Madeira</option>
                        <option value="pinus">ğŸŒ² Pinus</option>
                        <option value="eucalipto">ğŸŒ³ Eucalipto</option>
                        <option value="mdf">ğŸ“¦ MDF/MDP</option>
                        <option value="compensado">ğŸ“‹ Compensado</option>
                        <option value="geral">ğŸ“¦ Carga Geral</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>Peso (ton)</label>
                    <input type="number" id="fretePeso" placeholder="30">
                </div>
                <div class="form-group">
                    <label>Valor (R$)</label>
                    <input type="number" id="freteValor" placeholder="5000">
                </div>
                <div class="form-group">
                    <label>Data Prevista</label>
                    <input type="date" id="freteData">
                </div>
            </div>

            <div class="form-group">
                <label>ObservaÃ§Ãµes</label>
                <textarea id="freteObs" rows="2" placeholder="ObservaÃ§Ãµes..."></textarea>
            </div>

            <div class="btn-group">
                <button class="btn btn-success" onclick="salvarFrete()">ğŸ’¾ Salvar Frete</button>
                <button class="btn btn-danger" onclick="cancelarFrete()">âŒ Cancelar</button>
            </div>

            <div id="alertaFrete"></div>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ“‹ Fretes Cadastrados (<span id="totalFretes">0</span>)</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Motorista</th><th>Rota</th><th>Carga</th><th>Valor</th><th>Status</th><th>AÃ§Ãµes</th></tr>
                    </thead>
                    <tbody id="fretesTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- WHATSAPP -->
    <div id="whatsapp" class="tab-content">
        <div class="panel">
            <div class="panel-title">ğŸ“± WhatsApp Web - Envio Direto</div>

            <div class="alert success">
                <strong>âœ… Pronto para usar!</strong><br>
                Clique nos botÃµes abaixo para enviar mensagens diretamente pelo WhatsApp Web.
            </div>

            <div class="panel-title" style="font-size:1em;margin-top:15px;">ğŸ“¤ Enviar Mensagem RÃ¡pida</div>

            <div class="form-row">
                <div class="form-group">
                    <label>NÃºmero WhatsApp</label>
                    <input type="text" id="waNumeroRapido" placeholder="5518999999999">
                </div>
                <div class="form-group">
                    <label>Ou selecione um contato</label>
                    <select id="waContatoSelect" onchange="selecionarContatoWA()">
                        <option value="">-- Selecionar contato --</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Mensagem</label>
                <textarea id="waMensagemRapida" rows="3" placeholder="Digite sua mensagem..."></textarea>
            </div>

            <div class="btn-group">
                <button class="btn btn-whatsapp" onclick="enviarWhatsAppWeb()">ğŸ“± Abrir WhatsApp Web</button>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ“± Listas de TransmissÃ£o WhatsApp</div>

            <div class="alert info">
                <strong>âš ï¸ Limite WhatsApp:</strong> MÃ¡ximo 256 contatos por lista
            </div>

            <div class="btn-group" style="margin-bottom:20px;">
                <button class="btn btn-whatsapp" onclick="criarLista()">â• Nova Lista</button>
                <button class="btn btn-info" onclick="exportarContatos()">ğŸ“¤ Exportar Contatos</button>
            </div>

            <div id="formLista" style="display:none;margin-bottom:20px;">
                <div class="form-row">
                    <div class="form-group">
                        <label>Nome da Lista *</label>
                        <input type="text" id="listaNome" placeholder="Ex: Motoristas SP">
                    </div>
                    <div class="form-group">
                        <label>Filtrar por Tipo</label>
                        <select id="listaFiltroTipo" onchange="previewLista()">
                            <option value="">Todos</option>
                            <option value="motoristas">ğŸšš Motoristas</option>
                            <option value="fornecedores">ğŸ“¦ Fornecedores</option>
                            <option value="clientes">ğŸ‘¥ Clientes</option>
                        </select>
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-whatsapp" onclick="salvarLista()">âœ… Criar Lista</button>
                    <button class="btn btn-danger" onclick="cancelarLista()">âŒ Cancelar</button>
                </div>
            </div>

            <div class="panel-title" style="font-size:1em;">ğŸ“‹ Minhas Listas (<span id="totalListas">0</span>)</div>
            <div id="listasContainer"></div>
        </div>

        <!-- EVOLUTION API -->
        <div class="panel">
            <div class="panel-title">ğŸš€ Evolution API - WhatsApp AutomÃ¡tico</div>
            
            <div class="alert info">
                <strong>ğŸ’¡ Evolution API:</strong> IntegraÃ§Ã£o avanÃ§ada para envio automÃ¡tico de mensagens WhatsApp via API.<br>
                <small>Permite enviar mensagens em massa, webhooks e automaÃ§Ãµes sem precisar abrir o WhatsApp Web.</small>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ğŸŒ URL da API</label>
                    <input type="text" id="evolutionApiUrl" placeholder="http://localhost:8080" value="http://localhost:8080">
                </div>
                <div class="form-group">
                    <label>ğŸ”‘ API Key</label>
                    <input type="password" id="evolutionApiKey" placeholder="Sua chave de API">
                </div>
                <div class="form-group">
                    <label>ğŸ“± Nome da InstÃ¢ncia</label>
                    <input type="text" id="evolutionInstanceName" placeholder="enside_whatsapp" value="enside_whatsapp">
                </div>
            </div>

            <div class="btn-group" style="margin-bottom:20px;">
                <button class="btn btn-success" onclick="salvarConfigEvolution()">ğŸ’¾ Salvar ConfiguraÃ§Ãµes</button>
                <button class="btn btn-info" onclick="testarConexaoEvolution()">ğŸ”Œ Testar ConexÃ£o</button>
                <button class="btn btn-whatsapp" onclick="criarInstanciaEvolution()">â• Criar InstÃ¢ncia</button>
                <button class="btn btn-primary" onclick="conectarWhatsAppEvolution()">ğŸ“± Conectar WhatsApp</button>
            </div>

            <div id="statusEvolution" class="alert" style="display:none;"></div>
            <div id="qrcodeEvolution" style="display:none;text-align:center;padding:20px;"></div>

            <div class="panel-title" style="font-size:1em;margin-top:20px;">ğŸ“¤ Enviar Mensagem via API</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>NÃºmero (com DDD)</label>
                    <input type="text" id="evolutionNumero" placeholder="5518999999999">
                </div>
                <div class="form-group">
                    <label>Ou selecione um contato</label>
                    <select id="evolutionContatoSelect" onchange="selecionarContatoEvolution()">
                        <option value="">-- Selecionar contato --</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Mensagem</label>
                <textarea id="evolutionMensagem" rows="3" placeholder="Digite sua mensagem..."></textarea>
            </div>

            <div class="btn-group">
                <button class="btn btn-whatsapp" onclick="enviarMensagemEvolution()">ğŸ“¨ Enviar via Evolution API</button>
                <button class="btn btn-info" onclick="enviarParaListaEvolution()">ğŸ“¤ Enviar para Lista</button>
            </div>

            <div class="panel-title" style="font-size:1em;margin-top:20px;">ğŸ“Š Status da InstÃ¢ncia</div>
            <div id="evolutionInstanceStatus" class="stats-grid">
                <div class="stat-card">
                    <div class="icon">ğŸ“±</div>
                    <div class="value" id="evolutionStatusConexao">Desconectado</div>
                    <div class="label">Status</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸ“¨</div>
                    <div class="value" id="evolutionMensagensEnviadas">0</div>
                    <div class="label">Mensagens Enviadas</div>
                </div>
                <div class="stat-card">
                    <div class="icon">âœ…</div>
                    <div class="value" id="evolutionUltimaAtualizacao">-</div>
                    <div class="label">Ãšltima AtualizaÃ§Ã£o</div>
                </div>
            </div>
            
            <!-- AGENTE IA AUTOMÃTICO -->
            <div class="panel-title" style="font-size:1em;margin-top:20px;">ğŸ¤– Agente IA AutomÃ¡tico</div>
            
            <div class="alert success">
                <strong>ğŸ§  Resposta AutomÃ¡tica com IA:</strong> Ative para que o agente responda automaticamente mensagens recebidas no WhatsApp.
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ¤– Ativar Agente AutomÃ¡tico</label>
                    <div style="display:flex;gap:15px;margin-top:5px;">
                        <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                            <input type="checkbox" id="agenteAutoAtivo" onchange="toggleAgenteAuto()"> Ativar Respostas AutomÃ¡ticas
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>â° Delay entre Respostas (segundos)</label>
                    <input type="number" id="agenteAutoDelay" value="3" min="1" max="30">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ¯ Provedor de IA para Respostas</label>
                    <select id="agenteAutoProvider">
                        <option value="auto">ğŸ¤– AutomÃ¡tico (Melhor disponÃ­vel)</option>
                        <option value="groq">ğŸŒ Groq - Llama 3.3 (Gratuito)</option>
                        <option value="google">ğŸ”µ Google Gemini (Gratuito)</option>
                        <option value="openai">ğŸŸ¢ OpenAI - GPT-4o Mini</option>
                        <option value="anthropic">ğŸŸ£ Claude 3 Haiku</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ğŸ“ Modo de Resposta</label>
                    <select id="agenteAutoModo">
                        <option value="completo">ğŸ’¬ Resposta Completa (IA responde tudo)</option>
                        <option value="triagem">ğŸ“Š Triagem (IA classifica e encaminha)</option>
                        <option value="horario">â° Fora do HorÃ¡rio (SÃ³ responde fora do expediente)</option>
                        <option value="keywords">ğŸ”‘ Por Palavras-chave</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>ğŸ“ Mensagem de Boas-vindas (opcional)</label>
                <textarea id="agenteAutoBoasVindas" rows="2" placeholder="OlÃ¡! Sou o assistente virtual da Enside Madeiras. Como posso ajudar?"></textarea>
            </div>
            
            <div class="form-group">
                <label>ğŸš« Palavras para Ignorar (separadas por vÃ­rgula)</label>
                <input type="text" id="agenteAutoIgnorar" placeholder="spam, propaganda, oferta">
            </div>
            
            <div class="btn-group">
                <button class="btn btn-success" onclick="salvarConfigAgenteAuto()">ğŸ’¾ Salvar Config. Agente</button>
                <button class="btn btn-info" onclick="testarAgenteAuto()">ğŸ§ª Testar Resposta</button>
                <button class="btn btn-warning" onclick="verLogsAgente()">ğŸ“œ Ver Logs</button>
            </div>
            
            <div id="statusAgenteAuto" class="alert" style="display:none;margin-top:15px;"></div>
            
            <!-- LOGS DO AGENTE -->
            <div id="logsAgenteContainer" style="display:none;margin-top:15px;">
                <div class="panel-title" style="font-size:0.9em;">ğŸ“œ Logs de Respostas AutomÃ¡ticas</div>
                <div id="logsAgente" style="background:rgba(0,0,0,0.3);border-radius:10px;padding:15px;max-height:300px;overflow-y:auto;font-family:monospace;font-size:0.85em;">
                    <div style="color:rgba(255,255,255,0.5);">Nenhum log ainda...</div>
                </div>
            </div>
                </div>
            </div>
        </div>

        <!-- WEBHOOK WHATSAPP -->
        <div class="panel">
            <div class="panel-title">ğŸ”— Webhook WhatsApp - Receber Mensagens</div>
            
            <div class="alert info">
                <strong>ğŸ’¡ Webhook:</strong> Configure um endpoint para receber mensagens automÃ¡ticas do WhatsApp.<br>
                <small>Ideal para integraÃ§Ãµes com sistemas externos e automaÃ§Ãµes.</small>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ğŸŒ URL do Webhook</label>
                    <input type="text" id="webhookUrl" placeholder="https://seu-servidor.com/webhook">
                </div>
                <div class="form-group">
                    <label>ğŸ”‘ Token de SeguranÃ§a</label>
                    <input type="text" id="webhookToken" placeholder="seu_token_secreto">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ“¥ Eventos para Receber</label>
                    <div style="display:flex;gap:15px;flex-wrap:wrap;margin-top:5px;">
                        <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                            <input type="checkbox" id="webhookMensagens" checked> ğŸ’¬ Mensagens
                        </label>
                        <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                            <input type="checkbox" id="webhookStatus"> âœ… Status de Entrega
                        </label>
                        <label style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                            <input type="checkbox" id="webhookConexao"> ğŸ”Œ ConexÃ£o
                        </label>
                    </div>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn btn-success" onclick="salvarWebhook()">ğŸ’¾ Salvar Webhook</button>
                <button class="btn btn-info" onclick="testarWebhook()">ğŸ§ª Testar ConexÃ£o</button>
            </div>

            <div id="statusWebhook" class="alert" style="display:none;margin-top:15px;"></div>
        </div>

        <!-- SIMULAÃ‡ÃƒO DE CONVERSAS -->
        <div class="panel">
            <div class="panel-title">ğŸ’¬ SimulaÃ§Ã£o de Conversas</div>
            
            <div class="alert info">
                <strong>ğŸ§ª Teste suas mensagens:</strong> Simule conversas antes de enviar para clientes reais.
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ‘¤ Nome do Contato Simulado</label>
                    <input type="text" id="simNomeContato" placeholder="JoÃ£o da Silva">
                </div>
                <div class="form-group">
                    <label>ğŸ“± NÃºmero Simulado</label>
                    <input type="text" id="simNumero" placeholder="5518999999999">
                </div>
            </div>

            <div class="form-group">
                <label>ğŸ“ Mensagem para Simular</label>
                <textarea id="simMensagem" rows="3" placeholder="Digite a mensagem que deseja simular..."></textarea>
            </div>

            <div class="btn-group">
                <button class="btn btn-primary" onclick="simularConversa()">ğŸ’¬ Simular Envio</button>
                <button class="btn btn-warning" onclick="simularResposta()">ğŸ¤– Simular Resposta IA</button>
                <button class="btn btn-danger" onclick="limparSimulacao()">ğŸ—‘ï¸ Limpar</button>
            </div>

            <div class="panel-title" style="font-size:1em;margin-top:20px;">ğŸ“± Preview da Conversa</div>
            <div id="simulacaoContainer" style="background:rgba(0,0,0,0.3);border-radius:10px;padding:15px;min-height:200px;max-height:400px;overflow-y:auto;">
                <div class="empty-state">
                    <div class="icon">ğŸ’¬</div>
                    <p>Simule uma conversa para visualizar aqui</p>
                </div>
            </div>
        </div>
    </div>

    <!-- BUSCA CPF/CNPJ -->
    <div id="busca" class="tab-content">
        <div class="panel">
            <div class="panel-title">ğŸ” Busca de Documentos por CPF/CNPJ</div>
            <div class="alert info">
                <strong>ğŸ“Œ Busca Inteligente:</strong> Digite um CPF ou CNPJ para encontrar todos os documentos relacionados no sistema.
            </div>
            <div class="form-row">
                <div class="form-group" style="flex:2;">
                    <label>CPF ou CNPJ</label>
                    <input type="text" id="buscaCpfCnpj" placeholder="Digite CPF (000.000.000-00) ou CNPJ (00.000.000/0000-00)" onkeypress="if(event.key==='Enter')buscarDocumentos()">
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="buscarDocumentos()" style="width:100%;">ğŸ” Buscar</button>
                </div>
            </div>
            <div class="btn-group" style="margin-bottom:20px;">
                <button class="btn btn-warning" onclick="document.getElementById('buscaCpfCnpj').value='295.565.128-10';buscarDocumentos()">CPF 295.565.128-10</button>
                <button class="btn btn-warning" onclick="document.getElementById('buscaCpfCnpj').value='03.084.448/0001-29';buscarDocumentos()">CNPJ 03.084.448/0001-29</button>
                <button class="btn btn-info" onclick="limparBusca()">ğŸ—‘ï¸ Limpar</button>
            </div>
            <div id="resultadoBusca">
                <div class="empty-state">
                    <div class="icon">ğŸ”</div>
                    <p>Digite um CPF ou CNPJ para buscar documentos</p>
                </div>
            </div>
        </div>
        <div class="panel">
            <div class="panel-title">ğŸ“‚ Documentos Organizados por CPF/CNPJ</div>
            <div class="stats-grid">
                <div class="stat-card" onclick="abrirPasta('POR_CPF')">
                    <div class="icon">ğŸ‘¤</div>
                    <div class="value" id="totalCpfs">0</div>
                    <div class="label">Por CPF</div>
                </div>
                <div class="stat-card" onclick="abrirPasta('POR_CNPJ')">
                    <div class="icon">ğŸ¢</div>
                    <div class="value" id="totalCnpjs">0</div>
                    <div class="label">Por CNPJ</div>
                </div>
                <div class="stat-card" onclick="abrirPasta('EXTRATOS_BANCARIOS')">
                    <div class="icon">ğŸ¦</div>
                    <div class="value" id="totalExtratos">0</div>
                    <div class="label">Extratos</div>
                </div>
                <div class="stat-card" onclick="abrirPasta('COMPROVANTES')">
                    <div class="icon">ğŸ§¾</div>
                    <div class="value" id="totalComprovantes">0</div>
                    <div class="label">Comprovantes</div>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="tab-content">
        <div class="panel">
            <div class="panel-title">ğŸ“Š Dashboard - VisÃ£o Geral do Sistema</div>
            <div class="stats-grid">
                <div class="stat-card" onclick="abrirAba('contatos')">
                    <div class="icon">ğŸ“‡</div>
                    <div class="value" id="dashContatos">0</div>
                    <div class="label">Contatos</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸšš</div>
                    <div class="value" id="dashMotoristas">0</div>
                    <div class="label">Motoristas</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸ­</div>
                    <div class="value" id="dashFornecedores">0</div>
                    <div class="label">Fornecedores</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸ‘¥</div>
                    <div class="value" id="dashClientes">0</div>
                    <div class="label">Clientes</div>
                </div>
                <div class="stat-card" onclick="abrirAba('fretes')">
                    <div class="icon">ğŸ“¦</div>
                    <div class="value" id="dashFretes">0</div>
                    <div class="label">Fretes</div>
                </div>
                <div class="stat-card" onclick="abrirAba('organizados')">
                    <div class="icon">ğŸ“</div>
                    <div class="value" id="dashArquivos">0</div>
                    <div class="label">Arquivos</div>
                </div>
                <div class="stat-card" onclick="abrirAba('ensinar')">
                    <div class="icon">ğŸ§ </div>
                    <div class="value" id="dashConhecimentos">0</div>
                    <div class="label">Conhecimentos</div>
                </div>
            </div>
        </div>
        <div class="panel">
            <div class="panel-title">âš¡ AÃ§Ãµes RÃ¡pidas</div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="novoContato()">â• Novo Contato</button>
                <button class="btn btn-success" onclick="novoFrete()">ğŸšš Novo Frete</button>
                <button class="btn btn-info" onclick="document.getElementById('fileInput').click()">ğŸ“¥ Importar Arquivos</button>
                <button class="btn btn-warning" onclick="exportarBackup()">ğŸ“¤ Backup Completo</button>
                <a href="https://docs.google.com/spreadsheets/d/1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y/edit" target="_blank" class="btn btn-success">ğŸ“Š Google Sheets</a>
                <a href="https://wa.me/5518996540492" target="_blank" class="btn btn-whatsapp">ğŸ“± WhatsApp</a>
            </div>
        </div>
        <div class="panel">
            <div class="panel-title">ğŸ“ˆ IntegraÃ§Ãµes Ativas</div>
            <div class="stats-grid">
                <div class="stat-card" style="cursor:pointer;" onclick="window.open('https://docs.google.com/spreadsheets/d/1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y/edit','_blank')">
                    <div class="icon">ğŸ“Š</div>
                    <div class="value" style="font-size:1em;color:var(--success);">Conectado</div>
                    <div class="label">Google Sheets</div>
                </div>
                <div class="stat-card" style="cursor:pointer;" onclick="window.open('https://wa.me/5518996540492','_blank')">
                    <div class="icon">ğŸ“±</div>
                    <div class="value" style="font-size:1em;color:var(--success);">Pronto</div>
                    <div class="label">WhatsApp</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸ¤–</div>
                    <div class="value" style="font-size:1em;color:var(--success);">7 APIs</div>
                    <div class="label">IA Multi-Provedor</div>
                </div>
                <div class="stat-card">
                    <div class="icon">ğŸ’¾</div>
                    <div class="value" style="font-size:1em;color:var(--success);">Ativo</div>
                    <div class="label">LocalStorage</div>
                </div>
            </div>
        </div>
        <div class="panel">
            <div class="panel-title">ğŸ“ Categorias de Arquivos (45 Categorias)</div>
            
            <!-- Por Tipo de Arquivo (11) -->
            <div style="margin-bottom:15px;color:var(--success);font-weight:600;">ğŸ“‚ Por Tipo de Arquivo</div>
            <div class="triagem-grid">
                <div class="triagem-card aprovado" onclick="filtrarCategoria('DOCUMENTOS')"><div class="file-icon">ğŸ“„</div><div class="file-name">Documentos</div><div class="file-info">PDF, DOC, DOCX, ODT, RTF, TXT, Pages</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('PLANILHAS')"><div class="file-icon">ğŸ“Š</div><div class="file-name">Planilhas</div><div class="file-info">XLS, XLSX, ODS, CSV, Numbers, XLSM</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('IMAGENS')"><div class="file-icon">ğŸ–¼ï¸</div><div class="file-name">Imagens</div><div class="file-info">JPG, PNG, GIF, BMP, WebP, SVG</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('VIDEOS')"><div class="file-icon">ğŸ¬</div><div class="file-name">VÃ­deos</div><div class="file-info">MP4, AVI, MOV, MKV, WMV, FLV, WebM</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('AUDIO')"><div class="file-icon">ğŸµ</div><div class="file-name">Ãudio</div><div class="file-info">MP3, WAV, M4A, FLAC, AAC, OGG</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('CODIGO')"><div class="file-icon">ğŸ’»</div><div class="file-name">CÃ³digo</div><div class="file-info">PY, JS, HTML, CSS, JSON, XML, SH</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('COMPACTADO')"><div class="file-icon">ğŸ“¦</div><div class="file-name">Compactado</div><div class="file-info">ZIP, RAR, 7Z, TAR, GZ</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('APRESENTACOES')"><div class="file-icon">ğŸ“½ï¸</div><div class="file-name">ApresentaÃ§Ãµes</div><div class="file-info">PPT, PPTX, KEY, ODP</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('EBOOKS')"><div class="file-icon">ğŸ“š</div><div class="file-name">E-books</div><div class="file-info">EPUB, MOBI, AZW, AZW3</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('BANCO_DADOS')"><div class="file-icon">ğŸ—„ï¸</div><div class="file-name">Banco de Dados</div><div class="file-info">DB, SQLite, MDB, ACCDB</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('BACKUP')"><div class="file-icon">ğŸ’¾</div><div class="file-name">Backup</div><div class="file-info">BAK, BACKUP, OLD</div></div>
            </div>
            
            <!-- Contatos e Pessoas (5) -->
            <div style="margin:20px 0 15px;color:var(--info);font-weight:600;">ğŸ‘¥ Contatos e Pessoas</div>
            <div class="triagem-grid">
                <div class="triagem-card aprovado" onclick="filtrarCategoria('CONTATOS')"><div class="file-icon">ğŸ“‡</div><div class="file-name">Contatos</div><div class="file-info">Lista de contatos</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('MOTORISTAS')"><div class="file-icon">ğŸšš</div><div class="file-name">Motoristas</div><div class="file-info">Freteiros, CaminhÃµes</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('FORNECEDORES')"><div class="file-icon">ğŸ­</div><div class="file-name">Fornecedores</div><div class="file-info">Serrarias, FÃ¡bricas</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('CLIENTES')"><div class="file-icon">ğŸ‘¥</div><div class="file-name">Clientes</div><div class="file-info">Compradores</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('FUNCIONARIOS')"><div class="file-icon">ğŸ‘·</div><div class="file-name">FuncionÃ¡rios</div><div class="file-info">Equipe, RH</div></div>
            </div>
            
            <!-- Financeiro (5) -->
            <div style="margin:20px 0 15px;color:var(--warning);font-weight:600;">ğŸ’° Financeiro</div>
            <div class="triagem-grid">
                <div class="triagem-card aprovado" onclick="filtrarCategoria('FINANCEIRO')"><div class="file-icon">ğŸ’°</div><div class="file-name">Financeiro</div><div class="file-info">Extratos, Pagamentos</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('NOTAS_FISCAIS')"><div class="file-icon">ğŸ§¾</div><div class="file-name">Notas Fiscais</div><div class="file-info">NF-e, NFS-e</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('BOLETOS')"><div class="file-icon">ğŸ«</div><div class="file-name">Boletos</div><div class="file-info">CobranÃ§as</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('RECIBOS')"><div class="file-icon">ğŸ§¾</div><div class="file-name">Recibos</div><div class="file-info">Comprovantes</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('ORCAMENTOS')"><div class="file-icon">ğŸ’µ</div><div class="file-name">OrÃ§amentos</div><div class="file-info">Propostas</div></div>
            </div>
            
            <!-- Documentos Legais (3) -->
            <div style="margin:20px 0 15px;color:#8b5cf6;font-weight:600;">âš–ï¸ Documentos Legais</div>
            <div class="triagem-grid">
                <div class="triagem-card aprovado" onclick="filtrarCategoria('CONTRATOS')"><div class="file-icon">ğŸ“</div><div class="file-name">Contratos</div><div class="file-info">Acordos, Termos</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('JURIDICO')"><div class="file-icon">âš–ï¸</div><div class="file-name">JurÃ­dico</div><div class="file-info">Processos, Documentos</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('CERTIDOES')"><div class="file-icon">ğŸ“œ</div><div class="file-name">CertidÃµes</div><div class="file-info">CND, CertidÃµes</div></div>
            </div>
            
            <!-- LogÃ­stica (4) -->
            <div style="margin:20px 0 15px;color:#ec4899;font-weight:600;">ğŸšš LogÃ­stica</div>
            <div class="triagem-grid">
                <div class="triagem-card aprovado" onclick="filtrarCategoria('LOGISTICA')"><div class="file-icon">ğŸ“¦</div><div class="file-name">LogÃ­stica</div><div class="file-info">Entregas, Transporte</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('FRETES')"><div class="file-icon">ğŸšš</div><div class="file-name">Fretes</div><div class="file-info">Cargas, Viagens</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('ROTAS')"><div class="file-icon">ğŸ—ºï¸</div><div class="file-name">Rotas</div><div class="file-info">Trajetos, ItinerÃ¡rios</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('VEICULOS')"><div class="file-icon">ğŸš—</div><div class="file-name">VeÃ­culos</div><div class="file-info">CRLV, Placas</div></div>
            </div>
            
            <!-- Produtos (3) -->
            <div style="margin:20px 0 15px;color:#059669;font-weight:600;">ğŸªµ Produtos</div>
            <div class="triagem-grid">
                <div class="triagem-card aprovado" onclick="filtrarCategoria('MADEIRA')"><div class="file-icon">ğŸªµ</div><div class="file-name">Madeira</div><div class="file-info">Pinus, Eucalipto, MDF</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('PRODUTOS')"><div class="file-icon">ğŸ“¦</div><div class="file-name">Produtos</div><div class="file-info">CatÃ¡logo, Itens</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('ESTOQUE')"><div class="file-icon">ğŸ“‹</div><div class="file-name">Estoque</div><div class="file-info">InventÃ¡rio</div></div>
            </div>
            
            <!-- Pessoal/RH (2) -->
            <div style="margin:20px 0 15px;color:#f59e0b;font-weight:600;">ğŸ‘¤ Pessoal/RH</div>
            <div class="triagem-grid">
                <div class="triagem-card aprovado" onclick="filtrarCategoria('DOCUMENTOS_PESSOAIS')"><div class="file-icon">ğŸ†”</div><div class="file-name">Docs Pessoais</div><div class="file-info">RG, CPF, CNH</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('CURRICULOS')"><div class="file-icon">ğŸ“</div><div class="file-name">CurrÃ­culos</div><div class="file-info">CV, Resume</div></div>
            </div>
            
            <!-- Marketing (3) -->
            <div style="margin:20px 0 15px;color:#ef4444;font-weight:600;">ğŸ“£ Marketing</div>
            <div class="triagem-grid">
                <div class="triagem-card aprovado" onclick="filtrarCategoria('MARKETING')"><div class="file-icon">ğŸ“£</div><div class="file-name">Marketing</div><div class="file-info">Campanhas, AnÃºncios</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('LOGOS')"><div class="file-icon">ğŸ¨</div><div class="file-name">Logos</div><div class="file-info">Marcas, Logotipos</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('TEMPLATES')"><div class="file-icon">ğŸ“‹</div><div class="file-name">Templates</div><div class="file-info">Modelos, Layouts</div></div>
            </div>
            
            <!-- Projetos (2) -->
            <div style="margin:20px 0 15px;color:#3b82f6;font-weight:600;">ğŸ“ Projetos</div>
            <div class="triagem-grid">
                <div class="triagem-card aprovado" onclick="filtrarCategoria('PROJETOS')"><div class="file-icon">ğŸ“</div><div class="file-name">Projetos</div><div class="file-info">Planos, Planejamento</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('RELATORIOS')"><div class="file-icon">ğŸ“Š</div><div class="file-name">RelatÃ³rios</div><div class="file-info">AnÃ¡lises, Reports</div></div>
            </div>
            
            <!-- ComunicaÃ§Ã£o (4) -->
            <div style="margin:20px 0 15px;color:#25D366;font-weight:600;">ğŸ’¬ ComunicaÃ§Ã£o</div>
            <div class="triagem-grid">
                <div class="triagem-card aprovado" onclick="filtrarCategoria('EMAILS')"><div class="file-icon">ğŸ“§</div><div class="file-name">E-mails</div><div class="file-info">CorrespondÃªncia</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('WHATSAPP')"><div class="file-icon">ğŸ“±</div><div class="file-name">WhatsApp</div><div class="file-info">Conversas, MÃ­dia</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('SCREENSHOTS')"><div class="file-icon">ğŸ“¸</div><div class="file-name">Screenshots</div><div class="file-info">Capturas de Tela</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('GRAVACOES')"><div class="file-icon">ğŸ¤</div><div class="file-name">GravaÃ§Ãµes</div><div class="file-info">Ãudio, VÃ­deo</div></div>
            </div>
            
            <!-- Sistema (2) -->
            <div style="margin:20px 0 15px;color:#64748b;font-weight:600;">âš™ï¸ Sistema</div>
            <div class="triagem-grid">
                <div class="triagem-card aprovado" onclick="filtrarCategoria('CONFIGURACOES')"><div class="file-icon">âš™ï¸</div><div class="file-name">ConfiguraÃ§Ãµes</div><div class="file-info">Settings, Config</div></div>
                <div class="triagem-card aprovado" onclick="filtrarCategoria('LOGS')"><div class="file-icon">ğŸ“</div><div class="file-name">Logs</div><div class="file-info">Registros, HistÃ³rico</div></div>
            </div>
            
            <!-- Fallback (1) -->
            <div style="margin:20px 0 15px;color:#94a3b8;font-weight:600;">ğŸ“‚ Outros</div>
            <div class="triagem-grid">
                <div class="triagem-card" onclick="filtrarCategoria('OUTROS')"><div class="file-icon">ğŸ“‚</div><div class="file-name">Outros</div><div class="file-info">NÃ£o classificados</div></div>
            </div>
        </div>
    </div>

    <!-- CONFIGURAÃ‡Ã•ES -->
    <div id="config" class="tab-content">
        <!-- SISTEMA DE TEMAS -->
        <div class="panel">
            <div class="panel-title">ğŸ¨ PersonalizaÃ§Ã£o Visual</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ¨ Tema de Cores</label>
                    <div class="theme-selector" id="themeSelector">
                        <button class="theme-btn active" data-theme="green" onclick="setTheme('green')" style="background: linear-gradient(135deg, #4ade80, #22c55e);" title="Verde">âœ”</button>
                        <button class="theme-btn" data-theme="purple" onclick="setTheme('purple')" style="background: linear-gradient(135deg, #c084fc, #8b5cf6);" title="Roxo"></button>
                        <button class="theme-btn" data-theme="blue" onclick="setTheme('blue')" style="background: linear-gradient(135deg, #93c5fd, #3b82f6);" title="Azul"></button>
                        <button class="theme-btn" data-theme="red" onclick="setTheme('red')" style="background: linear-gradient(135deg, #fca5a5, #ef4444);" title="Vermelho"></button>
                        <button class="theme-btn" data-theme="orange" onclick="setTheme('orange')" style="background: linear-gradient(135deg, #fdba74, #f97316);" title="Laranja"></button>
                        <button class="theme-btn" data-theme="pink" onclick="setTheme('pink')" style="background: linear-gradient(135deg, #f9a8d4, #ec4899);" title="Rosa"></button>
                    </div>
                </div>
                <div class="form-group">
                    <label>ğŸŒ™ Modo de ExibiÃ§Ã£o</label>
                    <div class="mode-toggle">
                        <button class="mode-btn active" data-mode="dark" onclick="setMode('dark')">ğŸŒ™ Escuro</button>
                        <button class="mode-btn" data-mode="light" onclick="setMode('light')">â˜€ï¸ Claro</button>
                    </div>
                </div>
            </div>
            
            <div class="alert info">
                <strong>ğŸ’¡ Dica:</strong> Suas preferÃªncias de tema sÃ£o salvas automaticamente e serÃ£o lembradas na prÃ³xima vez que vocÃª abrir o sistema.
            </div>
        </div>
        
        <div class="panel">
            <div class="panel-title">âš™ï¸ ConfiguraÃ§Ãµes do Sistema</div>

            <div class="form-row">
                <div class="form-group">
                    <label>ğŸ“‚ Pasta de Destino</label>
                    <input type="text" id="configPastaDestino" value="/Users/andersonenside/Enside_Organizado" disabled>
                </div>
                <div class="form-group">
                    <label>ğŸ“Š ID Google Sheets</label>
                    <input type="text" id="configSheetId" value="1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y">
                </div>
            </div>

            <div class="form-group">
                <label>ğŸ”— URL Web App (Google Apps Script)</label>
                <input type="text" id="configWebApp" placeholder="https://script.google.com/macros/s/.../exec">
            </div>

            <div class="form-group">
                <label>ğŸ“± WhatsApp Principal</label>
                <input type="text" id="configWhatsapp" value="5518996540492">
            </div>

            <button class="btn btn-success" onclick="salvarConfig()">ğŸ’¾ Salvar ConfiguraÃ§Ãµes</button>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ¨ Categorias de Arquivos</div>
            <div class="categorias-grid" id="configCategorias"></div>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ’¾ Backup & RestauraÃ§Ã£o</div>
            <div class="btn-group">
                <button class="btn btn-info" onclick="exportarBackup()">ğŸ“¤ Exportar Backup</button>
                <button class="btn btn-warning" onclick="document.getElementById('importBackup').click()">ğŸ“¥ Importar Backup</button>
                <button class="btn btn-danger" onclick="limparDados()">ğŸ—‘ï¸ Limpar Dados</button>
            </div>
            <input type="file" id="importBackup" accept=".json" onchange="importarBackup(event)">
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENSIDE SYSTEM v10.0 - Sistema Completo + IA + WhatsApp
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

console.log('ğŸ¤– ENSIDE SYSTEM v10.0 iniciando...');

const CONFIG = {
    pastaDestino: '/Users/andersonenside',
    sheetId: '1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y',
    webApp: '',
    whatsapp: '5518996540492',
    // Evolution API - ConfiguraÃ§Ãµes
    evolutionApi: {
        baseUrl: 'http://localhost:8080',
        apiKey: '',
        instanceName: 'enside_whatsapp',
        enabled: false
    }
};

const CATEGORIAS = {
    // === ARQUIVOS POR TIPO ===
    'DOCUMENTOS': { icon: 'ğŸ“„', extensoes: ['.pdf', '.doc', '.docx', '.odt', '.rtf', '.txt', '.pages'], cor: '#3b82f6' },
    'PLANILHAS': { icon: 'ğŸ“Š', extensoes: ['.xls', '.xlsx', '.ods', '.csv', '.numbers', '.xlsm'], cor: '#10b981' },
    'IMAGENS': { icon: 'ğŸ–¼ï¸', extensoes: ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg', '.heic', '.heif', '.tiff', '.raw', '.ico', '.jp2'], cor: '#ec4899' },
    'VIDEOS': { icon: 'ğŸ¬', extensoes: ['.mp4', '.avi', '.mov', '.mkv', '.wmv', '.flv', '.webm', '.m4v', '.3gp'], cor: '#ef4444' },
    'AUDIO': { icon: 'ğŸµ', extensoes: ['.mp3', '.wav', '.m4a', '.flac', '.aac', '.ogg', '.wma', '.aiff'], cor: '#f59e0b' },
    'CODIGO': { icon: 'ğŸ’»', extensoes: ['.py', '.js', '.html', '.css', '.json', '.xml', '.sh', '.java', '.php', '.ts', '.jsx', '.tsx', '.vue', '.swift', '.kt', '.rb', '.go', '.rs', '.c', '.cpp', '.h', '.sql', '.md', '.yaml', '.yml'], cor: '#8b5cf6' },
    'COMPACTADO': { icon: 'ğŸ“¦', extensoes: ['.zip', '.rar', '.7z', '.tar', '.gz', '.bz2', '.xz', '.tgz'], cor: '#6366f1' },
    'EXECUTAVEIS': { icon: 'âš™ï¸', extensoes: ['.exe', '.app', '.dmg', '.msi', '.deb', '.rpm', '.pkg', '.command', '.bat'], cor: '#64748b' },
    'APRESENTACOES': { icon: 'ğŸ“½ï¸', extensoes: ['.ppt', '.pptx', '.key', '.odp'], cor: '#f97316' },
    'EBOOKS': { icon: 'ğŸ“š', extensoes: ['.epub', '.mobi', '.azw', '.azw3'], cor: '#84cc16' },
    'FONTES': { icon: 'ğŸ”¤', extensoes: ['.ttf', '.otf', '.woff', '.woff2', '.eot'], cor: '#a855f7' },
    'BANCO_DADOS': { icon: 'ğŸ—„ï¸', extensoes: ['.db', '.sqlite', '.sqlite3', '.mdb', '.accdb'], cor: '#0ea5e9' },
    'BACKUP': { icon: 'ğŸ’¾', extensoes: ['.bak', '.backup', '.old'], cor: '#f59e0b' },

    // === CONTATOS E PESSOAS ===
    'CONTATOS': { icon: 'ğŸ“‡', extensoes: ['.vcf', '.vcard'], cor: '#22c55e', palavras: ['contato', 'contatos', 'contact', 'contacts', 'telefone', 'celular', 'whatsapp'] },
    'MOTORISTAS': { icon: 'ğŸš›', extensoes: [], cor: '#0ea5e9', palavras: ['motorista', 'motoristas', 'freteiro', 'freteiros', 'caminhoneiro', 'driver', 'condutor'] },
    'FORNECEDORES': { icon: 'ğŸ­', extensoes: [], cor: '#f59e0b', palavras: ['fornecedor', 'fornecedores', 'supplier', 'suppliers', 'serraria', 'madeireira', 'fabrica'] },
    'CLIENTES': { icon: 'ğŸ‘¥', extensoes: [], cor: '#10b981', palavras: ['cliente', 'clientes', 'customer', 'comprador', 'consumidor'] },
    'FUNCIONARIOS': { icon: 'ğŸ‘·', extensoes: [], cor: '#6366f1', palavras: ['funcionario', 'funcionarios', 'empregado', 'colaborador', 'equipe', 'staff'] },

    // === FINANCEIRO ===
    'FINANCEIRO': { icon: 'ğŸ’°', extensoes: [], cor: '#eab308', palavras: ['financeiro', 'finance', 'pagamento', 'recebimento', 'banco', 'bancario', 'extrato', 'saldo'] },
    'NOTAS_FISCAIS': { icon: 'ğŸ§¾', extensoes: [], cor: '#84cc16', palavras: ['nf', 'nfe', 'nota fiscal', 'notafiscal', 'danfe', 'xml nfe', 'cupom fiscal'] },
    'BOLETOS': { icon: 'ğŸ«', extensoes: [], cor: '#f97316', palavras: ['boleto', 'boletos', 'cobranca', 'fatura', 'duplicata'] },
    'RECIBOS': { icon: 'ğŸ§¾', extensoes: [], cor: '#14b8a6', palavras: ['recibo', 'recibos', 'comprovante', 'receipt'] },
    'ORCAMENTOS': { icon: 'ğŸ“‹', extensoes: [], cor: '#0891b2', palavras: ['orcamento', 'orcamentos', 'proposta', 'cotacao', 'budget', 'quote'] },

    // === DOCUMENTOS LEGAIS ===
    'CONTRATOS': { icon: 'ğŸ“', extensoes: [], cor: '#7c3aed', palavras: ['contrato', 'contratos', 'contract', 'acordo', 'termo'] },
    'JURIDICO': { icon: 'âš–ï¸', extensoes: [], cor: '#6b7280', palavras: ['juridico', 'legal', 'processo', 'acao', 'tribunal', 'advogado', 'peticao'] },
    'PROCURACOES': { icon: 'ğŸ“œ', extensoes: [], cor: '#a3a3a3', palavras: ['procuracao', 'procuracoes', 'poder', 'representacao'] },
    'CERTIDOES': { icon: 'ğŸ›ï¸', extensoes: [], cor: '#78716c', palavras: ['certidao', 'certidoes', 'cnd', 'fgts', 'inss', 'receita'] },

    // === LOGISTICA E TRANSPORTE ===
    'LOGISTICA': { icon: 'ğŸšš', extensoes: [], cor: '#06b6d4', palavras: ['logistica', 'transporte', 'entrega', 'envio', 'shipping', 'delivery'] },
    'FRETES': { icon: 'ğŸ“¦', extensoes: [], cor: '#0284c7', palavras: ['frete', 'fretes', 'freight', 'carga', 'carregamento', 'embarque'] },
    'ROTAS': { icon: 'ğŸ—ºï¸', extensoes: [], cor: '#0d9488', palavras: ['rota', 'rotas', 'trajeto', 'itinerario', 'percurso', 'destino'] },
    'VEICULOS': { icon: 'ğŸš—', extensoes: [], cor: '#475569', palavras: ['veiculo', 'veiculos', 'carro', 'caminhao', 'placa', 'crlv', 'renavam'] },

    // === PRODUTOS E ESTOQUE ===
    'MADEIRA': { icon: 'ğŸªµ', extensoes: [], cor: '#92400e', palavras: ['madeira', 'pinus', 'eucalipto', 'mdf', 'mdp', 'compensado', 'tabuado', 'prancha', 'viga', 'caibro', 'ripa', 'sarrafo', 'wood', 'lumber'] },
    'PRODUTOS': { icon: 'ğŸ“¦', extensoes: [], cor: '#ca8a04', palavras: ['produto', 'produtos', 'item', 'mercadoria', 'material'] },
    'ESTOQUE': { icon: 'ğŸª', extensoes: [], cor: '#a16207', palavras: ['estoque', 'inventario', 'stock', 'armazem', 'deposito'] },

    // === PESSOAL E RH ===
    'DOCUMENTOS_PESSOAIS': { icon: 'ğŸªª', extensoes: [], cor: '#dc2626', palavras: ['rg', 'cpf', 'cnh', 'identidade', 'passaporte', 'titulo', 'reservista'] },
    'CURRICULOS': { icon: 'ğŸ“‹', extensoes: [], cor: '#4f46e5', palavras: ['curriculo', 'cv', 'resume', 'curriculum'] },
    'ATESTADOS': { icon: 'ğŸ¥', extensoes: [], cor: '#dc2626', palavras: ['atestado', 'medico', 'saude', 'afastamento', 'licenca'] },

    // === MARKETING E COMUNICACAO ===
    'MARKETING': { icon: 'ğŸ“¢', extensoes: [], cor: '#e11d48', palavras: ['marketing', 'propaganda', 'publicidade', 'anuncio', 'campanha', 'divulgacao'] },
    'LOGOS': { icon: 'ğŸ¨', extensoes: [], cor: '#be185d', palavras: ['logo', 'logotipo', 'marca', 'brand', 'identidade visual'] },
    'TEMPLATES': { icon: 'ğŸ“', extensoes: [], cor: '#9333ea', palavras: ['template', 'modelo', 'layout', 'design'] },

    // === PROJETOS ===
    'PROJETOS': { icon: 'ğŸ“‚', extensoes: [], cor: '#2563eb', palavras: ['projeto', 'project', 'plano', 'planejamento'] },
    'RELATORIOS': { icon: 'ğŸ“Š', extensoes: [], cor: '#1d4ed8', palavras: ['relatorio', 'report', 'analise', 'estatistica', 'dashboard'] },

    // === COMUNICACAO ===
    'EMAILS': { icon: 'ğŸ“§', extensoes: ['.eml', '.msg'], cor: '#0369a1', palavras: ['email', 'e-mail', 'mensagem', 'correspondencia'] },
    'WHATSAPP': { icon: 'ğŸ“±', extensoes: [], cor: '#25d366', palavras: ['whatsapp', 'zap', 'wpp', 'wa', 'chat'] },
    'SCREENSHOTS': { icon: 'ğŸ“¸', extensoes: [], cor: '#7c3aed', palavras: ['screenshot', 'captura', 'print', 'tela'] },
    'GRAVACOES': { icon: 'ğŸ™ï¸', extensoes: [], cor: '#dc2626', palavras: ['gravacao', 'recording', 'audio', 'voice', 'ligacao', 'chamada'] },

    // === SISTEMA ===
    'CONFIGURACOES': { icon: 'âš™ï¸', extensoes: ['.ini', '.conf', '.config', '.env', '.plist'], cor: '#64748b', palavras: ['config', 'configuracao', 'settings', 'preferencias'] },
    'LOGS': { icon: 'ğŸ“‹', extensoes: ['.log'], cor: '#475569', palavras: ['log', 'erro', 'debug'] },
    'CACHE': { icon: 'ğŸ—ƒï¸', extensoes: ['.cache', '.tmp', '.temp'], cor: '#94a3b8', palavras: ['cache', 'temporario', 'temp'] },

    // === FALLBACK ===
    'OUTROS': { icon: 'ğŸ“', extensoes: [], cor: '#6b7280', palavras: [] },

    // === NOVAS CATEGORIAS MAC - IMPORTADOR UNIVERSAL INTELIGENTE ===
    // Dados e Planilhas AvanÃ§ados
    'DADOS_FINANCEIROS': { icon: 'ğŸ’¹', extensoes: ['.ofx', '.qfx', '.qif'], cor: '#059669', palavras: ['extrato', 'transacao', 'bancario', 'financeiro'] },
    'DADOS_CONTABEIS': { icon: 'ğŸ“’', extensoes: [], cor: '#047857', palavras: ['contabil', 'balanco', 'dre', 'razao', 'diario'] },
    'DADOS_FISCAIS': { icon: 'ğŸ›ï¸', extensoes: ['.sped', '.efd'], cor: '#065f46', palavras: ['sped', 'efd', 'ecf', 'ecd', 'fiscal'] },
    
    // Documentos EspecÃ­ficos Mac
    'DOCUMENTOS_APPLE': { icon: 'ğŸ', extensoes: ['.pages', '.numbers', '.key'], cor: '#a855f7', palavras: ['pages', 'numbers', 'keynote'] },
    'NOTAS_APPLE': { icon: 'ğŸ“', extensoes: [], cor: '#c084fc', palavras: ['nota', 'notes', 'lembrete'] },
    
    // MÃ­dia AvanÃ§ada
    'FOTOS_RAW': { icon: 'ğŸ“·', extensoes: ['.raw', '.cr2', '.nef', '.arw', '.dng', '.orf'], cor: '#be185d', palavras: ['raw', 'camera', 'foto profissional'] },
    'VIDEOS_PROFISSIONAIS': { icon: 'ğŸ¥', extensoes: ['.prproj', '.fcpx', '.aep', '.drp'], cor: '#dc2626', palavras: ['premiere', 'final cut', 'after effects', 'davinci'] },
    'AUDIO_PROFISSIONAL': { icon: 'ğŸ§', extensoes: ['.logic', '.band', '.ptx', '.sesx'], cor: '#ea580c', palavras: ['logic', 'garageband', 'pro tools', 'audition'] },
    
    // Desenvolvimento Mac
    'XCODE_PROJETOS': { icon: 'ğŸ”¨', extensoes: ['.xcodeproj', '.xcworkspace', '.playground'], cor: '#2563eb', palavras: ['xcode', 'swift', 'ios', 'macos'] },
    'SCRIPTS_MAC': { icon: 'ğŸ“œ', extensoes: ['.scpt', '.applescript', '.workflow', '.shortcut'], cor: '#3b82f6', palavras: ['automator', 'applescript', 'shortcut'] },
    
    // ENSIDE Madeiras EspecÃ­fico
    'MADEIRA_EUCALIPTO': { icon: 'ğŸŒ²', extensoes: [], cor: '#166534', palavras: ['eucalipto', 'eucalyptus', 'tora eucalipto'] },
    'MADEIRA_PINUS': { icon: 'ğŸŒ²', extensoes: [], cor: '#15803d', palavras: ['pinus', 'pinho', 'tora pinus'] },
    'MADEIRA_TRATADA': { icon: 'ğŸ§ª', extensoes: [], cor: '#14532d', palavras: ['tratada', 'cca', 'autoclave', 'tratamento'] },
    'MADEIRA_SERRADA': { icon: 'ğŸªš', extensoes: [], cor: '#22c55e', palavras: ['serrada', 'tabua', 'prancha', 'viga', 'caibro'] },
    'MADEIRA_BRUTA': { icon: 'ğŸªµ', extensoes: [], cor: '#4ade80', palavras: ['bruta', 'tora', 'tronco', 'lenha'] },
    'CUSTOS_PRODUCAO': { icon: 'ğŸ’µ', extensoes: [], cor: '#84cc16', palavras: ['custo', 'producao', 'serragem', 'beneficiamento'] },
    'TABELAS_PRECOS': { icon: 'ğŸ’²', extensoes: [], cor: '#a3e635', palavras: ['preco', 'tabela', 'valor', 'cotacao madeira'] },
    'MEDICOES_MADEIRA': { icon: 'ğŸ“', extensoes: [], cor: '#bef264', palavras: ['medicao', 'cubagem', 'volume', 'm3', 'metro cubico'] },
    'ROMANEIOS': { icon: 'ğŸ“‹', extensoes: [], cor: '#d9f99d', palavras: ['romaneio', 'carga', 'descarga', 'manifesto'] },
    'CERTIFICADOS_MADEIRA': { icon: 'ğŸ…', extensoes: [], cor: '#ecfccb', palavras: ['certificado', 'dof', 'ibama', 'origem florestal'] },
    
    // Redes Sociais e ComunicaÃ§Ã£o
    'INSTAGRAM': { icon: 'ğŸ“¸', extensoes: [], cor: '#e11d48', palavras: ['instagram', 'insta', 'reels', 'stories'] },
    'FACEBOOK': { icon: 'ğŸ‘¤', extensoes: [], cor: '#1d4ed8', palavras: ['facebook', 'fb', 'meta'] },
    'LINKEDIN': { icon: 'ğŸ’¼', extensoes: [], cor: '#0284c7', palavras: ['linkedin', 'profissional', 'networking'] },
    'TIKTOK': { icon: 'ğŸµ', extensoes: [], cor: '#000000', palavras: ['tiktok', 'tt', 'viral'] },
    
    // Design e Criativo
    'PHOTOSHOP': { icon: 'ğŸ¨', extensoes: ['.psd', '.psb'], cor: '#0ea5e9', palavras: ['photoshop', 'psd'] },
    'ILLUSTRATOR': { icon: 'âœï¸', extensoes: ['.ai'], cor: '#f97316', palavras: ['illustrator', 'vetor'] },
    'FIGMA': { icon: 'ğŸ¯', extensoes: ['.fig'], cor: '#a855f7', palavras: ['figma', 'ui', 'ux', 'prototipo'] },
    'CANVA': { icon: 'ğŸ–¼ï¸', extensoes: [], cor: '#06b6d4', palavras: ['canva', 'design social'] },
    
    // Sistema Mac
    'PREFERENCIAS_MAC': { icon: 'âš™ï¸', extensoes: ['.plist', '.prefPane'], cor: '#64748b', palavras: ['preferencia', 'sistema', 'config mac'] },
    'BIBLIOTECA_MAC': { icon: 'ğŸ“š', extensoes: [], cor: '#475569', palavras: ['library', 'biblioteca', 'application support'] },
    'ICLOUD': { icon: 'â˜ï¸', extensoes: [], cor: '#0ea5e9', palavras: ['icloud', 'cloud', 'nuvem apple'] }
};

let db = {
    pendentes: [],
    historico: [],
    fretes: [],
    listas: [],
    conhecimentos: [],
    contatosUnificados: [], // Nova lista unificada de contatos
    contatos: { motoristas: [], fornecedores: [], clientes: [] },
    agent: { nivel: 1, xp: 0, precisao: 85, interacoes: 0 },
    iaConfig: {
        providerPreferido: 'auto',
        apis: {
            huggingface: '',
            groq: '',
            together: '',
            cohere: '',
            openai: '',
            anthropic: '',
            google: ''
        }
    },
    chatHistory: []
};

async function carregarDados() {
    try {
        // Primeiro tenta IndexedDB
        await initIndexedDB();
        await carregarDadosIndexedDB();
        
        // Se nÃ£o tem dados no IndexedDB, tenta localStorage
        if (!db.contatosUnificados || db.contatosUnificados.length === 0) {
            const saved = localStorage.getItem('enside_system_v10');
            if (saved) {
                const parsed = JSON.parse(saved);
                db = { ...db, ...parsed };
                // Migra para IndexedDB
                salvarDados();
                console.log('Dados migrados para IndexedDB');
            }
        }
        
        // Carrega dados antigos se existirem
        const oldDB = localStorage.getItem('enside_funcional_v8');
        if (oldDB) {
            const old = JSON.parse(oldDB);
            if (old.fretes && !db.fretes.length) db.fretes = old.fretes;
            if (old.listas && !db.listas.length) db.listas = old.listas;
        }
        
        console.log('Contatos carregados:', db.contatosUnificados ? db.contatosUnificados.length : 0);
    } catch(e) { console.error('Erro ao carregar:', e); }
}

// IndexedDB para armazenamento ilimitado
let indexedDB_db = null;
const DB_NAME = 'ENSIDE_DB';
const DB_VERSION = 1;

function initIndexedDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onerror = () => reject(request.error);
        request.onsuccess = () => { indexedDB_db = request.result; resolve(); };
        request.onupgradeneeded = (e) => {
            const idb = e.target.result;
            if (!idb.objectStoreNames.contains('dados')) {
                idb.createObjectStore('dados', { keyPath: 'id' });
            }
        };
    });
}

function salvarDados() {
    // Salvar no IndexedDB (principal)
    if (indexedDB_db) {
        const tx = indexedDB_db.transaction('dados', 'readwrite');
        const store = tx.objectStore('dados');
        store.put({ id: 'enside_data', ...db });
    }
    // Backup mÃ­nimo no localStorage (apenas configuraÃ§Ãµes)
    try {
        const backup = {
            configuracoes: db.configuracoes || {},
            estatisticas: db.estatisticas || {},
            totalContatos: db.contatosUnificados ? db.contatosUnificados.length : 0
        };
        localStorage.setItem('enside_backup', JSON.stringify(backup));
    } catch(e) { console.log('localStorage cheio, usando apenas IndexedDB'); }
    atualizarInterface();
}

async function carregarDadosIndexedDB() {
    if (!indexedDB_db) await initIndexedDB();
    return new Promise((resolve) => {
        const tx = indexedDB_db.transaction('dados', 'readonly');
        const store = tx.objectStore('dados');
        const request = store.get('enside_data');
        request.onsuccess = () => {
            if (request.result) {
                Object.assign(db, request.result);
                delete db.id;
            }
            resolve();
        };
        request.onerror = () => resolve();
    });
}

function abrirAba(id) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    const tabContent = document.getElementById(id);
    if (tabContent) tabContent.classList.add('active');
    // Encontra o botÃ£o correto pelo texto ou onclick
    document.querySelectorAll('.tab-btn').forEach(b => {
        if (b.getAttribute('onclick') && b.getAttribute('onclick').includes(`'${id}'`)) {
            b.classList.add('active');
        }
    });
}

function importarArquivos() { document.getElementById('fileInput').removeAttribute('webkitdirectory'); document.getElementById('fileInput').click(); }

async function importarPastas() {
    if ('showDirectoryPicker' in window) {
        try { const dir = await window.showDirectoryPicker(); await processarDiretorio(dir, ''); mostrarTriagem(); } catch(e) {}
    } else { document.getElementById('fileInput').setAttribute('webkitdirectory', 'true'); document.getElementById('fileInput').click(); }
}

async function processarDiretorio(dirHandle, caminhoPai) {
    for await (const [nome, handle] of dirHandle.entries()) {
        const caminho = caminhoPai ? `${caminhoPai}/${nome}` : nome;
        if (handle.kind === 'directory') await processarDiretorio(handle, caminho);
        else { const file = await handle.getFile(); adicionarParaTriagem(file, caminho); }
    }
}

function adicionarParaTriagem(file, caminho) {
    db.pendentes.push({ id: Date.now() + Math.random(), nome: file.name, caminho: caminho || file.name, tamanho: file.size, tipo: file.type, categoria: detectarCategoria(file.name, caminho), file: file, status: 'pendente' });
}

function detectarCategoria(nome, caminho = '') {
    const nomeCompleto = `${caminho}/${nome}`.toLowerCase();
    const nomeLower = nome.toLowerCase();
    const ext = nome.substring(nome.lastIndexOf('.')).toLowerCase();

    // 1. PRIMEIRO: Detectar por palavras-chave no nome/caminho (maior prioridade para contexto)
    for (const [cat, info] of Object.entries(CATEGORIAS)) {
        if (info.palavras && info.palavras.length > 0) {
            for (const palavra of info.palavras) {
                // Verifica no nome do arquivo E no caminho completo
                if (nomeCompleto.includes(palavra.toLowerCase())) {
                    return cat;
                }
            }
        }
    }

    // 2. SEGUNDO: Detectar por extensao do arquivo
    for (const [cat, info] of Object.entries(CATEGORIAS)) {
        if (info.extensoes && info.extensoes.includes(ext)) {
            return cat;
        }
    }

    // 3. TERCEIRO: Regras especificas avancadas
    // Screenshots
    if (nomeLower.includes('captura de tela') || nomeLower.includes('screen shot') || nomeLower.startsWith('img_') || nomeLower.startsWith('photo-')) {
        return 'SCREENSHOTS';
    }

    // Gravacoes de audio
    if (nomeLower.includes('recording') || nomeLower.startsWith('audio-') || nomeLower.includes('voice')) {
        return 'GRAVACOES';
    }

    // Notas fiscais (varios formatos)
    if (nomeLower.includes('nf-') || nomeLower.includes('nfe-') || nomeLower.includes('danfe') || (nomeLower.includes('nota') && nomeLower.includes('fiscal'))) {
        return 'NOTAS_FISCAIS';
    }

    // Boletos
    if (nomeLower.includes('boleto') || nomeLower.includes('cobranca') || nomeLower.includes('fatura')) {
        return 'BOLETOS';
    }

    // Recibos
    if (nomeLower.includes('recibo') || nomeLower.includes('comprovante') || nomeLower.includes('receipt')) {
        return 'RECIBOS';
    }

    // Orcamentos
    if (nomeLower.includes('orcamento') || nomeLower.includes('proposta') || nomeLower.includes('cotacao')) {
        return 'ORCAMENTOS';
    }

    // Contratos
    if (nomeLower.includes('contrato') || nomeLower.includes('contract') || nomeLower.includes('acordo') || nomeLower.includes('termo')) {
        return 'CONTRATOS';
    }

    // Certidoes
    if (nomeLower.includes('certidao') || nomeLower.includes('cnd') || nomeLower.includes('fgts') || nomeLower.includes('inss')) {
        return 'CERTIDOES';
    }

    // Madeira e produtos relacionados
    if (nomeLower.includes('madeira') || nomeLower.includes('pinus') || nomeLower.includes('eucalipto') ||
        nomeLower.includes('mdf') || nomeLower.includes('compensado') || nomeLower.includes('tabuado')) {
        return 'MADEIRA';
    }

    // Fretes e logistica
    if (nomeLower.includes('frete') || nomeLower.includes('carga') || nomeLower.includes('embarque') || nomeLower.includes('carregamento')) {
        return 'FRETES';
    }

    // Rotas
    if (nomeLower.includes('rota') || nomeLower.includes('trajeto') || nomeLower.includes('itinerario')) {
        return 'ROTAS';
    }

    // Motoristas
    if (nomeLower.includes('motorista') || nomeLower.includes('freteiro') || nomeLower.includes('caminhoneiro')) {
        return 'MOTORISTAS';
    }

    // Fornecedores
    if (nomeLower.includes('fornecedor') || nomeLower.includes('serraria') || nomeLower.includes('madeireira')) {
        return 'FORNECEDORES';
    }

    // Clientes
    if (nomeLower.includes('cliente') || nomeLower.includes('customer') || nomeLower.includes('comprador')) {
        return 'CLIENTES';
    }

    // Contatos
    if (nomeLower.includes('contato') || nomeLower.includes('contact') || nomeLower.includes('telefone')) {
        return 'CONTATOS';
    }

    // Veiculos
    if (nomeLower.includes('veiculo') || nomeLower.includes('carro') || nomeLower.includes('caminhao') ||
        nomeLower.includes('placa') || nomeLower.includes('crlv') || nomeLower.includes('renavam')) {
        return 'VEICULOS';
    }

    // Documentos pessoais
    if (nomeLower.includes('rg_') || nomeLower.includes('cpf_') || nomeLower.includes('cnh_') ||
        nomeLower.includes('identidade') || nomeLower.includes('passaporte')) {
        return 'DOCUMENTOS_PESSOAIS';
    }

    // Curriculos
    if (nomeLower.includes('curriculo') || nomeLower.includes('cv_') || nomeLower.includes('resume')) {
        return 'CURRICULOS';
    }

    // Financeiro geral
    if (nomeLower.includes('financeiro') || nomeLower.includes('pagamento') || nomeLower.includes('extrato') ||
        nomeLower.includes('banco') || nomeLower.includes('saldo')) {
        return 'FINANCEIRO';
    }

    // Marketing
    if (nomeLower.includes('marketing') || nomeLower.includes('propaganda') || nomeLower.includes('anuncio') ||
        nomeLower.includes('campanha') || nomeLower.includes('divulgacao')) {
        return 'MARKETING';
    }

    // Logos
    if (nomeLower.includes('logo') || nomeLower.includes('logotipo') || nomeLower.includes('marca') || nomeLower.includes('brand')) {
        return 'LOGOS';
    }

    // Templates
    if (nomeLower.includes('template') || nomeLower.includes('modelo_') || nomeLower.includes('layout')) {
        return 'TEMPLATES';
    }

    // Projetos
    if (nomeLower.includes('projeto') || nomeLower.includes('project') || nomeLower.includes('plano_')) {
        return 'PROJETOS';
    }

    // Relatorios
    if (nomeLower.includes('relatorio') || nomeLower.includes('report') || nomeLower.includes('analise')) {
        return 'RELATORIOS';
    }

    // WhatsApp
    if (nomeLower.includes('whatsapp') || nomeLower.includes('wpp') || nomeLower.includes('wa_')) {
        return 'WHATSAPP';
    }

    // Backup
    if (nomeLower.includes('backup') || nomeLower.includes('_bak') || nomeLower.includes('.old')) {
        return 'BACKUP';
    }

    // Estoque
    if (nomeLower.includes('estoque') || nomeLower.includes('inventario') || nomeLower.includes('stock')) {
        return 'ESTOQUE';
    }

    // Produtos
    if (nomeLower.includes('produto') || nomeLower.includes('mercadoria') || nomeLower.includes('item_')) {
        return 'PRODUTOS';
    }

    // Juridico
    if (nomeLower.includes('juridico') || nomeLower.includes('processo') || nomeLower.includes('advogado') || nomeLower.includes('peticao')) {
        return 'JURIDICO';
    }

    // Atestados
    if (nomeLower.includes('atestado') || nomeLower.includes('medico') || nomeLower.includes('licenca_')) {
        return 'ATESTADOS';
    }

    // Funcionarios
    if (nomeLower.includes('funcionario') || nomeLower.includes('empregado') || nomeLower.includes('colaborador')) {
        return 'FUNCIONARIOS';
    }

    // 4. FALLBACK: Retorna OUTROS
    return 'OUTROS';
}

document.getElementById('fileInput').addEventListener('change', function(e) {
    for (const file of e.target.files) adicionarParaTriagem(file, file.webkitRelativePath || file.name);
    mostrarTriagem(); salvarDados();
});

const importZone = document.getElementById('importZone');
importZone.addEventListener('dragover', (e) => { e.preventDefault(); importZone.classList.add('dragover'); });
importZone.addEventListener('dragleave', () => importZone.classList.remove('dragover'));
importZone.addEventListener('drop', async (e) => {
    e.preventDefault(); importZone.classList.remove('dragover');
    for (let i = 0; i < e.dataTransfer.items.length; i++) {
        const item = e.dataTransfer.items[i].webkitGetAsEntry();
        if (item) await processarDrop(item, '');
    }
    mostrarTriagem(); salvarDados();
});

async function processarDrop(item, caminhoPai) {
    if (item.isFile) { const file = await new Promise(r => item.file(r)); adicionarParaTriagem(file, caminhoPai ? `${caminhoPai}/${item.name}` : item.name); }
    else if (item.isDirectory) { const entries = await new Promise(r => item.createReader().readEntries(r)); for (const entry of entries) await processarDrop(entry, caminhoPai ? `${caminhoPai}/${item.name}` : item.name); }
}

function mostrarTriagem() {
    const panel = document.getElementById('panelTriagem');
    if (db.pendentes.length === 0) { panel.style.display = 'none'; return; }
    panel.style.display = 'block';
    document.getElementById('triagemCount').textContent = `${db.pendentes.length} arquivos`;
    document.getElementById('triagemGrid').innerHTML = db.pendentes.map(arq => `
        <div class="triagem-card ${arq.status}"><div class="file-icon">${CATEGORIAS[arq.categoria]?.icon || 'ğŸ“'}</div>
        <div class="file-name">${arq.nome}</div><div class="file-info">ğŸ“ ${arq.caminho}<br>ğŸ’¾ ${formatarTamanho(arq.tamanho)}</div>
        <select onchange="alterarCategoria(${arq.id}, this.value)">${Object.entries(CATEGORIAS).map(([cat, info]) => `<option value="${cat}" ${arq.categoria === cat ? 'selected' : ''}>${info.icon} ${cat}</option>`).join('')}</select>
        <div class="btn-group"><button class="btn btn-small btn-success" onclick="organizarArquivo(${arq.id})">âœ…</button><button class="btn btn-small btn-danger" onclick="removerArquivo(${arq.id})">ğŸ—‘ï¸</button></div></div>`).join('');
}

function alterarCategoria(id, cat) { const arq = db.pendentes.find(a => a.id === id); if (arq) arq.categoria = cat; salvarDados(); }
function autoCategorizarTodos() { db.pendentes.forEach(a => a.categoria = detectarCategoria(a.nome)); mostrarTriagem(); salvarDados(); }

async function organizarArquivo(id) {
    const arq = db.pendentes.find(a => a.id === id); if (!arq) return;
    arq.status = 'organizado'; arq.dataOrganizacao = new Date().toISOString();

    // Triagem inteligente - detecta se Ã© contato para adicionar ao banco
    const nomeArq = arq.nome.toLowerCase();
    const categoriaArq = arq.categoria;

    // Se for arquivo de contatos (CSV, Excel), tenta extrair contatos
    if (arq.file && (nomeArq.endsWith('.csv') || nomeArq.endsWith('.xlsx') || nomeArq.endsWith('.xls'))) {
        // Detecta tipo baseado na categoria ou nome
        let tipoContato = 'indefinido';
        if (categoriaArq === 'CLIENTES' || nomeArq.includes('cliente')) tipoContato = 'cliente';
        else if (categoriaArq === 'FORNECEDORES' || nomeArq.includes('fornecedor')) tipoContato = 'fornecedor';
        else if (categoriaArq === 'LOGISTICA' || nomeArq.includes('motorista') || nomeArq.includes('frete')) tipoContato = 'motorista';

        // LÃª o arquivo e extrai contatos
        try {
            const texto = await arq.file.text();
            const linhas = texto.split('\n').slice(1); // Pula cabeÃ§alho

            let contatosImportados = 0;
            linhas.forEach(linha => {
                if (!linha.trim()) return;
                const cols = linha.split(/[;,]/).map(c => c.replace(/"/g, '').trim());

                if (cols.length >= 2 && cols[0] && cols[1]) {
                    const novoContato = {
                        id: Date.now() + Math.random(),
                        nome: cols[0],
                        whatsapp: cols[1],
                        tipo: tipoContato,
                        cidade: cols[2] || '',
                        empresa: cols[3] || '',
                        obs: `Importado de: ${arq.nome}`,
                        dataCadastro: new Date().toISOString()
                    };

                    // Evita duplicados
                    if (!db.contatosUnificados.find(c => c.whatsapp === novoContato.whatsapp)) {
                        db.contatosUnificados.push(novoContato);
                        contatosImportados++;
                    }
                }
            });

            if (contatosImportados > 0) {
                sincronizarContatosAntigos();
                console.log(`ğŸ“¥ ${contatosImportados} contatos importados de ${arq.nome}`);
            }
        } catch(e) {
            console.error('Erro ao extrair contatos:', e);
        }
    }

    // Move arquivo fisicamente via servidor
    if (arq.caminho || arq.file) {
        try {
            fetch(`http://localhost:8899/mover-arquivo`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    origem: arq.caminhoOrigem || arq.caminho || '',
                    categoria: arq.categoria,
                    nome: arq.nome
                })
            }).then(r => r.json()).then(data => {
                if (data.success) {
                    console.log(`âœ… Arquivo movido para: ${data.destino}`);
                    arq.caminhoFinal = data.destino;
                    salvarDados();
                }
            }).catch(e => console.log('Servidor offline, arquivo registrado apenas'));
        } catch(e) {
            console.log('Erro ao mover arquivo:', e);
        }
    }

    db.historico.unshift({ ...arq, file: null }); db.pendentes = db.pendentes.filter(a => a.id !== id);
    ganharXP(5); mostrarTriagem(); salvarDados();
}

async function organizarTodos() {
    const total = db.pendentes.length; if (total === 0) return;
    document.getElementById('progressBar').style.display = 'block';
    for (let i = 0; i < total; i++) {
        await organizarArquivo(db.pendentes[0].id);
        document.getElementById('progressFill').style.width = `${((i + 1) / total) * 100}%`;
        await new Promise(r => setTimeout(r, 100));
    }
    document.getElementById('progressBar').style.display = 'none'; alert(`âœ… ${total} arquivos organizados!`);
}

function removerArquivo(id) { db.pendentes = db.pendentes.filter(a => a.id !== id); mostrarTriagem(); salvarDados(); }
function limparTriagem() { if (confirm('Limpar todos?')) { db.pendentes = []; mostrarTriagem(); salvarDados(); } }

function adicionarConhecimento() {
    const titulo = document.getElementById('conhecimentoTitulo').value.trim();
    const conteudo = document.getElementById('conhecimentoConteudo').value.trim();
    if (!titulo || !conteudo) { document.getElementById('alertaConhecimento').innerHTML = '<div class="alert error">âŒ Preencha tÃ­tulo e conteÃºdo!</div>'; return; }
    db.conhecimentos.push({ id: Date.now(), titulo, conteudo, categoria: document.getElementById('conhecimentoCategoria').value, fonte: document.getElementById('conhecimentoFonte').value.trim() || 'Manual', tags: document.getElementById('conhecimentoTags').value.split(',').map(t => t.trim()).filter(t => t), dataCriacao: new Date().toISOString() });
    ganharXP(15);
    ['conhecimentoTitulo', 'conhecimentoConteudo', 'conhecimentoFonte', 'conhecimentoTags'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('alertaConhecimento').innerHTML = '<div class="alert success">âœ… Conhecimento adicionado! +15 XP</div>';
    setTimeout(() => document.getElementById('alertaConhecimento').innerHTML = '', 3000); salvarDados();
}

function importarConhecimentos(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const conteudo = e.target.result; let conhecimentos = [];
            if (file.name.endsWith('.json')) conhecimentos = JSON.parse(conteudo);
            else if (file.name.endsWith('.csv')) conteudo.split('\n').slice(1).forEach(l => { const [t, c, cat] = l.split(';').map(x => x.replace(/"/g, '').trim()); if (t && c) conhecimentos.push({ titulo: t, conteudo: c, categoria: cat || 'geral' }); });
            else conteudo.split('\n').filter(l => l.trim()).forEach((l, i) => conhecimentos.push({ titulo: `Conhecimento ${i + 1}`, conteudo: l, categoria: 'geral' }));
            conhecimentos.forEach(c => db.conhecimentos.push({ id: Date.now() + Math.random(), titulo: c.titulo || 'Sem tÃ­tulo', conteudo: c.conteudo, categoria: c.categoria || 'geral', fonte: file.name, tags: c.tags || [], dataCriacao: new Date().toISOString() }));
            ganharXP(conhecimentos.length * 10); salvarDados(); alert(`âœ… ${conhecimentos.length} conhecimentos importados!`);
        } catch(err) { alert('âŒ Erro: ' + err.message); }
    };
    reader.readAsText(file);
}

function renderConhecimentos() {
    const c = document.getElementById('conhecimentosContainer');
    document.getElementById('totalConhecimentos').textContent = db.conhecimentos.length;
    if (db.conhecimentos.length === 0) { c.innerHTML = '<div class="empty-state"><div class="icon">ğŸ§ </div><p>Nenhum conhecimento ainda.</p></div>'; return; }
    c.innerHTML = db.conhecimentos.slice(0, 20).map(k => `<div class="knowledge-card"><h4>${k.titulo}</h4><p>${k.conteudo.substring(0, 200)}${k.conteudo.length > 200 ? '...' : ''}</p><div class="tags"><span class="tag">${k.categoria}</span>${k.tags.map(t => `<span class="tag">${t}</span>`).join('')}</div><div class="source">ğŸ“ ${k.fonte}</div></div>`).join('');
}

function ganharXP(q) { db.agent.xp += q; db.agent.interacoes++; db.agent.nivel = Math.floor(db.agent.xp / 100) + 1; if (db.agent.precisao < 99) db.agent.precisao = Math.min(99, 85 + (db.conhecimentos.length * 0.5)); salvarDados(); }

function atualizarAgentBar() {
    document.getElementById('agentLevel').textContent = db.agent.nivel;
    document.getElementById('agentXP').textContent = db.agent.xp;
    document.getElementById('agentConhecimentos').textContent = db.conhecimentos.length;
    document.getElementById('agentPrecisao').textContent = Math.round(db.agent.precisao) + '%';
    document.getElementById('agentInteracoes').textContent = db.agent.interacoes;
    document.getElementById('xpBar').style.width = ((db.agent.xp % 100) / 100 * 100) + '%';
}

function novoFrete() { document.getElementById('formFrete').style.display = 'block'; }
function cancelarFrete() { document.getElementById('formFrete').style.display = 'none'; }

function salvarFrete() {
    const m = document.getElementById('freteMotorista').value.trim(), w = document.getElementById('freteWhatsapp').value.trim(), o = document.getElementById('freteOrigem').value.trim(), d = document.getElementById('freteDestino').value.trim();
    if (!m || !w || !o || !d) { document.getElementById('alertaFrete').innerHTML = '<div class="alert error">âŒ Preencha os obrigatÃ³rios!</div>'; return; }
    db.fretes.unshift({ id: Date.now(), motorista: m, whatsapp: w, placa: document.getElementById('fretePlaca').value.trim(), origem: o, destino: d, carga: document.getElementById('freteCarga').value, peso: document.getElementById('fretePeso').value, valor: document.getElementById('freteValor').value, data: document.getElementById('freteData').value, obs: document.getElementById('freteObs').value.trim(), status: 'pendente', dataCadastro: new Date().toISOString() });
    if (!db.contatos.motoristas.find(x => x.whatsapp === w)) db.contatos.motoristas.push({ id: Date.now(), nome: m, whatsapp: w });
    ganharXP(10); salvarDados(); cancelarFrete();
}

function sincronizarFretes() { sincronizarTudoSheets(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS - SINCRONIZAÃ‡ÃƒO COMPLETA (Fretes, Clientes, Fornecedores, Motoristas)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function sincronizarTudoSheets() {
    const status = document.getElementById('statusSheets');
    status.style.display = 'block';
    status.className = 'alert info';
    status.innerHTML = 'ğŸ”„ Sincronizando com Google Sheets...';

    try {
        // Atualiza contadores
        const clientes = db.contatosUnificados.filter(c => c.tipo === 'cliente');
        const fornecedores = db.contatosUnificados.filter(c => c.tipo === 'fornecedor');
        const motoristas = db.contatosUnificados.filter(c => c.tipo === 'motorista');

        document.getElementById('sheetsFretes').textContent = db.fretes.length;
        document.getElementById('sheetsClientes').textContent = clientes.length;
        document.getElementById('sheetsFornecedores').textContent = fornecedores.length;
        document.getElementById('sheetsMotoristas').textContent = motoristas.length;

        // Verifica se tem WebApp configurado
        if (!CONFIG.webApp) {
            status.className = 'alert warning';
            status.innerHTML = `âš ï¸ Configure a URL do Web App nas ConfiguraÃ§Ãµes para sincronizar automaticamente.<br><br>
            <strong>Dados prontos para enviar:</strong><br>
            â€¢ ğŸšš ${db.fretes.length} fretes<br>
            â€¢ ğŸ‘¥ ${clientes.length} clientes<br>
            â€¢ ğŸ­ ${fornecedores.length} fornecedores<br>
            â€¢ ğŸšš ${motoristas.length} motoristas<br><br>
            <a href="https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/edit" target="_blank" style="color:var(--success);">ğŸ“Š Abrir Planilha Manualmente</a>`;
            return;
        }

        // Envia dados para Google Sheets
        const dados = {
            action: 'sincronizar',
            fretes: db.fretes,
            clientes: clientes,
            fornecedores: fornecedores,
            motoristas: motoristas,
            timestamp: new Date().toISOString()
        };

        const response = await fetch(CONFIG.webApp, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dados)
        });

        status.className = 'alert success';
        status.innerHTML = `âœ… Dados enviados para Google Sheets!<br><br>
        â€¢ ğŸšš ${db.fretes.length} fretes<br>
        â€¢ ğŸ‘¥ ${clientes.length} clientes<br>
        â€¢ ğŸ­ ${fornecedores.length} fornecedores<br>
        â€¢ ğŸšš ${motoristas.length} motoristas<br><br>
        <a href="https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/edit" target="_blank" style="color:var(--success);">ğŸ“Š Ver Planilha</a>`;

        ganharXP(10);

    } catch(err) {
        status.className = 'alert error';
        status.innerHTML = 'âŒ Erro ao sincronizar: ' + err.message;
    }
}

async function enviarFretesSheets() {
    await enviarParaSheets('Fretes', db.fretes.map(f => ({
        Data: f.dataCadastro || new Date().toISOString(),
        Motorista: f.motorista,
        WhatsApp: f.whatsapp,
        Placa: f.placa || '',
        Origem: f.origem,
        Destino: f.destino,
        Carga: f.carga || '',
        Peso: f.peso || '',
        Valor: f.valor || '',
        Status: f.status || 'pendente',
        Obs: f.obs || ''
    })));
}

async function enviarClientesSheets() {
    const clientes = db.contatosUnificados.filter(c => c.tipo === 'cliente');
    await enviarParaSheets('Clientes', clientes.map(c => ({
        Nome: c.nome,
        WhatsApp: c.whatsapp,
        Email: c.email || '',
        Empresa: c.empresa || '',
        Cidade: c.cidade || '',
        Observacoes: c.obs || '',
        DataCadastro: c.dataCadastro || new Date().toISOString()
    })));
}

async function enviarFornecedoresSheets() {
    const fornecedores = db.contatosUnificados.filter(c => c.tipo === 'fornecedor');
    await enviarParaSheets('Fornecedores', fornecedores.map(f => ({
        Nome: f.nome,
        WhatsApp: f.whatsapp,
        Email: f.email || '',
        Empresa: f.empresa || '',
        Cidade: f.cidade || '',
        Observacoes: f.obs || '',
        DataCadastro: f.dataCadastro || new Date().toISOString()
    })));
}

async function enviarMotoristasSheets() {
    const motoristas = db.contatosUnificados.filter(c => c.tipo === 'motorista');
    await enviarParaSheets('Motoristas', motoristas.map(m => ({
        Nome: m.nome,
        WhatsApp: m.whatsapp,
        Email: m.email || '',
        Cidade: m.cidade || '',
        Observacoes: m.obs || '',
        DataCadastro: m.dataCadastro || new Date().toISOString()
    })));
}

async function enviarParaSheets(aba, dados) {
    const status = document.getElementById('statusSheets');
    status.style.display = 'block';

    if (dados.length === 0) {
        status.className = 'alert warning';
        status.innerHTML = `âš ï¸ Nenhum dado de ${aba} para enviar.`;
        return;
    }

    if (!CONFIG.webApp) {
        // Sem WebApp - exporta CSV para importar manualmente
        const headers = Object.keys(dados[0]).join(';');
        const rows = dados.map(d => Object.values(d).map(v => `"${v}"`).join(';')).join('\n');
        download(headers + '\n' + rows, `${aba}_google_sheets.csv`, 'text/csv');

        status.className = 'alert success';
        status.innerHTML = `âœ… Arquivo CSV exportado para ${aba}!<br><br>
        <strong>Para importar no Google Sheets:</strong><br>
        1. Abra a planilha<br>
        2. Crie uma aba "${aba}" se nÃ£o existir<br>
        3. Arquivo > Importar > Upload > Selecione o CSV<br><br>
        <a href="https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/edit" target="_blank" style="color:var(--success);">ğŸ“Š Abrir Planilha</a>`;
        return;
    }

    try {
        status.className = 'alert info';
        status.innerHTML = `ğŸ”„ Enviando ${dados.length} registros para aba ${aba}...`;

        const response = await fetch(CONFIG.webApp, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'inserir', aba: aba, dados: dados })
        });

        status.className = 'alert success';
        status.innerHTML = `âœ… ${dados.length} registros enviados para aba "${aba}"!<br>
        <a href="https://docs.google.com/spreadsheets/d/${CONFIG.sheetId}/edit" target="_blank" style="color:var(--success);">ğŸ“Š Ver Planilha</a>`;

        ganharXP(5);

    } catch(err) {
        status.className = 'alert error';
        status.innerHTML = 'âŒ Erro: ' + err.message;
    }
}

function renderFretes() {
    document.getElementById('totalFretes').textContent = db.fretes.length;
    const t = document.getElementById('fretesTable');
    if (db.fretes.length === 0) { t.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;">Nenhum frete</td></tr>'; return; }
    t.innerHTML = db.fretes.map(f => `<tr><td><strong>${f.motorista}</strong><br><span style="font-size:0.85em;color:rgba(255,255,255,0.6);">ğŸ“± ${f.whatsapp}</span></td><td>${f.origem} â†’ ${f.destino}</td><td>${f.carga || '-'}</td><td>R$ ${f.valor || '-'}</td><td><span style="background:var(--info);padding:4px 10px;border-radius:10px;font-size:0.8em;">â³</span></td><td><button class="btn btn-small btn-whatsapp" onclick="window.open('https://wa.me/${f.whatsapp.replace(/\\D/g,'')}','_blank')">ğŸ’¬</button><button class="btn btn-small btn-danger" onclick="excluirFrete(${f.id})">ğŸ—‘ï¸</button></td></tr>`).join('');
}

function excluirFrete(id) { if (confirm('Excluir?')) { db.fretes = db.fretes.filter(f => f.id !== id); salvarDados(); } }
function exportarFretes() { download('Motorista;WhatsApp;Origem;Destino;Valor\n' + db.fretes.map(f => `"${f.motorista}";"${f.whatsapp}";"${f.origem}";"${f.destino}";"${f.valor}"`).join('\n'), 'fretes.csv', 'text/csv'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WHATSAPP WEB - ENVIO DIRETO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function carregarConfigWA() {
    // Carrega contatos no select
    carregarContatosWA();
}

function carregarContatosWA() {
    const select = document.getElementById('waContatoSelect');
    if (!select) return;

    select.innerHTML = '<option value="">-- Selecionar contato --</option>';

    db.contatosUnificados.forEach(c => {
        if (c.whatsapp) {
            const tipo = c.tipo === 'motorista' ? 'ğŸšš' : c.tipo === 'fornecedor' ? 'ğŸ­' : c.tipo === 'cliente' ? 'ğŸ‘¥' : 'ğŸ‘¤';
            select.innerHTML += `<option value="${c.whatsapp}">${tipo} ${c.nome}</option>`;
        }
    });
}

function selecionarContatoWA() {
    const select = document.getElementById('waContatoSelect');
    const numero = select.value;
    if (numero) {
        document.getElementById('waNumeroRapido').value = numero;
    }
}

function enviarWhatsAppWeb() {
    const numero = document.getElementById('waNumeroRapido').value.replace(/\D/g, '');
    const mensagem = document.getElementById('waMensagemRapida').value.trim();

    if (!numero) {
        alert('âš ï¸ Digite ou selecione um nÃºmero!');
        return;
    }

    // Monta URL do WhatsApp Web
    let url = `https://wa.me/${numero}`;
    if (mensagem) {
        url += `?text=${encodeURIComponent(mensagem)}`;
    }

    window.open(url, '_blank');
    ganharXP(2);
}

function abrirWhatsAppContato(whatsapp, mensagem = '') {
    const numero = whatsapp.replace(/\D/g, '');
    let url = `https://wa.me/${numero}`;
    if (mensagem) {
        url += `?text=${encodeURIComponent(mensagem)}`;
    }
    window.open(url, '_blank');
}

function enviarParaLista(listaId) {
    const lista = db.listas.find(l => l.id === listaId);
    if (!lista || lista.contatos.length === 0) {
        alert('âš ï¸ Lista vazia!');
        return;
    }

    const mensagem = prompt('Digite a mensagem para enviar:');
    if (!mensagem) return;

    // Abre primeiro contato
    let index = 0;

    function abrirProximo() {
        if (index < lista.contatos.length) {
            const contato = lista.contatos[index];
            abrirWhatsAppContato(contato.whatsapp, mensagem);
            index++;

            if (index < lista.contatos.length) {
                setTimeout(() => {
                    if (confirm(`âœ… ${index}/${lista.contatos.length} enviado!\n\nAbrir prÃ³ximo: ${lista.contatos[index].nome}?`)) {
                        abrirProximo();
                    }
                }, 1000);
            } else {
                alert(`âœ… TransmissÃ£o concluÃ­da!\n\n${lista.contatos.length} contatos processados.`);
                ganharXP(lista.contatos.length);
            }
        }
    }

    abrirProximo();
}

function criarLista() { document.getElementById('formLista').style.display = 'block'; }
function cancelarLista() { document.getElementById('formLista').style.display = 'none'; }

function salvarLista() {
    const nome = document.getElementById('listaNome').value.trim(); if (!nome) { alert('Nome!'); return; }
    const tipo = document.getElementById('listaFiltroTipo').value; let contatos = [];
    if (!tipo || tipo === 'motoristas') contatos = [...contatos, ...db.contatos.motoristas.filter(c => c.whatsapp)];
    if (!tipo || tipo === 'fornecedores') contatos = [...contatos, ...db.contatos.fornecedores.filter(c => c.whatsapp)];
    if (!tipo || tipo === 'clientes') contatos = [...contatos, ...db.contatos.clientes.filter(c => c.whatsapp)];
    db.listas.push({ id: Date.now(), nome, tipo: tipo || 'todos', contatos: contatos.map(c => ({ nome: c.nome, whatsapp: c.whatsapp })), dataCriacao: new Date().toISOString() });
    ganharXP(5); salvarDados(); cancelarLista(); alert(`âœ… Lista "${nome}" criada com ${contatos.length} contatos!`);
}

function renderListas() {
    document.getElementById('totalListas').textContent = db.listas.length;
    const c = document.getElementById('listasContainer');
    if (db.listas.length === 0) { c.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“­</div><p>Nenhuma lista</p></div>'; return; }
    c.innerHTML = db.listas.map(l => `<div class="list-card"><div class="info"><strong>${l.nome}</strong><span>${l.contatos.length} contatos</span></div><div class="btn-group"><button class="btn btn-small btn-whatsapp" onclick="enviarParaLista(${l.id})">ğŸ“± Enviar</button><button class="btn btn-small btn-info" onclick="exportarListaWA(${l.id})">ğŸ“¤</button><button class="btn btn-small btn-danger" onclick="excluirLista(${l.id})">ğŸ—‘ï¸</button></div></div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVOLUTION API - INTEGRAÃ‡ÃƒO WHATSAPP AUTOMÃTICO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let evolutionStats = {
    mensagensEnviadas: 0,
    ultimaAtualizacao: null
};

// Carregar configuraÃ§Ãµes da Evolution API
function carregarConfigEvolution() {
    const saved = localStorage.getItem('enside_evolution_config');
    if (saved) {
        const config = JSON.parse(saved);
        CONFIG.evolutionApi = { ...CONFIG.evolutionApi, ...config };
        document.getElementById('evolutionApiUrl').value = CONFIG.evolutionApi.baseUrl || 'http://localhost:8080';
        document.getElementById('evolutionApiKey').value = CONFIG.evolutionApi.apiKey || '';
        document.getElementById('evolutionInstanceName').value = CONFIG.evolutionApi.instanceName || 'enside_whatsapp';
    }
    carregarContatosEvolution();
    verificarStatusEvolution();
}

// Salvar configuraÃ§Ãµes da Evolution API
function salvarConfigEvolution() {
    CONFIG.evolutionApi.baseUrl = document.getElementById('evolutionApiUrl').value.trim();
    CONFIG.evolutionApi.apiKey = document.getElementById('evolutionApiKey').value.trim();
    CONFIG.evolutionApi.instanceName = document.getElementById('evolutionInstanceName').value.trim();
    CONFIG.evolutionApi.enabled = true;
    
    localStorage.setItem('enside_evolution_config', JSON.stringify(CONFIG.evolutionApi));
    
    const status = document.getElementById('statusEvolution');
    status.style.display = 'block';
    status.className = 'alert success';
    status.innerHTML = 'âœ… ConfiguraÃ§Ãµes da Evolution API salvas com sucesso!';
    
    setTimeout(() => { status.style.display = 'none'; }, 3000);
}

// Testar conexÃ£o com Evolution API
async function testarConexaoEvolution() {
    const status = document.getElementById('statusEvolution');
    status.style.display = 'block';
    status.className = 'alert info';
    status.innerHTML = 'ğŸ”„ Testando conexÃ£o com Evolution API...';
    
    try {
        const response = await fetch(`${CONFIG.evolutionApi.baseUrl}/instance/fetchInstances`, {
            method: 'GET',
            headers: {
                'apikey': CONFIG.evolutionApi.apiKey,
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            status.className = 'alert success';
            status.innerHTML = `âœ… ConexÃ£o estabelecida com sucesso!<br>
                <strong>InstÃ¢ncias encontradas:</strong> ${Array.isArray(data) ? data.length : 0}<br>
                <small>URL: ${CONFIG.evolutionApi.baseUrl}</small>`;
            atualizarStatusEvolution('Conectado');
        } else {
            throw new Error(`HTTP ${response.status}`);
        }
    } catch (error) {
        status.className = 'alert danger';
        status.innerHTML = `âŒ Erro ao conectar: ${error.message}<br>
            <small>Verifique se a Evolution API estÃ¡ rodando em ${CONFIG.evolutionApi.baseUrl}</small>`;
        atualizarStatusEvolution('Erro');
    }
}

// Criar instÃ¢ncia na Evolution API
async function criarInstanciaEvolution() {
    const status = document.getElementById('statusEvolution');
    status.style.display = 'block';
    status.className = 'alert info';
    status.innerHTML = 'ğŸ”„ Criando instÃ¢ncia...';
    
    try {
        const response = await fetch(`${CONFIG.evolutionApi.baseUrl}/instance/create`, {
            method: 'POST',
            headers: {
                'apikey': CONFIG.evolutionApi.apiKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                instanceName: CONFIG.evolutionApi.instanceName,
                qrcode: true,
                integration: 'WHATSAPP-BAILEYS'
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            status.className = 'alert success';
            status.innerHTML = `âœ… InstÃ¢ncia "${CONFIG.evolutionApi.instanceName}" criada com sucesso!<br>
                <small>Agora clique em "Conectar WhatsApp" para escanear o QR Code.</small>`;
            ganharXP(10);
        } else {
            throw new Error(data.message || 'Erro ao criar instÃ¢ncia');
        }
    } catch (error) {
        status.className = 'alert danger';
        status.innerHTML = `âŒ Erro: ${error.message}`;
    }
}

// Conectar WhatsApp (gerar QR Code)
async function conectarWhatsAppEvolution() {
    const status = document.getElementById('statusEvolution');
    const qrcodeDiv = document.getElementById('qrcodeEvolution');
    
    status.style.display = 'block';
    status.className = 'alert info';
    status.innerHTML = 'ğŸ”„ Gerando QR Code...';
    
    try {
        const response = await fetch(`${CONFIG.evolutionApi.baseUrl}/instance/connect/${CONFIG.evolutionApi.instanceName}`, {
            method: 'GET',
            headers: {
                'apikey': CONFIG.evolutionApi.apiKey
            }
        });
        
        const data = await response.json();
        
        if (data.base64) {
            status.className = 'alert warning';
            status.innerHTML = 'ğŸ“± Escaneie o QR Code abaixo com seu WhatsApp:';
            qrcodeDiv.style.display = 'block';
            qrcodeDiv.innerHTML = `<img src="${data.base64}" alt="QR Code" style="max-width:300px;border-radius:12px;border:3px solid var(--whatsapp);">
                <p style="margin-top:10px;color:var(--warning);">â³ Aguardando leitura do QR Code...</p>`;
            
            // Verificar conexÃ£o a cada 5 segundos
            const checkInterval = setInterval(async () => {
                const connected = await verificarConexaoEvolution();
                if (connected) {
                    clearInterval(checkInterval);
                    qrcodeDiv.style.display = 'none';
                    status.className = 'alert success';
                    status.innerHTML = 'âœ… WhatsApp conectado com sucesso!';
                    atualizarStatusEvolution('Conectado');
                    ganharXP(20);
                }
            }, 5000);
            
            // Timeout apÃ³s 2 minutos
            setTimeout(() => {
                clearInterval(checkInterval);
                if (qrcodeDiv.style.display !== 'none') {
                    qrcodeDiv.style.display = 'none';
                    status.className = 'alert danger';
                    status.innerHTML = 'â° Tempo esgotado. Tente novamente.';
                }
            }, 120000);
            
        } else if (data.instance?.state === 'open') {
            status.className = 'alert success';
            status.innerHTML = 'âœ… WhatsApp jÃ¡ estÃ¡ conectado!';
            atualizarStatusEvolution('Conectado');
        } else {
            throw new Error(data.message || 'Erro ao gerar QR Code');
        }
    } catch (error) {
        status.className = 'alert danger';
        status.innerHTML = `âŒ Erro: ${error.message}`;
    }
}

// Verificar se estÃ¡ conectado
async function verificarConexaoEvolution() {
    try {
        const response = await fetch(`${CONFIG.evolutionApi.baseUrl}/instance/connectionState/${CONFIG.evolutionApi.instanceName}`, {
            headers: { 'apikey': CONFIG.evolutionApi.apiKey }
        });
        const data = await response.json();
        return data.instance?.state === 'open';
    } catch {
        return false;
    }
}

// Verificar status da instÃ¢ncia
async function verificarStatusEvolution() {
    try {
        const connected = await verificarConexaoEvolution();
        atualizarStatusEvolution(connected ? 'Conectado' : 'Desconectado');
    } catch {
        atualizarStatusEvolution('Erro');
    }
}

// Atualizar status na interface
function atualizarStatusEvolution(status) {
    const statusEl = document.getElementById('evolutionStatusConexao');
    if (statusEl) {
        statusEl.textContent = status;
        statusEl.style.color = status === 'Conectado' ? 'var(--success)' : 
                               status === 'Erro' ? 'var(--danger)' : 'var(--warning)';
    }
    
    const ultimaAtualizacao = document.getElementById('evolutionUltimaAtualizacao');
    if (ultimaAtualizacao) {
        ultimaAtualizacao.textContent = new Date().toLocaleTimeString('pt-BR');
    }
}

// Carregar contatos no select da Evolution
function carregarContatosEvolution() {
    const select = document.getElementById('evolutionContatoSelect');
    if (!select) return;
    
    select.innerHTML = '<option value="">-- Selecionar contato --</option>';
    
    db.contatosUnificados.forEach(c => {
        if (c.whatsapp) {
            const tipo = c.tipo === 'motorista' ? 'ğŸšš' : c.tipo === 'fornecedor' ? 'ğŸ­' : c.tipo === 'cliente' ? 'ğŸ‘¥' : 'ğŸ‘¤';
            select.innerHTML += `<option value="${c.whatsapp}">${tipo} ${c.nome}</option>`;
        }
    });
}

// Selecionar contato Evolution
function selecionarContatoEvolution() {
    const select = document.getElementById('evolutionContatoSelect');
    const numero = select.value;
    if (numero) {
        document.getElementById('evolutionNumero').value = numero;
    }
}

// Enviar mensagem via Evolution API
async function enviarMensagemEvolution() {
    const numero = document.getElementById('evolutionNumero').value.replace(/\D/g, '');
    const mensagem = document.getElementById('evolutionMensagem').value.trim();
    const status = document.getElementById('statusEvolution');
    
    if (!numero) {
        alert('âš ï¸ Digite ou selecione um nÃºmero!');
        return;
    }
    
    if (!mensagem) {
        alert('âš ï¸ Digite uma mensagem!');
        return;
    }
    
    status.style.display = 'block';
    status.className = 'alert info';
    status.innerHTML = 'ğŸ“¤ Enviando mensagem...';
    
    try {
        const response = await fetch(`${CONFIG.evolutionApi.baseUrl}/message/sendText/${CONFIG.evolutionApi.instanceName}`, {
            method: 'POST',
            headers: {
                'apikey': CONFIG.evolutionApi.apiKey,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                number: numero.startsWith('55') ? numero : '55' + numero,
                text: mensagem
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            status.className = 'alert success';
            status.innerHTML = `âœ… Mensagem enviada com sucesso para ${numero}!`;
            evolutionStats.mensagensEnviadas++;
            document.getElementById('evolutionMensagensEnviadas').textContent = evolutionStats.mensagensEnviadas;
            document.getElementById('evolutionMensagem').value = '';
            ganharXP(5);
        } else {
            throw new Error(data.message || 'Erro ao enviar mensagem');
        }
    } catch (error) {
        status.className = 'alert danger';
        status.innerHTML = `âŒ Erro: ${error.message}`;
    }
}

// Enviar para lista via Evolution API
async function enviarParaListaEvolution() {
    if (db.listas.length === 0) {
        alert('âš ï¸ Nenhuma lista criada. Crie uma lista primeiro!');
        return;
    }
    
    const listaId = prompt('Digite o ID da lista (ou deixe vazio para ver as listas):\n\n' + 
        db.listas.map(l => `ID: ${l.id} - ${l.nome} (${l.contatos.length} contatos)`).join('\n'));
    
    if (!listaId) return;
    
    const lista = db.listas.find(l => l.id == listaId);
    if (!lista) {
        alert('âŒ Lista nÃ£o encontrada!');
        return;
    }
    
    const mensagem = document.getElementById('evolutionMensagem').value.trim();
    if (!mensagem) {
        alert('âš ï¸ Digite uma mensagem primeiro!');
        return;
    }
    
    if (!confirm(`Enviar mensagem para ${lista.contatos.length} contatos da lista "${lista.nome}"?`)) {
        return;
    }
    
    const status = document.getElementById('statusEvolution');
    status.style.display = 'block';
    status.className = 'alert info';
    
    let enviados = 0;
    let erros = 0;
    
    for (const contato of lista.contatos) {
        status.innerHTML = `ğŸ“¤ Enviando ${enviados + 1}/${lista.contatos.length}...`;
        
        try {
            const numero = contato.whatsapp.replace(/\D/g, '');
            const response = await fetch(`${CONFIG.evolutionApi.baseUrl}/message/sendText/${CONFIG.evolutionApi.instanceName}`, {
                method: 'POST',
                headers: {
                    'apikey': CONFIG.evolutionApi.apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    number: numero.startsWith('55') ? numero : '55' + numero,
                    text: mensagem
                })
            });
            
            if (response.ok) {
                enviados++;
            } else {
                erros++;
            }
        } catch {
            erros++;
        }
        
        // Delay entre mensagens para evitar bloqueio
        await new Promise(r => setTimeout(r, 2000));
    }
    
    status.className = enviados > 0 ? 'alert success' : 'alert danger';
    status.innerHTML = `âœ… TransmissÃ£o concluÃ­da!<br>
        <strong>Enviados:</strong> ${enviados}<br>
        <strong>Erros:</strong> ${erros}`;
    
    evolutionStats.mensagensEnviadas += enviados;
    document.getElementById('evolutionMensagensEnviadas').textContent = evolutionStats.mensagensEnviadas;
    ganharXP(enviados * 3);
}

// Inicializar Evolution API ao carregar
function inicializarEvolutionAPI() {
    carregarConfigEvolution();
    console.log('ğŸš€ Evolution API inicializada');
}

function exportarListaWA(id) { const l = db.listas.find(x => x.id === id); if (l) download(l.contatos.map(c => c.whatsapp.replace(/\D/g, '')).join('\n'), `${l.nome}_wa.txt`, 'text/plain'); }
function excluirLista(id) { if (confirm('Excluir?')) { db.listas = db.listas.filter(l => l.id !== id); salvarDados(); } }
function exportarContatos() { download('Nome;WhatsApp;Tipo\n' + [...db.contatos.motoristas.map(c => ({ ...c, tipo: 'Motorista' })), ...db.contatos.fornecedores.map(c => ({ ...c, tipo: 'Fornecedor' })), ...db.contatos.clientes.map(c => ({ ...c, tipo: 'Cliente' }))].filter(c => c.whatsapp).map(c => `"${c.nome}";"${c.whatsapp}";"${c.tipo}"`).join('\n'), 'contatos.csv', 'text/csv'); }

function salvarConfig() { CONFIG.webApp = document.getElementById('configWebApp').value.trim(); CONFIG.whatsapp = document.getElementById('configWhatsapp').value.trim(); localStorage.setItem('enside_config', JSON.stringify(CONFIG)); alert('âœ… Salvo!'); }

function carregarConfig() {
    const saved = localStorage.getItem('enside_config');
    if (saved) { Object.assign(CONFIG, JSON.parse(saved)); document.getElementById('configWebApp').value = CONFIG.webApp || ''; document.getElementById('configWhatsapp').value = CONFIG.whatsapp || '5518996540492'; }
}

function exportarBackup() { download(JSON.stringify({ db, CONFIG }, null, 2), `enside_backup_${new Date().toISOString().split('T')[0]}.json`, 'application/json'); }

function importarBackup(event) {
    const file = event.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) { try { const data = JSON.parse(e.target.result); if (data.db) { db = data.db; salvarDados(); } if (data.CONFIG) { Object.assign(CONFIG, data.CONFIG); localStorage.setItem('enside_config', JSON.stringify(CONFIG)); } alert('âœ… Restaurado!'); location.reload(); } catch(err) { alert('âŒ Erro: ' + err.message); } };
    reader.readAsText(file);
}

function limparDados() { if (confirm('âš ï¸ Apagar TUDO?')) { localStorage.removeItem('enside_system_v10'); localStorage.removeItem('enside_config'); location.reload(); } }

function formatarTamanho(b) { if (b === 0) return '0 B'; const k = 1024, t = ['B', 'KB', 'MB', 'GB'], i = Math.floor(Math.log(b) / Math.log(k)); return Math.round((b / Math.pow(k, i)) * 100) / 100 + ' ' + t[i]; }

function download(content, filename, type) { const b = new Blob([content], { type }), u = URL.createObjectURL(b), a = document.createElement('a'); a.href = u; a.download = filename; a.click(); URL.revokeObjectURL(u); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ABRIR CATEGORIA - MODAL COM ARQUIVOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function abrirCategoria(categoria) {
    const arquivos = db.historico.filter(a => a.categoria === categoria);
    const icon = CATEGORIAS[categoria]?.icon || 'ğŸ“';

    if (arquivos.length === 0) {
        alert(`ğŸ“ Nenhum arquivo em ${categoria}`);
        return;
    }

    // Cria modal dinamicamente
    let modal = document.getElementById('modalCategoria');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalCategoria';
        modal.style.cssText = 'display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:1000;padding:20px;overflow-y:auto;';
        document.body.appendChild(modal);
    }

    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="panel" style="max-width:800px;margin:30px auto;">
            <div class="panel-title" style="display:flex;justify-content:space-between;align-items:center;">
                <span>${icon} ${categoria} (${arquivos.length} arquivos)</span>
                <button class="btn btn-danger btn-small" onclick="fecharModalCategoria()">âœ• Fechar</button>
            </div>

            <div class="btn-group" style="margin-bottom:15px;">
                <button class="btn btn-primary" onclick="abrirPastaArquivo('${categoria}')">ğŸ“‚ Abrir Pasta ${categoria}</button>
                <button class="btn btn-info" onclick="exportarCategoria('${categoria}')">ğŸ“¤ Exportar Lista CSV</button>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Arquivo</th>
                            <th>Tamanho</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${arquivos.map(a => `
                            <tr>
                                <td><strong>${a.nome}</strong></td>
                                <td>${formatarTamanho(a.tamanho || 0)}</td>
                                <td>${new Date(a.dataOrganizacao).toLocaleString('pt-BR')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    // Fecha ao clicar fora
    modal.onclick = function(e) {
        if (e.target === modal) fecharModalCategoria();
    };
}

function fecharModalCategoria() {
    const modal = document.getElementById('modalCategoria');
    if (modal) modal.style.display = 'none';
}

function abrirPastaArquivo(categoria) {
    const pasta = `/Users/andersonenside/${categoria}`;

    // Abre via servidor local
    fetch(`http://localhost:8899/abrir-pasta?caminho=${encodeURIComponent(pasta)}`)
        .then(r => {
            if (!r.ok) throw new Error('Servidor nÃ£o respondeu');
            return r.json();
        })
        .then(data => {
            if (data.success) {
                console.log('ğŸ“‚ Pasta aberta:', pasta);
            }
        })
        .catch(() => {
            alert('Servidor nÃ£o estÃ¡ rodando. Inicie o sistema com iniciar_enside.command');
        });
}

// FUNÃ‡ÃƒO DE SINCRONIZAÃ‡ÃƒO COM SERVIDOR
async function sincronizarComServidor() {
    try {
        const response = await fetch('http://localhost:8899/sincronizar');
        const data = await response.json();
        
        if (data.success) {
            // Atualiza o histÃ³rico com arquivos do servidor
            const arquivosServidor = [];
            for (const [categoria, arquivos] of Object.entries(data.categorias)) {
                arquivos.forEach(arq => {
                    arquivosServidor.push({
                        id: Date.now() + Math.random(),
                        nome: arq.nome,
                        caminho: arq.caminho,
                        tamanho: arq.tamanho,
                        tipo: arq.tipo,
                        categoria: categoria,
                        status: 'organizado',
                        dataOrganizacao: new Date().toISOString(),
                        caminhoFinal: arq.caminho
                    });
                });
            }
            
            // Mescla com histÃ³rico existente (evita duplicados)
            const nomesExistentes = new Set(db.historico.map(a => a.nome));
            arquivosServidor.forEach(arq => {
                if (!nomesExistentes.has(arq.nome)) {
                    db.historico.push(arq);
                }
            });
            
            salvarDados();
            atualizarInterface();
            console.log(`âœ… Sincronizado: ${data.total} arquivos do servidor`);
            return { success: true, total: data.total };
        }
    } catch(e) {
        console.log('Servidor offline:', e.message);
        return { success: false, error: e.message };
    }
}

// Organizar pasta inteira via servidor
async function organizarPastaViaServidor(pastaOrigem) {
    try {
        const response = await fetch('http://localhost:8899/organizar-pasta', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ origem: pastaOrigem })
        });
        const data = await response.json();
        
        if (data.success) {
            alert(`âœ… ${data.movidos} arquivos organizados!\n${data.erros > 0 ? `âš ï¸ ${data.erros} erros` : ''}`);
            await sincronizarComServidor();
            return data;
        } else {
            alert('âŒ Erro: ' + data.error);
        }
    } catch(e) {
        alert('âŒ Servidor offline. Inicie com: python3 /Users/andersonenside/ENSIDE_MASTER/servidor_enside.py');
    }
}

function abrirPastaCategoria(categoria) {
    const caminho = `${CONFIG.pastaDestino}/${categoria}`;
    // Tenta abrir via servidor local primeiro
    fetch(`http://localhost:8899/abrir-pasta?caminho=${encodeURIComponent(caminho)}`)
        .then(r => {
            if (!r.ok) throw new Error('Servidor nÃ£o respondeu');
            return r.json();
        })
        .then(data => {
            if (data.success) {
                console.log('ğŸ“‚ Pasta aberta:', caminho);
            }
        })
        .catch(() => {
            // Fallback: copia caminho e mostra instruÃ§Ã£o
            const caminhoCompleto = caminho.replace('~', '/Users/andersonenside');
            navigator.clipboard.writeText(caminhoCompleto).then(() => {
                alert(`ğŸ“‚ Caminho copiado para Ã¡rea de transferÃªncia!\n\n${caminhoCompleto}\n\nPara abrir:\n1. Abra o Finder\n2. Pressione Cmd+Shift+G\n3. Cole o caminho (Cmd+V)\n4. Pressione Enter`);
            }).catch(() => {
                alert(`ğŸ“‚ Pasta: ${caminhoCompleto}\n\nPara abrir:\n1. Abra o Finder\n2. Pressione Cmd+Shift+G\n3. Digite: ${caminhoCompleto}`);
            });
        });
}

function exportarCategoria(categoria) {
    const arquivos = db.historico.filter(a => a.categoria === categoria);
    const csv = 'Arquivo;Tamanho;Data;Caminho\n' +
        arquivos.map(a => `"${a.nome}";"${formatarTamanho(a.tamanho || 0)}";"${new Date(a.dataOrganizacao).toLocaleString('pt-BR')}";"${a.caminho || ''}"`).join('\n');
    download(csv, `${categoria}_arquivos.csv`, 'text/csv');
}

function atualizarInterface() {
    document.getElementById('statPendentes').textContent = db.pendentes.length;
    document.getElementById('statOrganizados').textContent = db.historico.length;
    document.getElementById('statTamanho').textContent = formatarTamanho(db.pendentes.reduce((a, x) => a + (x.tamanho || 0), 0));
    const contagem = {}; db.historico.forEach(a => contagem[a.categoria] = (contagem[a.categoria] || 0) + 1);
    document.getElementById('categoriasGrid').innerHTML = Object.entries(CATEGORIAS).map(([c, i]) => `<div class="categoria-item" onclick="abrirCategoria('${c}')" style="cursor:pointer;"><span class="name">${i.icon} ${c}</span><span class="count">${contagem[c] || 0}</span></div>`).join('');
    document.getElementById('configCategorias').innerHTML = Object.entries(CATEGORIAS).map(([c, i]) => `<div class="categoria-item"><span class="name">${i.icon} ${c}</span><span style="font-size:0.75em;color:rgba(255,255,255,0.5);">${i.extensoes.join(', ') || 'manual'}</span></div>`).join('');
    const ht = document.getElementById('historicoTable');
    if (db.historico.length === 0) ht.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:30px;">Nenhum</td></tr>';
    else ht.innerHTML = db.historico.slice(0, 50).map(a => `<tr><td>${a.nome}</td><td>${CATEGORIAS[a.categoria]?.icon || 'ğŸ“'} ${a.categoria}</td><td>${new Date(a.dataOrganizacao).toLocaleString('pt-BR')}</td><td><span style="background:var(--success);padding:3px 8px;border-radius:8px;font-size:0.8em;">âœ…</span></td></tr>`).join('');
    renderFretes(); renderListas(); renderConhecimentos(); atualizarAgentBar(); mostrarTriagem();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTATOS - PLANILHA UNIFICADA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function abrirModalContato(id = null) {
    document.getElementById('modalContato').style.display = 'block';
    document.getElementById('contatoEditId').value = '';
    ['contatoNome', 'contatoWhatsapp', 'contatoCidade', 'contatoEmail', 'contatoEmpresa', 'contatoObs'].forEach(f => document.getElementById(f).value = '');
    document.getElementById('contatoTipo').value = 'indefinido';

    if (id) {
        const contato = db.contatosUnificados.find(c => c.id === id);
        if (contato) {
            document.getElementById('contatoEditId').value = id;
            document.getElementById('contatoNome').value = contato.nome || '';
            document.getElementById('contatoWhatsapp').value = contato.whatsapp || '';
            document.getElementById('contatoTipo').value = contato.tipo || 'indefinido';
            document.getElementById('contatoCidade').value = contato.cidade || '';
            document.getElementById('contatoEmail').value = contato.email || '';
            document.getElementById('contatoEmpresa').value = contato.empresa || '';
            document.getElementById('contatoObs').value = contato.obs || '';
        }
    }
}

function fecharModalContato() {
    document.getElementById('modalContato').style.display = 'none';
}

function salvarContato() {
    const nome = document.getElementById('contatoNome').value.trim();
    const whatsapp = document.getElementById('contatoWhatsapp').value.trim();

    if (!nome || !whatsapp) {
        alert('âŒ Nome e WhatsApp sÃ£o obrigatÃ³rios!');
        return;
    }

    const contato = {
        id: document.getElementById('contatoEditId').value || Date.now(),
        nome: nome,
        whatsapp: whatsapp,
        tipo: document.getElementById('contatoTipo').value,
        cidade: document.getElementById('contatoCidade').value.trim(),
        email: document.getElementById('contatoEmail').value.trim(),
        empresa: document.getElementById('contatoEmpresa').value.trim(),
        obs: document.getElementById('contatoObs').value.trim(),
        dataCadastro: new Date().toISOString()
    };

    const editId = document.getElementById('contatoEditId').value;
    if (editId) {
        const idx = db.contatosUnificados.findIndex(c => c.id == editId);
        if (idx >= 0) db.contatosUnificados[idx] = contato;
    } else {
        db.contatosUnificados.push(contato);
        ganharXP(5);
    }

    sincronizarContatosAntigos();
    salvarDados();
    fecharModalContato();
    alert('âœ… Contato salvo!');
}

function sincronizarContatosAntigos() {
    // Sincroniza a lista unificada com as listas antigas para manter compatibilidade
    db.contatos.motoristas = db.contatosUnificados.filter(c => c.tipo === 'motorista').map(c => ({ id: c.id, nome: c.nome, whatsapp: c.whatsapp }));
    db.contatos.fornecedores = db.contatosUnificados.filter(c => c.tipo === 'fornecedor').map(c => ({ id: c.id, nome: c.nome, whatsapp: c.whatsapp }));
    db.contatos.clientes = db.contatosUnificados.filter(c => c.tipo === 'cliente').map(c => ({ id: c.id, nome: c.nome, whatsapp: c.whatsapp }));
}

function migrarContatosAntigos() {
    // Migra contatos das listas antigas para a lista unificada
    if (db.contatosUnificados.length === 0) {
        db.contatos.motoristas.forEach(c => {
            if (!db.contatosUnificados.find(x => x.whatsapp === c.whatsapp)) {
                db.contatosUnificados.push({ ...c, id: c.id || Date.now() + Math.random(), tipo: 'motorista', dataCadastro: new Date().toISOString() });
            }
        });
        db.contatos.fornecedores.forEach(c => {
            if (!db.contatosUnificados.find(x => x.whatsapp === c.whatsapp)) {
                db.contatosUnificados.push({ ...c, id: c.id || Date.now() + Math.random(), tipo: 'fornecedor', dataCadastro: new Date().toISOString() });
            }
        });
        db.contatos.clientes.forEach(c => {
            if (!db.contatosUnificados.find(x => x.whatsapp === c.whatsapp)) {
                db.contatosUnificados.push({ ...c, id: c.id || Date.now() + Math.random(), tipo: 'cliente', dataCadastro: new Date().toISOString() });
            }
        });
    }
}

function filtrarContatos() {
    renderContatosTable();
}

function renderContatosTable() {
    const filtro = (document.getElementById('filtroContatos')?.value || '').toLowerCase();
    const tipo = document.getElementById('filtroTipoContato')?.value || '';

    let contatos = db.contatosUnificados.filter(c => {
        const matchFiltro = !filtro ||
            (c.nome && c.nome.toLowerCase().includes(filtro)) ||
            (c.whatsapp && c.whatsapp.includes(filtro)) ||
            (c.cidade && c.cidade.toLowerCase().includes(filtro));
        const matchTipo = !tipo || c.tipo === tipo;
        return matchFiltro && matchTipo;
    });

    // Atualiza estatÃ­sticas
    const motoristas = db.contatosUnificados.filter(c => c.tipo === 'motorista').length;
    const fornecedores = db.contatosUnificados.filter(c => c.tipo === 'fornecedor').length;
    const representantes = db.contatosUnificados.filter(c => c.tipo === 'representante').length;
    const clientes = db.contatosUnificados.filter(c => c.tipo === 'cliente').length;

    document.getElementById('totalMotoristas').textContent = motoristas;
    document.getElementById('totalFornecedores').textContent = fornecedores;
    document.getElementById('totalRepresentantes').textContent = representantes;
    document.getElementById('totalClientes').textContent = clientes;
    document.getElementById('totalContatos').textContent = db.contatosUnificados.length;
    document.getElementById('contatosFiltrados').textContent = contatos.length;
    document.getElementById('qtdNaoClassificados').textContent = db.contatosUnificados.filter(c => c.tipo === 'indefinido' || !c.tipo).length;

    const tbody = document.getElementById('contatosTable');
    if (contatos.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:30px;">Nenhum contato encontrado</td></tr>';
        return;
    }

    tbody.innerHTML = contatos.map(c => `
        <tr>
            <td><strong>${c.nome || '-'}</strong>${c.empresa ? `<br><span style="font-size:0.85em;color:rgba(255,255,255,0.6);">${c.empresa}</span>` : ''}</td>
            <td>
                <a href="https://wa.me/${(c.whatsapp || '').replace(/\D/g, '')}" target="_blank" style="color:var(--whatsapp);">
                    ğŸ“± ${c.whatsapp || '-'}
                </a>
            </td>
            <td><span class="tipo-badge ${c.tipo || 'indefinido'}">${getTipoIcon(c.tipo)} ${getTipoLabel(c.tipo)}</span></td>
            <td>${c.cidade || '-'}</td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;">${c.obs || '-'}</td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-small btn-primary" onclick="abrirModalContato(${c.id})">âœï¸</button>
                    <button class="btn btn-small btn-whatsapp" onclick="window.open('https://wa.me/${(c.whatsapp || '').replace(/\D/g, '')}','_blank')">ğŸ’¬</button>
                    <button class="btn btn-small btn-danger" onclick="excluirContato(${c.id})">ğŸ—‘ï¸</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function getTipoIcon(tipo) {
    const icons = { motorista: 'ğŸšš', fornecedor: 'ğŸ­', cliente: 'ğŸ‘¥', cartorio: 'ğŸ›ï¸', particular: 'ğŸ‘¤', indefinido: 'â“' };
    return icons[tipo] || 'â“';
}

function getTipoLabel(tipo) {
    const labels = { motorista: 'Motorista', fornecedor: 'Fornecedor', cliente: 'Cliente', cartorio: 'CartÃ³rio', particular: 'Particular', indefinido: 'NÃ£o classificado' };
    return labels[tipo] || 'NÃ£o classificado';
}

function excluirContato(id) {
    if (confirm('Excluir este contato?')) {
        db.contatosUnificados = db.contatosUnificados.filter(c => c.id !== id);
        sincronizarContatosAntigos();
        salvarDados();
    }
}

function importarContatosArquivo(event) {
    const file = event.target.files[0];
    if (!file) return;

    const fileName = file.name.toLowerCase();
    
    // Suporte a arquivos Excel (.xlsx/.xls)
    if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                let importados = 0;
                let duplicados = 0;
                
                // Pular cabeÃ§alho (primeira linha)
                for (let i = 1; i < jsonData.length; i++) {
                    const cols = jsonData[i];
                    if (!cols || cols.length < 2) continue;
                    
                    const contato = {
                        id: Date.now() + Math.random(),
                        nome: String(cols[0] || '').trim(),
                        whatsapp: String(cols[1] || '').trim(),
                        tipo: detectarTipoContato(String(cols[2] || cols[0] || '')),
                        cidade: String(cols[3] || '').trim(),
                        empresa: String(cols[4] || '').trim(),
                        obs: String(cols[5] || '').trim(),
                        dataCadastro: new Date().toISOString()
                    };
                    
                    if (contato.nome && contato.whatsapp) {
                        if (!db.contatosUnificados.find(c => c.whatsapp === contato.whatsapp)) {
                            db.contatosUnificados.push(contato);
                            importados++;
                        } else {
                            duplicados++;
                        }
                    }
                }
                
                salvarDados();
                renderContatosUnificados();
                atualizarEstatisticas();
                alert(`âœ… ImportaÃ§Ã£o Excel concluÃ­da!\n\nğŸ“¥ ${importados} contatos importados\nâš ï¸ ${duplicados} duplicados ignorados`);
            } catch (err) {
                console.error('Erro ao ler Excel:', err);
                alert('âŒ Erro ao ler arquivo Excel: ' + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const conteudo = e.target.result;
            let importados = 0;
            let duplicados = 0;

            if (fileName.endsWith('.csv') || fileName.endsWith('.txt')) {
                const linhas = conteudo.split('\n');
                const cabecalho = linhas[0].toLowerCase();

                linhas.slice(1).forEach(linha => {
                    if (!linha.trim()) return;
                    const cols = linha.split(/[;,]/).map(c => c.replace(/"/g, '').trim());

                    if (cols.length >= 2) {
                        const contato = {
                            id: Date.now() + Math.random(),
                            nome: cols[0] || '',
                            whatsapp: cols[1] || '',
                            tipo: detectarTipoContato(cols[2] || cols[0] || ''),
                            cidade: cols[3] || '',
                            empresa: cols[4] || '',
                            obs: cols[5] || '',
                            dataCadastro: new Date().toISOString()
                        };

                        if (contato.nome && contato.whatsapp) {
                            // Evitar duplicados
                            if (!db.contatosUnificados.find(c => c.whatsapp === contato.whatsapp)) {
                                db.contatosUnificados.push(contato);
                                importados++;
                            } else {
                                duplicados++;
                            }
                        }
                    }
                });
            } else if (fileName.endsWith('.vcf')) {
                // Importar VCF
                const vcards = conteudo.split('END:VCARD');
                vcards.forEach(vcard => {
                    if (!vcard.includes('BEGIN:VCARD')) return;
                    const nome = (vcard.match(/FN:(.+)/i) || [])[1]?.trim() || '';
                    const tel = (vcard.match(/TEL[^:]*:(.+)/i) || [])[1]?.replace(/\D/g, '') || '';
                    
                    if (nome && tel) {
                        if (!db.contatosUnificados.find(c => c.whatsapp === tel)) {
                            db.contatosUnificados.push({
                                id: Date.now() + Math.random(),
                                nome: nome,
                                whatsapp: tel,
                                tipo: 'indefinido',
                                dataCadastro: new Date().toISOString()
                            });
                            importados++;
                        } else {
                            duplicados++;
                        }
                    }
                });
            }

            sincronizarContatosAntigos();
            renderContatosTable();
            ganharXP(importados * 2);
            salvarDados();
            
            let msg = `âœ… ${importados} contatos importados!`;
            if (duplicados > 0) msg += `\nâš ï¸ ${duplicados} duplicados ignorados.`;
            alert(msg);

        } catch(err) {
            alert('âŒ Erro ao importar: ' + err.message);
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function detectarTipoContato(texto) {
    const t = (texto || '').toLowerCase();
    
    // Motoristas / Freteiros
    if (t.includes('motorista') || t.includes('frete') || t.includes('caminhÃ£o') || t.includes('caminhao') || 
        t.includes('transp') || t.includes('carreta') || t.includes('bitrem') || t.includes('truck') ||
        t.includes('entrega') || t.includes('carga') || t.includes('rota') || t.includes('viagem') ||
        t.match(/\bls\b/) || t.includes('agenciador') || t.includes('carreto') || t.includes('mudanca') ||
        t.includes('mudanÃ§a') || t.includes('reboque') || t.includes('guincho')) return 'motorista';
    
    // Fornecedores / Serrarias / Madeireiras
    if (t.includes('fornece') || t.includes('madeira') || t.includes('serraria') || t.includes('fabrica') ||
        t.includes('eucalipto') || t.includes('pinus') || t.includes('madeireira') || t.includes('tora') ||
        t.includes('prancha') || t.includes('tÃ¡bua') || t.includes('tabua') || t.includes('viga') ||
        t.includes('caibro') || t.includes('ripa') || t.includes('compensado') || t.includes('mdf') ||
        t.includes('osb') || t.includes('chapa') || t.includes('palete') || t.includes('pallet') ||
        t.includes('vendedor') || t.includes('representante') || t.includes('distribui') ||
        t.includes('deposito') || t.includes('depÃ³sito') || t.includes('atacado') || t.includes('industria') ||
        t.includes('indÃºstria') || t.includes('produtor') || t.includes('exporta')) return 'fornecedor';
    
    // Clientes
    if (t.includes('cliente') || t.includes('compra') || t.includes('venda') || t.includes('obra') ||
        t.includes('constru') || t.includes('escoramento') || t.includes('forma') || t.includes('carpint') ||
        t.includes('marcenaria') || t.includes('moveis') || t.includes('mÃ³veis') || t.includes('consumidor') ||
        t.includes('comprador') || t.includes('pedido') || t.includes('encomenda')) return 'cliente';
    
    // CartÃ³rios
    if (t.includes('cartÃ³rio') || t.includes('cartorio') || t.includes('registro') || t.includes('tabelion') ||
        t.includes('notas') || t.includes('escritura')) return 'cartorio';
    
    // Bancos / Financeiro
    if (t.includes('banco') || t.includes('caixa') || t.includes('bradesco') || t.includes('itau') ||
        t.includes('itaÃº') || t.includes('santander') || t.includes('sicoob') || t.includes('sicredi') ||
        t.includes('financ') || t.includes('credito') || t.includes('crÃ©dito') || t.includes('emprestimo') ||
        t.includes('emprÃ©stimo') || t.includes('gerente') || t.includes('conta')) return 'banco';
    
    // Contadores / JurÃ­dico
    if (t.includes('contador') || t.includes('contabil') || t.includes('contÃ¡bil') || t.includes('escritorio') ||
        t.includes('escritÃ³rio') || t.includes('advogado') || t.includes('juridico') || t.includes('jurÃ­dico') ||
        t.includes('advocacia') || t.includes('fiscal') || t.includes('tribut')) return 'contador';
    
    // Governo / Ã“rgÃ£os PÃºblicos
    if (t.includes('prefeitura') || t.includes('ibama') || t.includes('receita') || t.includes('federal') ||
        t.includes('estadual') || t.includes('municipal') || t.includes('secretaria') || t.includes('detran') ||
        t.includes('inss') || t.includes('sefaz') || t.includes('governo')) return 'governo';
    
    // Seguros
    if (t.includes('seguro') || t.includes('seguradora') || t.includes('corretor') || t.includes('apolice') ||
        t.includes('apÃ³lice') || t.includes('sinistro') || t.includes('porto seguro') || t.includes('mapfre') ||
        t.includes('tokio') || t.includes('allianz') || t.includes('sulamerica') || t.includes('sul america')) return 'seguro';
    
    // MecÃ¢nica / Oficina
    if (t.includes('mecanica') || t.includes('mecÃ¢nica') || t.includes('oficina') || t.includes('borracharia') ||
        t.includes('pneu') || t.includes('funilaria') || t.includes('eletrica') || t.includes('elÃ©trica') ||
        t.includes('retifica') || t.includes('peÃ§as') || t.includes('pecas') || t.includes('autopeca')) return 'mecanica';
    
    // Posto / CombustÃ­vel
    if (t.includes('posto') || t.includes('combustivel') || t.includes('combustÃ­vel') || t.includes('gasolina') ||
        t.includes('diesel') || t.includes('etanol') || t.includes('abastec') || t.includes('shell') ||
        t.includes('ipiranga') || t.includes('petrobras') || t.includes('br distribuidora')) return 'posto';
    
    // FuncionÃ¡rios
    if (t.includes('funcionario') || t.includes('funcionÃ¡rio') || t.includes('empregado') || t.includes('colaborador') ||
        t.includes('ajudante') || t.includes('auxiliar') || t.includes('operador') || t.includes('encarregado') ||
        t.includes('supervisor') || t.includes('gerente') || t.includes('diretor')) return 'funcionario';
    
    // FamÃ­lia / Pessoal
    if (t.includes('esposa') || t.includes('marido') || t.includes('filho') || t.includes('filha') ||
        t.includes('pai') || t.includes('mae') || t.includes('mÃ£e') || t.includes('irmÃ£o') || t.includes('irmao') ||
        t.includes('irmÃ£') || t.includes('irma') || t.includes('tio') || t.includes('tia') ||
        t.includes('primo') || t.includes('prima') || t.includes('sogro') || t.includes('sogra') ||
        t.includes('cunhado') || t.includes('cunhada') || t.includes('familia') || t.includes('famÃ­lia')) return 'familia';
    
    // Parceiros / Investidores
    if (t.includes('parceiro') || t.includes('investidor') || t.includes('socio') || t.includes('sÃ³cio') ||
        t.includes('investimento') || t.includes('negocio') || t.includes('negÃ³cio')) return 'parceiro';
    
    // ServiÃ§os Gerais
    if (t.includes('eletricista') || t.includes('encanador') || t.includes('pedreiro') || t.includes('pintor') ||
        t.includes('serralheiro') || t.includes('soldador') || t.includes('tecnico') || t.includes('tÃ©cnico') ||
        t.includes('instalador') || t.includes('montador') || t.includes('manutencao') || t.includes('manutenÃ§Ã£o')) return 'servicos';
    
    // Tecnologia / TI
    if (t.includes('ti ') || t.includes(' ti') || t.includes('tecnologia') || t.includes('sistema') ||
        t.includes('software') || t.includes('programador') || t.includes('desenvolvedor') || t.includes('suporte') ||
        t.includes('informatica') || t.includes('informÃ¡tica') || t.includes('computador')) return 'tecnologia';
    
    // SaÃºde
    if (t.includes('medico') || t.includes('mÃ©dico') || t.includes('doutor') || t.includes('dra') ||
        t.includes('dentista') || t.includes('hospital') || t.includes('clinica') || t.includes('clÃ­nica') ||
        t.includes('farmacia') || t.includes('farmÃ¡cia') || t.includes('laboratorio') || t.includes('laboratÃ³rio') ||
        t.includes('enfermeiro') || t.includes('saude') || t.includes('saÃºde')) return 'saude';
    
    return 'indefinido';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GOOGLE SHEETS - INTEGRAÃ‡ÃƒO FUNCIONAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const SHEETS_CONFIG = {
    spreadsheetId: '1NJRMB-pgEFS0MjtKrh2mhqPN6apkDwwJMAPOCejLX8Y',
    // Mapeamento das colunas do Google Sheets
    colunas: {
        id: 0,           // A - ID
        nome: 1,         // B - Nome
        endereco: 2,     // C - EndereÃ§o
        cidade: 3,       // D - Cidade
        telefone: 4,     // E - Telefone (ESTE Ã‰ O WHATSAPP!)
        data: 5,         // F - Data
        obs: 6           // G - ObservaÃ§Ãµes
    }
};

async function importarGoogleSheets() {
    const status = document.getElementById('statusImportacao') || document.createElement('div');
    status.id = 'statusImportacao';
    status.className = 'alert info';
    status.innerHTML = 'ğŸ”„ Conectando ao Google Sheets...';
    
    // Adiciona status na pÃ¡gina se nÃ£o existir
    const container = document.querySelector('.panel') || document.body;
    if (!document.getElementById('statusImportacao')) {
        container.insertBefore(status, container.firstChild);
    }
    
    try {
        // URL pÃºblica do Google Sheets em formato CSV
        const url = `https://docs.google.com/spreadsheets/d/${SHEETS_CONFIG.spreadsheetId}/export?format=csv&gid=0`;
        
        const response = await fetch(url);
        if (!response.ok) throw new Error('Erro ao acessar planilha');
        
        const csvText = await response.text();
        const linhas = csvText.split('\n').filter(l => l.trim());
        
        status.innerHTML = `ğŸ”„ Processando ${linhas.length} linhas...`;
        
        let importados = 0;
        let atualizados = 0;
        
        // Pula cabeÃ§alho (primeira linha)
        for (let i = 1; i < linhas.length; i++) {
            const cols = parseCSVLine(linhas[i]);
            
            if (cols.length >= 5) {
                const contato = {
                    id: cols[SHEETS_CONFIG.colunas.id] || Date.now() + i,
                    nome: cols[SHEETS_CONFIG.colunas.nome] || '',
                    endereco: cols[SHEETS_CONFIG.colunas.endereco] || '',
                    cidade: cols[SHEETS_CONFIG.colunas.cidade] || '',
                    whatsapp: formatarTelefone(cols[SHEETS_CONFIG.colunas.telefone] || ''),
                    data: cols[SHEETS_CONFIG.colunas.data] || '',
                    obs: cols[SHEETS_CONFIG.colunas.obs] || '',
                    tipo: 'indefinido',
                    dataCadastro: new Date().toISOString()
                };
                
                // SÃ³ adiciona se tiver nome ou telefone vÃ¡lido
                if (contato.nome || contato.whatsapp) {
                    const existente = db.contatosUnificados.findIndex(c => 
                        c.id == contato.id || 
                        (c.whatsapp && c.whatsapp === contato.whatsapp)
                    );
                    
                    if (existente >= 0) {
                        db.contatosUnificados[existente] = { ...db.contatosUnificados[existente], ...contato };
                        atualizados++;
                    } else {
                        db.contatosUnificados.push(contato);
                        importados++;
                    }
                }
            }
        }
        
        sincronizarContatosAntigos();
        salvarDados();
        renderContatosTable();
        ganharXP(importados * 2);
        
        status.className = 'alert success';
        status.innerHTML = `âœ… ImportaÃ§Ã£o concluÃ­da!<br>ğŸ“Š ${importados} novos contatos | ${atualizados} atualizados | Total: ${db.contatosUnificados.length}`;
        
    } catch(err) {
        status.className = 'alert danger';
        status.innerHTML = `âŒ Erro: ${err.message}<br><br>ğŸ’¡ Dica: Verifique se a planilha estÃ¡ pÃºblica ou use a importaÃ§Ã£o por CSV.`;
    }
}

function formatarTelefone(tel) {
    if (!tel) return '';
    // Remove tudo que nÃ£o for nÃºmero
    let numeros = tel.toString().replace(/\D/g, '');
    // Se comeÃ§ar com 55 e tiver mais de 11 dÃ­gitos, remove o 55
    if (numeros.startsWith('55') && numeros.length > 11) {
        numeros = numeros.substring(2);
    }
    // Formata como (XX) XXXXX-XXXX
    if (numeros.length === 11) {
        return `(${numeros.slice(0,2)}) ${numeros.slice(2,7)}-${numeros.slice(7)}`;
    } else if (numeros.length === 10) {
        return `(${numeros.slice(0,2)}) ${numeros.slice(2,6)}-${numeros.slice(6)}`;
    }
    return numeros;
}

function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    
    for (let i = 0; i < line.length; i++) {
        const char = line[i];
        
        if (char === '"') {
            inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
            result.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    result.push(current.trim());
    return result;
}

function limparDadosContatos() {
    if (confirm('âš ï¸ ATENÃ‡ÃƒO: Isso vai apagar TODOS os contatos!\n\nTem certeza?')) {
        db.contatosUnificados = [];
        db.contatos = { motoristas: [], fornecedores: [], clientes: [] };
        salvarDados();
        renderContatosTable();
        alert('âœ… Todos os contatos foram removidos.');
    }
}

function autoClassificarContatos() {
    const status = document.getElementById('statusImportacao') || document.createElement('div');
    status.id = 'statusImportacao';
    status.className = 'alert info';
    status.innerHTML = 'ğŸ§  Reclassificando contatos...';
    
    const container = document.querySelector('.panel') || document.body;
    if (!document.getElementById('statusImportacao')) {
        container.insertBefore(status, container.firstChild);
    }
    
    let classificados = 0;
    let reclassificados = 0;
    
    // Primeiro, reclassifica fornecedores que deveriam ser representantes
    db.contatosUnificados.forEach(c => {
        const texto = `${c.nome || ''} ${c.endereco || ''} ${c.cidade || ''} ${c.obs || ''}`.toLowerCase();
        
        // Se Ã© fornecedor e tem palavras de madeira, muda para representante
        if (c.tipo === 'fornecedor' && texto.match(/(madeira|serraria|pinus|eucalipto|mdf|compensado|madeireira|laminado|chapa|prancha|tabua|mourÃ£o|mourao|estaca|poste|lenha|carvÃ£o|carvao|tratamento|autoclave|representante|vendedor)/)) {
            c.tipo = 'representante';
            reclassificados++;
        }
    });
    
    // Depois, classifica os indefinidos
    db.contatosUnificados.forEach(c => {
        if (c.tipo === 'indefinido' || !c.tipo) {
            const texto = `${c.nome || ''} ${c.endereco || ''} ${c.cidade || ''} ${c.obs || ''}`.toLowerCase();
            
            // Palavras-chave para motoristas
            if (texto.match(/(motorista|frete|caminh|transp|carreta|truck|bitrem|rodovia|agenciador|carreteiro)/)) {
                c.tipo = 'motorista';
                classificados++;
            }
            // Palavras-chave para REPRESENTANTES (madeiras)
            else if (texto.match(/(madeira|serraria|pinus|eucalipto|mdf|compensado|madeireira|laminado|chapa|prancha|tabua|mourÃ£o|mourao|estaca|poste|lenha|carvÃ£o|carvao|tratamento|autoclave|representante|vendedor)/)) {
                c.tipo = 'representante';
                classificados++;
            }
            // Palavras-chave para fornecedores (sem madeiras)
            else if (texto.match(/(fornece|fabrica|industria|deposito|material|distribui|atacado|produtor|telha|tijolo|cimento|areia|pedra|ferro|aÃ§o)/)) {
                c.tipo = 'fornecedor';
                classificados++;
            }
            // Palavras-chave para clientes
            else if (texto.match(/(cliente|compra|venda|loja|comercio|mercado|obra|constru|escoramento)/)) {
                c.tipo = 'cliente';
                classificados++;
            }
            // Palavras-chave para cartÃ³rios
            else if (texto.match(/(cartorio|cartÃ³rio|registro|tabeliao|tabeliÃ£o|notas|escritura|certidao|certidÃ£o)/)) {
                c.tipo = 'cartorio';
                classificados++;
            }
            // Palavras-chave para bancos
            else if (texto.match(/(banco|financ|credito|crÃ©dito|emprestimo|emprÃ©stimo|investidor|bradesco|itau|itaÃº|santander|sicredi|nubank|topazio)/)) {
                c.tipo = 'banco';
                classificados++;
            }
            // Palavras-chave para serviÃ§os
            else if (texto.match(/(advogado|contador|contabil|contÃ¡bil|dentista|medico|mÃ©dico|eletricista|pedreiro|pintor|mecanico|mecÃ¢nico|seguranca|seguranÃ§a|tecnico|tÃ©cnico|operador|operadora|agencia|agÃªncia|consultoria|despachante)/)) {
                c.tipo = 'servico';
                classificados++;
            }
            // Palavras-chave para particulares
            else if (texto.match(/(particular|pessoal|amigo|primo|tio|tia|sobrinho|cunhado|vizinho|parente|familia|famÃ­lia)/)) {
                c.tipo = 'particular';
                classificados++;
            }
        }
    });
    
    sincronizarContatosAntigos();
    salvarDados();
    renderContatosTable();
    ganharXP(classificados + reclassificados);
    
    status.className = 'alert success';
    status.innerHTML = `âœ… ${classificados} novos classificados + ${reclassificados} reclassificados como Representante!`;
}

function exportarTodosContatos() {
    const csv = 'Nome;WhatsApp;Tipo;Cidade;Empresa;ObservaÃ§Ãµes\n' +
        db.contatosUnificados.map(c =>
            `"${c.nome || ''}";"${c.whatsapp || ''}";"${c.tipo || ''}";"${c.cidade || ''}";"${c.empresa || ''}";"${c.obs || ''}"`
        ).join('\n');
    download(csv, 'contatos_enside.csv', 'text/csv');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOVAS FUNCOES v10.1 - CALCULADORA DE FRETE + IMPORTADOR UNIVERSAL + 45 CATEGORIAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// 45 CATEGORIAS COMPLETAS
const CATEGORIAS_COMPLETAS = {
    documentos: { icon: 'ğŸ“„', color: '#3b82f6', ext: ['pdf','doc','docx','odt','rtf','txt','pages'] },
    planilhas: { icon: 'ğŸ“Š', color: '#10b981', ext: ['xls','xlsx','ods','csv','numbers','xlsm'] },
    imagens: { icon: 'ğŸ–¼ï¸', color: '#ec4899', ext: ['jpg','jpeg','png','gif','bmp','webp','svg','ico','tiff','heic','heif','raw','jp2'] },
    videos: { icon: 'ğŸ¬', color: '#ef4444', ext: ['mp4','avi','mov','mkv','wmv','flv','webm','m4v','3gp'] },
    audio: { icon: 'ğŸµ', color: '#a855f7', ext: ['mp3','wav','m4a','flac','aac','ogg','wma'] },
    codigo: { icon: 'ğŸ’»', color: '#8b5cf6', ext: ['py','js','html','css','json','xml','sh','ts','jsx','tsx','php','java','c','cpp'] },
    compactado: { icon: 'ğŸ“¦', color: '#f97316', ext: ['zip','rar','7z','tar','gz','bz2'] },
    apresentacoes: { icon: 'ğŸ“½ï¸', color: '#06b6d4', ext: ['ppt','pptx','key','odp'] },
    ebooks: { icon: 'ğŸ“š', color: '#84cc16', ext: ['epub','mobi','azw'] },
    banco_dados: { icon: 'ğŸ—„ï¸', color: '#64748b', ext: ['db','sqlite','mdb'] },
    backup: { icon: 'ğŸ’¾', color: '#f59e0b', ext: ['bak','backup','old'] },
    contatos: { icon: 'ğŸ“‡', color: '#14b8a6', ext: ['vcf','vcard'] },
    motoristas: { icon: 'ğŸšš', color: '#0ea5e9', ext: [] },
    fornecedores: { icon: 'ğŸ­', color: '#f59e0b', ext: [] },
    clientes: { icon: 'ğŸ‘¥', color: '#22c55e', ext: [] },
    funcionarios: { icon: 'ğŸ‘”', color: '#6366f1', ext: [] },
    financeiro: { icon: 'ğŸ’°', color: '#eab308', ext: [] },
    notas_fiscais: { icon: 'ğŸ§¾', color: '#84cc16', ext: [] },
    boletos: { icon: 'ğŸ“‘', color: '#f97316', ext: [] },
    recibos: { icon: 'ğŸ§¾', color: '#22d3ee', ext: [] },
    orcamentos: { icon: 'ğŸ’µ', color: '#a3e635', ext: [] },
    contratos: { icon: 'ğŸ“', color: '#8b5cf6', ext: [] },
    juridico: { icon: 'âš–ï¸', color: '#64748b', ext: [] },
    certidoes: { icon: 'ğŸ“œ', color: '#78716c', ext: [] },
    logistica: { icon: 'ğŸš›', color: '#10b981', ext: [] },
    fretes: { icon: 'ğŸ“¦', color: '#14b8a6', ext: [] },
    rotas: { icon: 'ğŸ—ºï¸', color: '#06b6d4', ext: [] },
    veiculos: { icon: 'ğŸš—', color: '#3b82f6', ext: [] },
    madeira: { icon: 'ğŸªµ', color: '#059669', ext: [] },
    produtos: { icon: 'ğŸ“¦', color: '#f472b6', ext: [] },
    estoque: { icon: 'ğŸ“‹', color: '#fbbf24', ext: [] },
    documentos_pessoais: { icon: 'ğŸªª', color: '#a78bfa', ext: [] },
    curriculos: { icon: 'ğŸ“„', color: '#2dd4bf', ext: [] },
    marketing: { icon: 'ğŸ“¢', color: '#f43f5e', ext: [] },
    logos: { icon: 'ğŸ¨', color: '#e879f9', ext: [] },
    templates: { icon: 'ğŸ“', color: '#38bdf8', ext: [] },
    projetos: { icon: 'ğŸ“', color: '#4ade80', ext: [] },
    relatorios: { icon: 'ğŸ“Š', color: '#818cf8', ext: [] },
    emails: { icon: 'ğŸ“§', color: '#fb923c', ext: ['eml','msg'] },
    whatsapp: { icon: 'ğŸ“±', color: '#25D366', ext: [] },
    screenshots: { icon: 'ğŸ“¸', color: '#f472b6', ext: [] },
    gravacoes: { icon: 'ğŸ™ï¸', color: '#c084fc', ext: ['webm','rec'] },
    configuracoes: { icon: 'âš™ï¸', color: '#94a3b8', ext: ['ini','cfg','conf','plist'] },
    logs: { icon: 'ğŸ“‹', color: '#a1a1aa', ext: ['log'] },
    outros: { icon: 'ğŸ“', color: '#6b7280', ext: [] }
};

// CALCULADORA DE FRETE PARA MADEIRA
function calcularFreteMadeira(volume, tipoMadeira, distanciaKm, valorPorKmTon) {
    const pesos = { seca: 500, verde: 1000, murchada: 750 };
    const pesoTotal = (volume * (pesos[tipoMadeira] || 750)) / 1000;
    const valorTotal = distanciaKm * pesoTotal * valorPorKmTon;
    return {
        volume,
        tipoMadeira,
        pesoTotalTon: pesoTotal.toFixed(2),
        distanciaKm,
        valorPorKmTon,
        valorTotal: valorTotal.toFixed(2),
        valorTotalFormatado: `R$ ${valorTotal.toFixed(2).replace('.', ',')}`
    };
}

// Interface para calcular frete
function mostrarCalculadoraFrete() {
    const html = `
        <div style="padding:20px;">
            <h3 style="color:var(--success);margin-bottom:20px;">ğŸšš Calculadora de Frete - Madeira</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Volume (mÂ³)</label>
                    <input type="number" id="freteVolume" placeholder="Ex: 30" step="0.1">
                </div>
                <div class="form-group">
                    <label>Tipo de Madeira</label>
                    <select id="freteTipoMadeira">
                        <option value="seca">Madeira Seca (500 kg/mÂ³)</option>
                        <option value="murchada">Madeira Murchada (750 kg/mÂ³)</option>
                        <option value="verde">Madeira Verde (1000 kg/mÂ³)</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>DistÃ¢ncia (km)</label>
                    <input type="number" id="freteDistancia" placeholder="Ex: 350" step="1">
                </div>
                <div class="form-group">
                    <label>Valor por km/ton (R$)</label>
                    <input type="number" id="freteValorKmTon" placeholder="Ex: 0.35" step="0.01" value="0.35">
                </div>
            </div>
            <button class="btn btn-success" onclick="executarCalculoFrete()">ğŸ“Š Calcular Frete</button>
            <div id="resultadoCalculoFrete" style="margin-top:20px;"></div>
        </div>
    `;

    // Criar modal se nÃ£o existir
    let modal = document.getElementById('modalCalculadora');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalCalculadora';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `<div style="background:var(--dark);border-radius:16px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto;border:2px solid var(--success);">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:15px 20px;border-bottom:1px solid rgba(255,255,255,0.1);">
                <span style="font-weight:700;">Calculadora de Frete</span>
                <button onclick="document.getElementById('modalCalculadora').remove()" style="background:none;border:none;color:#fff;font-size:1.5em;cursor:pointer;">&times;</button>
            </div>
            <div id="conteudoCalculadora">${html}</div>
        </div>`;
        document.body.appendChild(modal);
    } else {
        document.getElementById('conteudoCalculadora').innerHTML = html;
        modal.style.display = 'flex';
    }
}

function executarCalculoFrete() {
    const volume = parseFloat(document.getElementById('freteVolume').value) || 0;
    const tipo = document.getElementById('freteTipoMadeira').value;
    const distancia = parseFloat(document.getElementById('freteDistancia').value) || 0;
    const valorKm = parseFloat(document.getElementById('freteValorKmTon').value) || 0.35;

    if (volume <= 0 || distancia <= 0) {
        alert('Preencha volume e distÃ¢ncia!');
        return;
    }

    const resultado = calcularFreteMadeira(volume, tipo, distancia, valorKm);

    document.getElementById('resultadoCalculoFrete').innerHTML = `
        <div style="background:rgba(16,185,129,0.15);border:2px solid var(--success);border-radius:12px;padding:20px;">
            <h4 style="color:var(--success);margin-bottom:15px;">ğŸ“Š Resultado do CÃ¡lculo</h4>
            <table style="width:100%;color:#fff;">
                <tr><td>ğŸ“¦ Volume:</td><td style="text-align:right;font-weight:700;">${resultado.volume} mÂ³</td></tr>
                <tr><td>ğŸªµ Tipo:</td><td style="text-align:right;font-weight:700;">${resultado.tipoMadeira}</td></tr>
                <tr><td>âš–ï¸ Peso Total:</td><td style="text-align:right;font-weight:700;">${resultado.pesoTotalTon} ton</td></tr>
                <tr><td>ğŸ“ DistÃ¢ncia:</td><td style="text-align:right;font-weight:700;">${resultado.distanciaKm} km</td></tr>
                <tr style="border-top:2px solid var(--success);"><td style="font-size:1.2em;font-weight:700;">ğŸ’° VALOR TOTAL:</td><td style="text-align:right;font-size:1.5em;font-weight:700;color:var(--success);">${resultado.valorTotalFormatado}</td></tr>
            </table>
        </div>
    `;

    ganharXP(5);
}

// IMPORTADOR UNIVERSAL COM PREVIEW
function mostrarImportadorUniversal() {
    const html = `
        <div style="padding:20px;">
            <h3 style="color:var(--info);margin-bottom:20px;">ğŸ“¥ Importador Universal</h3>
            <div class="form-row">
                <div class="form-group">
                    <label>Separador</label>
                    <select id="importSeparator">
                        <option value=",">VÃ­rgula (,)</option>
                        <option value=";">Ponto e vÃ­rgula (;)</option>
                        <option value="\\t">Tab</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Primeira linha Ã© cabeÃ§alho?</label>
                    <select id="importHeader">
                        <option value="true">Sim</option>
                        <option value="false">NÃ£o</option>
                    </select>
                </div>
            </div>
            <div id="dropZoneUniversal" style="border:3px dashed var(--info);border-radius:12px;padding:40px;text-align:center;cursor:pointer;background:rgba(23,162,184,0.1);margin-bottom:20px;">
                <div style="font-size:3em;">ğŸ“</div>
                <p style="margin:10px 0;font-weight:600;color:var(--info);">Arraste arquivos aqui ou clique para selecionar</p>
                <small style="color:rgba(255,255,255,0.5);">CSV, TXT, JSON, VCF</small>
                <input type="file" id="fileInputUniversal" accept=".csv,.txt,.json,.vcf" style="display:none;" onchange="processarArquivoUniversal(this)">
            </div>
            <div id="previewImport" style="display:none;"></div>
            <div id="resultadoImport"></div>
        </div>
    `;

    let modal = document.getElementById('modalImportador');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'modalImportador';
        modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:9999;display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `<div style="background:var(--dark);border-radius:16px;max-width:900px;width:95%;max-height:90vh;overflow-y:auto;border:2px solid var(--info);">
            <div style="display:flex;justify-content:space-between;align-items:center;padding:15px 20px;border-bottom:1px solid rgba(255,255,255,0.1);">
                <span style="font-weight:700;">Importador Universal</span>
                <button onclick="document.getElementById('modalImportador').remove()" style="background:none;border:none;color:#fff;font-size:1.5em;cursor:pointer;">&times;</button>
            </div>
            <div id="conteudoImportador">${html}</div>
        </div>`;
        document.body.appendChild(modal);

        // Setup drag and drop
        const dropZone = document.getElementById('dropZoneUniversal');
        dropZone.onclick = () => document.getElementById('fileInputUniversal').click();
        dropZone.ondragover = (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--success)'; };
        dropZone.ondragleave = () => { dropZone.style.borderColor = 'var(--info)'; };
        dropZone.ondrop = (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--info)';
            processarArquivoUniversal({ files: e.dataTransfer.files });
        };
    }
}

function processarArquivoUniversal(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        const content = e.target.result;
        const fileName = file.name.toLowerCase();
        let data = [];

        const separator = document.getElementById('importSeparator').value;
        const hasHeader = document.getElementById('importHeader').value === 'true';

        if (fileName.endsWith('.csv') || fileName.endsWith('.txt')) {
            const lines = content.split('\n').filter(l => l.trim());
            const headerLine = hasHeader ? lines[0].split(separator) : null;
            const startRow = hasHeader ? 1 : 0;

            for (let i = startRow; i < lines.length; i++) {
                const values = lines[i].split(separator).map(v => v.replace(/"/g, '').trim());
                if (headerLine) {
                    const row = {};
                    headerLine.forEach((h, idx) => { row[h.trim()] = values[idx] || ''; });
                    data.push(row);
                } else {
                    data.push({ col1: values[0], col2: values[1], col3: values[2] });
                }
            }
        } else if (fileName.endsWith('.json')) {
            data = JSON.parse(content);
            if (!Array.isArray(data)) data = [data];
        } else if (fileName.endsWith('.vcf')) {
            const cards = content.split('END:VCARD').filter(c => c.includes('BEGIN:VCARD'));
            cards.forEach(card => {
                const nome = (card.match(/FN:(.+)/i) || [])[1]?.trim();
                const tel = (card.match(/TEL[^:]*:(.+)/i) || [])[1]?.replace(/\D/g, '');
                if (nome || tel) data.push({ nome, whatsapp: tel, tipo: 'indefinido' });
            });
        }

        mostrarPreviewImport(data, file.name);
    };
    reader.readAsText(file);
}

function mostrarPreviewImport(data, fileName) {
    if (data.length === 0) {
        document.getElementById('resultadoImport').innerHTML = '<div class="alert error">Nenhum dado encontrado no arquivo!</div>';
        return;
    }

    const headers = Object.keys(data[0]);
    let tableHtml = `
        <div style="background:rgba(255,255,255,0.05);border-radius:10px;padding:15px;margin-bottom:15px;">
            <p><strong>ğŸ“ Arquivo:</strong> ${fileName}</p>
            <p><strong>ğŸ“Š Registros:</strong> ${data.length}</p>
        </div>
        <div style="overflow-x:auto;max-height:300px;">
            <table style="width:100%;font-size:0.85em;">
                <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                <tbody>${data.slice(0, 10).map(row => `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`).join('')}</tbody>
            </table>
            ${data.length > 10 ? `<p style="text-align:center;color:rgba(255,255,255,0.5);margin-top:10px;">... e mais ${data.length - 10} registros</p>` : ''}
        </div>
        <div style="margin-top:20px;">
            <button class="btn btn-success" onclick="confirmarImportacao()">âœ… Importar ${data.length} registros</button>
            <button class="btn btn-danger" onclick="document.getElementById('previewImport').style.display='none'">âŒ Cancelar</button>
        </div>
    `;

    document.getElementById('previewImport').innerHTML = tableHtml;
    document.getElementById('previewImport').style.display = 'block';

    // Salvar dados para importaÃ§Ã£o
    window.dadosParaImportar = data;
}

function confirmarImportacao() {
    const data = window.dadosParaImportar;
    if (!data || data.length === 0) return;

    let importados = 0;
    data.forEach(row => {
        const contato = {
            id: Date.now() + Math.random(),
            nome: row.nome || row.Nome || row.NOME || row.name || '',
            whatsapp: formatarTelefone(row.whatsapp || row.telefone || row.Telefone || row.TELEFONE || row.phone || ''),
            tipo: detectarTipoContato(row.tipo || row.Tipo || row.nome || ''),
            cidade: row.cidade || row.Cidade || row.CIDADE || '',
            empresa: row.empresa || row.Empresa || '',
            obs: row.obs || row.observacao || '',
            dataCadastro: new Date().toISOString()
        };

        if (contato.nome || contato.whatsapp) {
            const existe = db.contatosUnificados.find(c => c.whatsapp && c.whatsapp === contato.whatsapp);
            if (!existe) {
                db.contatosUnificados.push(contato);
                importados++;
            }
        }
    });

    sincronizarContatosAntigos();
    salvarDados();
    renderContatosTable();
    ganharXP(importados * 2);

    document.getElementById('resultadoImport').innerHTML = `
        <div class="alert success">
            âœ… ImportaÃ§Ã£o concluÃ­da!<br>
            ğŸ“Š ${importados} novos contatos importados<br>
            ğŸ“‡ Total: ${db.contatosUnificados.length} contatos
        </div>
    `;
    document.getElementById('previewImport').style.display = 'none';
    window.dadosParaImportar = null;
}

// BUSCA GLOBAL
function buscaGlobal(termo) {
    const t = termo.toLowerCase();
    return {
        contatos: (db.contatosUnificados || []).filter(c => `${c.nome} ${c.whatsapp} ${c.cidade} ${c.empresa} ${c.obs}`.toLowerCase().includes(t)),
        arquivos: (db.arquivosOrganizados || []).filter(a => a.nome.toLowerCase().includes(t)),
        fretes: (db.fretes || []).filter(f => `${f.motorista} ${f.origem} ${f.destino}`.toLowerCase().includes(t)),
        conhecimentos: (db.conhecimentos || []).filter(k => `${k.pergunta} ${k.resposta}`.toLowerCase().includes(t))
    };
}

// ESTATISTICAS COMPLETAS
function gerarEstatisticas() {
    const contatos = db.contatosUnificados || [];
    const arquivos = db.arquivosOrganizados || [];
    const fretes = db.fretes || [];

    const contatosPorTipo = {};
    contatos.forEach(c => { contatosPorTipo[c.tipo || 'indefinido'] = (contatosPorTipo[c.tipo || 'indefinido'] || 0) + 1; });

    const contatosPorCidade = {};
    contatos.forEach(c => { if (c.cidade) contatosPorCidade[c.cidade] = (contatosPorCidade[c.cidade] || 0) + 1; });

    const arquivosPorCategoria = {};
    arquivos.forEach(a => { arquivosPorCategoria[a.categoria || 'outros'] = (arquivosPorCategoria[a.categoria || 'outros'] || 0) + 1; });

    const valorTotalFretes = fretes.reduce((sum, f) => sum + (parseFloat(f.valor) || 0), 0);

    return { totais: { contatos: contatos.length, arquivos: arquivos.length, fretes: fretes.length, conhecimentos: (db.conhecimentos || []).length }, contatosPorTipo, contatosPorCidade, arquivosPorCategoria, valorTotalFretes, nivelIA: db.agent?.nivel || 1 };
}

// RELATORIO HTML
function gerarRelatorioHTML() {
    const stats = gerarEstatisticas();
    const html = `<!DOCTYPE html><html><head><title>Relatorio ENSIDE</title><style>body{font-family:sans-serif;padding:30px;background:#1e293b;color:#fff;}h1{color:#10b981;}table{width:100%;border-collapse:collapse;margin:20px 0;}td,th{padding:10px;border:1px solid #334155;}</style></head><body>
        <h1>ğŸ“Š Relatorio ENSIDE SYSTEM</h1>
        <p>Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
        <h2>ğŸ“ˆ Totais</h2>
        <ul><li>ğŸ“‡ Contatos: ${stats.totais.contatos}</li><li>ğŸ“ Arquivos: ${stats.totais.arquivos}</li><li>ğŸšš Fretes: ${stats.totais.fretes} (R$ ${stats.valorTotalFretes.toFixed(2)})</li><li>ğŸ§  Conhecimentos: ${stats.totais.conhecimentos}</li></ul>
        <h2>ğŸ‘¥ Contatos por Tipo</h2><ul>${Object.entries(stats.contatosPorTipo).map(([t,q]) => `<li>${t}: ${q}</li>`).join('')}</ul>
        <h2>ğŸ™ï¸ Top Cidades</h2><ul>${Object.entries(stats.contatosPorCidade).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([c,q]) => `<li>${c}: ${q}</li>`).join('')}</ul>
    </body></html>`;
    const win = window.open('', '_blank');
    win.document.write(html);
}

// DETECTAR E REMOVER DUPLICATAS
function detectarDuplicatas() {
    const contatos = db.contatosUnificados || [];
    const duplicatas = [];
    const vistos = {};
    contatos.forEach((c, idx) => {
        const chave = (c.whatsapp || '').replace(/\D/g, '');
        if (chave && vistos[chave]) duplicatas.push({ original: vistos[chave], duplicata: c, index: idx });
        else if (chave) vistos[chave] = c;
    });
    return duplicatas;
}

function removerDuplicatas() {
    const dups = detectarDuplicatas();
    if (dups.length === 0) { alert('âœ… Nenhuma duplicata encontrada!'); return; }
    if (confirm(`âš ï¸ Encontradas ${dups.length} duplicatas.\n\nDeseja remover?`)) {
        const idsRemover = dups.map(d => d.duplicata.id);
        db.contatosUnificados = db.contatosUnificados.filter(c => !idsRemover.includes(c.id));
        sincronizarContatosAntigos(); salvarDados(); renderContatosTable();
        alert(`âœ… ${dups.length} duplicatas removidas!`);
    }
}

// EXPORTAR VCF
function exportarVCF() {
    let vcf = '';
    db.contatosUnificados.forEach(c => {
        if (c.nome && c.whatsapp) {
            const tel = c.whatsapp.replace(/\D/g, '');
            vcf += `BEGIN:VCARD\nVERSION:3.0\nFN:${c.nome}\nTEL;TYPE=CELL:+55${tel}\nNOTE:${c.tipo || ''} - ${c.cidade || ''}\nEND:VCARD\n`;
        }
    });
    download(vcf, 'contatos_enside.vcf', 'text/vcard');
    alert(`âœ… ${db.contatosUnificados.length} contatos exportados em VCF!`);
}

// VERIFICAR INTEGRIDADE
function verificarIntegridade() {
    let problemas = [];
    const semNome = db.contatosUnificados.filter(c => !c.nome || c.nome.trim() === '');
    if (semNome.length > 0) problemas.push(`${semNome.length} contatos sem nome`);
    const semWA = db.contatosUnificados.filter(c => !c.whatsapp);
    if (semWA.length > 0) problemas.push(`${semWA.length} contatos sem WhatsApp`);
    const dups = detectarDuplicatas();
    if (dups.length > 0) problemas.push(`${dups.length} duplicatas detectadas`);

    if (problemas.length === 0) alert('âœ… Sistema OK! Nenhum problema encontrado.');
    else alert(`âš ï¸ Problemas encontrados:\n\n${problemas.join('\n')}`);
    return problemas;
}

// AUTO-SAVE a cada 30 segundos
setInterval(() => { salvarDados(); console.log('ğŸ’¾ Auto-save'); }, 30000);

// ATALHOS DE TECLADO
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch(e.key) {
            case 's': e.preventDefault(); salvarDados(); alert('ğŸ’¾ Dados salvos!'); break;
            case 'f': e.preventDefault(); mostrarCalculadoraFrete(); break;
            case 'i': e.preventDefault(); mostrarImportadorUniversal(); break;
            case 'r': e.preventDefault(); gerarRelatorioHTML(); break;
        }
    }
});

console.log('ğŸš€ v10.1 carregado: Calculadora Frete, Importador Universal, 45 Categorias, Busca Global, EstatÃ­sticas, VCF, Atalhos');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AGENTE IA - MULTI-API INTELIGENTE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function salvarTodasAPIs() {
    db.iaConfig = {
        providerPreferido: document.getElementById('iaProviderPreferido').value,
        apis: {
            huggingface: document.getElementById('apiHuggingface').value.trim(),
            groq: document.getElementById('apiGroq').value.trim(),
            together: document.getElementById('apiTogether').value.trim(),
            cohere: document.getElementById('apiCohere').value.trim(),
            openai: document.getElementById('apiOpenai').value.trim(),
            anthropic: document.getElementById('apiAnthropic').value.trim(),
            google: document.getElementById('apiGoogle').value.trim()
        }
    };
    salvarDados();
    atualizarStatusAPIs();
    alert('âœ… Todas as APIs foram salvas!');
}

function carregarConfigIA() {
    if (db.iaConfig && db.iaConfig.apis) {
        document.getElementById('iaProviderPreferido').value = db.iaConfig.providerPreferido || 'auto';
        document.getElementById('apiHuggingface').value = db.iaConfig.apis.huggingface || '';
        document.getElementById('apiGroq').value = db.iaConfig.apis.groq || '';
        document.getElementById('apiTogether').value = db.iaConfig.apis.together || '';
        document.getElementById('apiCohere').value = db.iaConfig.apis.cohere || '';
        document.getElementById('apiOpenai').value = db.iaConfig.apis.openai || '';
        document.getElementById('apiAnthropic').value = db.iaConfig.apis.anthropic || '';
        document.getElementById('apiGoogle').value = db.iaConfig.apis.google || '';
    }
    atualizarStatusAPIs();
}

function atualizarStatusAPIs() {
    if (!db.iaConfig || !db.iaConfig.apis) return;
    const apis = db.iaConfig.apis;
    let ativas = 0;
    Object.values(apis).forEach(v => { if (v && v.length > 5) ativas++; });
    document.getElementById('apisAtivas').textContent = ativas;
    document.getElementById('statusIA').textContent = ativas > 0 ? 'Online' : 'Local';
    document.getElementById('statusIA').style.color = ativas > 0 ? 'var(--success)' : 'var(--warning)';
}

async function testarAPIs() {
    const resultado = document.getElementById('resultadoTesteAPIs');
    resultado.innerHTML = '<div class="alert info">ğŸ”„ Testando conexÃµes...</div>';

    const testes = [];
    const apis = db.iaConfig?.apis || {};

    // Testar cada API
    if (apis.groq) testes.push(testarGroq());
    if (apis.huggingface) testes.push(testarHuggingface());
    if (apis.together) testes.push(testarTogether());
    if (apis.cohere) testes.push(testarCohere());
    if (apis.google) testes.push(testarGoogle());
    if (apis.openai) testes.push(testarOpenAI());
    if (apis.anthropic) testes.push(testarAnthropic());

    if (testes.length === 0) {
        resultado.innerHTML = '<div class="alert warning">âš ï¸ Nenhuma API configurada. Configure pelo menos uma!</div>';
        return;
    }

    const resultados = await Promise.allSettled(testes);
    let html = '<div class="alert success"><strong>ğŸ“Š Resultado dos Testes:</strong><br><br>';

    resultados.forEach((r, i) => {
        if (r.status === 'fulfilled') {
            html += `âœ… ${r.value}<br>`;
        } else {
            html += `âŒ ${r.reason}<br>`;
        }
    });

    html += '</div>';
    resultado.innerHTML = html;
}

async function testarGroq() {
    try {
        const r = await fetch('https://api.groq.com/openai/v1/models', {
            headers: { 'Authorization': `Bearer ${db.iaConfig.apis.groq}` }
        });
        if (r.ok) return 'ğŸŒ Groq: Conectado!';
        throw new Error('Falha');
    } catch(e) { throw 'ğŸŒ Groq: Falha na conexÃ£o'; }
}

async function testarHuggingface() {
    try {
        const r = await fetch('https://huggingface.co/api/whoami-v2', {
            headers: { 'Authorization': `Bearer ${db.iaConfig.apis.huggingface}` }
        });
        if (r.ok) return 'ğŸ¤— Hugging Face: Conectado!';
        throw new Error('Falha');
    } catch(e) { throw 'ğŸ¤— Hugging Face: Falha na conexÃ£o'; }
}

async function testarTogether() {
    try {
        const r = await fetch('https://api.together.xyz/v1/models', {
            headers: { 'Authorization': `Bearer ${db.iaConfig.apis.together}` }
        });
        if (r.ok) return 'ğŸ”· Together AI: Conectado!';
        throw new Error('Falha');
    } catch(e) { throw 'ğŸ”· Together AI: Falha na conexÃ£o'; }
}

async function testarCohere() {
    try {
        const r = await fetch('https://api.cohere.ai/v1/models', {
            headers: { 'Authorization': `Bearer ${db.iaConfig.apis.cohere}` }
        });
        if (r.ok) return 'ğŸŸ  Cohere: Conectado!';
        throw new Error('Falha');
    } catch(e) { throw 'ğŸŸ  Cohere: Falha na conexÃ£o'; }
}

async function testarGoogle() {
    try {
        const r = await fetch(`https://generativelanguage.googleapis.com/v1/models?key=${db.iaConfig.apis.google}`);
        if (r.ok) return 'ğŸ”µ Google Gemini: Conectado!';
        throw new Error('Falha');
    } catch(e) { throw 'ğŸ”µ Google Gemini: Falha na conexÃ£o'; }
}

async function testarOpenAI() {
    try {
        const r = await fetch('https://api.openai.com/v1/models', {
            headers: { 'Authorization': `Bearer ${db.iaConfig.apis.openai}` }
        });
        if (r.ok) return 'ğŸŸ¢ OpenAI: Conectado!';
        throw new Error('Falha');
    } catch(e) { throw 'ğŸŸ¢ OpenAI: Falha na conexÃ£o'; }
}

async function testarAnthropic() {
    // Anthropic nÃ£o tem endpoint de teste simples, assumimos OK se tem key
    if (db.iaConfig.apis.anthropic && db.iaConfig.apis.anthropic.startsWith('sk-ant')) {
        return 'ğŸŸ£ Anthropic: Key configurada';
    }
    throw 'ğŸŸ£ Anthropic: Key invÃ¡lida';
}

function getProvedorDisponivel() {
    const apis = db.iaConfig?.apis || {};
    const pref = db.iaConfig?.providerPreferido || 'auto';

    // Se tem preferÃªncia especÃ­fica e estÃ¡ configurada
    if (pref !== 'auto' && pref !== 'local' && apis[pref]) {
        return pref;
    }

    if (pref === 'local') return 'local';

    // Ordem de prioridade para auto (gratuitos primeiro, depois pagos)
    const ordem = ['groq', 'google', 'huggingface', 'together', 'cohere', 'openai', 'anthropic'];
    for (const p of ordem) {
        if (apis[p] && apis[p].length > 5) return p;
    }

    return 'local';
}

async function enviarMensagem() {
    const input = document.getElementById('chatInput');
    const mensagem = input.value.trim();
    if (!mensagem) return;

    // Adiciona mensagem do usuÃ¡rio
    adicionarMensagemChat('user', mensagem);
    input.value = '';

    // Mostra "digitando..."
    const typingId = adicionarMensagemChat('agent', 'Pensando', true);

    try {
        const provedor = getProvedorDisponivel();
        let resposta;

        switch(provedor) {
            case 'groq':
                resposta = await chamarGroq(mensagem);
                break;
            case 'google':
                resposta = await chamarGoogle(mensagem);
                break;
            case 'huggingface':
                resposta = await chamarHuggingface(mensagem);
                break;
            case 'together':
                resposta = await chamarTogether(mensagem);
                break;
            case 'cohere':
                resposta = await chamarCohere(mensagem);
                break;
            case 'openai':
                resposta = await chamarOpenAI(mensagem);
                break;
            case 'anthropic':
                resposta = await chamarClaude(mensagem);
                break;
            default:
                resposta = gerarRespostaLocal(mensagem);
        }

        removerMensagem(typingId);
        adicionarMensagemChat('agent', resposta);
        ganharXP(2);
        salvarDados();

    } catch(err) {
        removerMensagem(typingId);
        // Tenta fallback local se API falhar
        const respostaLocal = gerarRespostaLocal(mensagem);
        adicionarMensagemChat('agent', respostaLocal + '\n\nâš ï¸ (Resposta local - API indisponÃ­vel)');
    }
}

function adicionarMensagemChat(tipo, texto, typing = false) {
    const container = document.getElementById('chatContainer');
    const id = Date.now();

    const div = document.createElement('div');
    div.className = `chat-message ${tipo}`;
    div.id = `msg-${id}`;
    div.innerHTML = `
        <div class="chat-avatar">${tipo === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–'}</div>
        <div class="chat-bubble ${typing ? 'typing' : ''}">${texto}</div>
    `;

    container.appendChild(div);
    container.scrollTop = container.scrollHeight;

    return id;
}

function removerMensagem(id) {
    const msg = document.getElementById(`msg-${id}`);
    if (msg) msg.remove();
}

function gerarRespostaLocal(pergunta) {
    const p = pergunta.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    db.agent.interacoes++;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SAUDAÃ‡Ã•ES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (p.match(/^(oi|ola|hey|hi|hello|bom dia|boa tarde|boa noite|e ai|fala)/)) {
        const saudacoes = [
            `OlÃ¡! ğŸ‘‹ Sou o Enside Agent, seu assistente inteligente. Como posso ajudar hoje?`,
            `Oi! ğŸ¤– Estou pronto para ajudar. Pergunte sobre motoristas, fornecedores, clientes ou fretes!`,
            `OlÃ¡! Tenho ${db.contatosUnificados.length} contatos e ${db.conhecimentos.length} conhecimentos. O que precisa?`
        ];
        return saudacoes[Math.floor(Math.random() * saudacoes.length)];
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AGRADECIMENTOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (p.match(/(obrigado|valeu|thanks|brigado|agradeco)/)) {
        return `De nada! ğŸ˜Š Estou sempre aqui para ajudar. Precisa de mais alguma coisa?`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUSCA INTELIGENTE NA BASE DE CONHECIMENTOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const palavrasChave = p.split(/\s+/).filter(palavra => palavra.length > 2);
    let conhecimentosRelevantes = [];

    db.conhecimentos.forEach(k => {
        const texto = ((k.titulo || '') + ' ' + (k.conteudo || '') + ' ' + (k.tags || []).join(' ')).toLowerCase();
        let score = 0;

        palavrasChave.forEach(palavra => {
            if (texto.includes(palavra)) score += 2;
            if ((k.titulo || '').toLowerCase().includes(palavra)) score += 5;
            if ((k.tags || []).some(t => t.toLowerCase().includes(palavra))) score += 3;
        });

        if (score > 0) conhecimentosRelevantes.push({ ...k, score });
    });

    conhecimentosRelevantes.sort((a, b) => b.score - a.score);

    if (conhecimentosRelevantes.length > 0) {
        const melhor = conhecimentosRelevantes[0];
        let resposta = `ğŸ“š **${melhor.titulo}**\n\n${melhor.conteudo}`;
        if (melhor.tags && melhor.tags.length > 0) {
            resposta += `\n\nğŸ·ï¸ Tags: ${melhor.tags.join(', ')}`;
        }
        if (conhecimentosRelevantes.length > 1) {
            resposta += `\n\nğŸ’¡ TambÃ©m encontrei: ${conhecimentosRelevantes.slice(1, 3).map(k => k.titulo).join(', ')}`;
        }
        return resposta;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ESTATÃSTICAS E RESUMOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (p.match(/(quantos|quantas|total|todos|lista|resumo|estatistica|status)/)) {
        if (p.match(/(contato|pessoa|cadastro)/)) {
            const mot = db.contatosUnificados.filter(c => c.tipo === 'motorista').length;
            const forn = db.contatosUnificados.filter(c => c.tipo === 'fornecedor').length;
            const cli = db.contatosUnificados.filter(c => c.tipo === 'cliente').length;
            const indef = db.contatosUnificados.filter(c => !c.tipo || c.tipo === 'indefinido').length;
            return `ğŸ“Š **Resumo de Contatos:**\n\nâ€¢ ğŸšš Motoristas: ${mot}\nâ€¢ ğŸ­ Fornecedores: ${forn}\nâ€¢ ğŸ‘¥ Clientes: ${cli}\nâ€¢ â“ NÃ£o classificados: ${indef}\n\n**Total: ${db.contatosUnificados.length} contatos**`;
        }
        if (p.match(/(frete|viagem|carga)/)) {
            const pendentes = db.fretes.filter(f => f.status === 'pendente').length;
            return `ğŸšš **Resumo de Fretes:**\n\nâ€¢ Total cadastrados: ${db.fretes.length}\nâ€¢ Pendentes: ${pendentes}\n\nUse a aba Fretes para ver detalhes.`;
        }
        if (p.match(/(conhecimento|aprend|sab)/)) {
            const cats = {};
            db.conhecimentos.forEach(k => { cats[k.categoria] = (cats[k.categoria] || 0) + 1; });
            return `ğŸ§  **Base de Conhecimentos:**\n\nâ€¢ Total: ${db.conhecimentos.length} conhecimentos\n\n**Por categoria:**\n${Object.entries(cats).map(([c, n]) => `â€¢ ${c}: ${n}`).join('\n')}`;
        }
        // Resumo geral
        return `ğŸ“Š **Status do Sistema Enside:**\n\nâ€¢ ğŸ‘¥ Contatos: ${db.contatosUnificados.length}\nâ€¢ ğŸšš Fretes: ${db.fretes.length}\nâ€¢ ğŸ§  Conhecimentos: ${db.conhecimentos.length}\nâ€¢ ğŸ“± Listas WhatsApp: ${db.listas.length}\nâ€¢ ğŸ¤– NÃ­vel do Agente: ${db.agent.nivel}\nâ€¢ â­ XP: ${db.agent.xp}`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUSCAR MOTORISTAS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (p.match(/(motorista|caminhao|caminhÃ£o|freteiro|transporte)/)) {
        const motoristas = db.contatosUnificados.filter(c => c.tipo === 'motorista');
        if (motoristas.length === 0) {
            return `ğŸšš Nenhum motorista cadastrado ainda.\n\nğŸ’¡ Dica: VÃ¡ em "ğŸ“‹ Contatos Importados" para adicionar motoristas.`;
        }

        // Busca especÃ­fica por cidade
        const cidadeMatch = p.match(/(?:de|em|para|pra)\s+([a-zA-ZÃ€-Ãº\s]+)/);
        if (cidadeMatch) {
            const cidade = cidadeMatch[1].trim().toLowerCase();
            const filtrados = motoristas.filter(m => (m.cidade || '').toLowerCase().includes(cidade));
            if (filtrados.length > 0) {
                return `ğŸšš **Motoristas em ${cidadeMatch[1]}:**\n\n${filtrados.slice(0, 10).map(m => `â€¢ ${m.nome} - ğŸ“± ${m.whatsapp}${m.cidade ? ` (${m.cidade})` : ''}`).join('\n')}`;
            }
        }

        return `ğŸšš **${motoristas.length} motoristas cadastrados:**\n\n${motoristas.slice(0, 8).map(m => `â€¢ ${m.nome} - ğŸ“± ${m.whatsapp}${m.cidade ? ` (${m.cidade})` : ''}`).join('\n')}${motoristas.length > 8 ? `\n\n... e mais ${motoristas.length - 8} motoristas.` : ''}`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUSCAR FORNECEDORES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (p.match(/(fornecedor|fornece|madeira|serraria|fabrica|comprar de)/)) {
        const fornecedores = db.contatosUnificados.filter(c => c.tipo === 'fornecedor');
        if (fornecedores.length === 0) {
            return `ğŸ­ Nenhum fornecedor cadastrado ainda.\n\nğŸ’¡ Dica: Cadastre seus fornecedores na aba "ğŸ“‹ Contatos Importados".`;
        }
        return `ğŸ­ **${fornecedores.length} fornecedores cadastrados:**\n\n${fornecedores.slice(0, 8).map(f => `â€¢ ${f.nome} - ğŸ“± ${f.whatsapp}${f.empresa ? ` (${f.empresa})` : ''}`).join('\n')}`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUSCAR CLIENTES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (p.match(/(cliente|comprador|vender para|venda)/)) {
        const clientes = db.contatosUnificados.filter(c => c.tipo === 'cliente');
        if (clientes.length === 0) {
            return `ğŸ‘¥ Nenhum cliente cadastrado ainda.\n\nğŸ’¡ Dica: Adicione clientes na aba "ğŸ“‹ Contatos Importados".`;
        }
        return `ğŸ‘¥ **${clientes.length} clientes cadastrados:**\n\n${clientes.slice(0, 8).map(c => `â€¢ ${c.nome} - ğŸ“± ${c.whatsapp}${c.empresa ? ` (${c.empresa})` : ''}`).join('\n')}`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• BUSCAR CONTATO POR NOME â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (p.match(/(buscar|procurar|encontrar|achar|contato|telefone|whatsapp|numero)/)) {
        const nomeMatch = p.match(/(?:buscar|procurar|contato|telefone|numero|whatsapp)\s+(?:do|da|de)?\s*([a-zA-ZÃ€-Ãº\s]+)/i);
        if (nomeMatch) {
            const nome = nomeMatch[1].trim().toLowerCase();
            const encontrados = db.contatosUnificados.filter(c =>
                (c.nome || '').toLowerCase().includes(nome) ||
                (c.empresa || '').toLowerCase().includes(nome)
            );
            if (encontrados.length > 0) {
                return `ğŸ” **Encontrei ${encontrados.length} contato(s):**\n\n${encontrados.slice(0, 5).map(c => `â€¢ **${c.nome}**\n  ğŸ“± ${c.whatsapp}\n  ${getTipoIcon(c.tipo)} ${getTipoLabel(c.tipo)}${c.cidade ? `\n  ğŸ“ ${c.cidade}` : ''}`).join('\n\n')}`;
            }
            return `ğŸ” NÃ£o encontrei contatos com "${nomeMatch[1]}". Tente outro nome ou verifique a lista de contatos.`;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• AJUDA E COMANDOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (p.match(/(ajuda|help|como|o que|comandos|funciona|pode fazer)/)) {
        return `ğŸ¤– **OlÃ¡! Sou o Enside Agent.**\n\nPosso ajudar vocÃª com:\n\nğŸ“Š **InformaÃ§Ãµes:**\nâ€¢ "Quantos contatos tenho?"\nâ€¢ "Resumo do sistema"\nâ€¢ "Status dos fretes"\n\nğŸ” **Buscas:**\nâ€¢ "Lista de motoristas"\nâ€¢ "Fornecedores de madeira"\nâ€¢ "Clientes cadastrados"\nâ€¢ "Buscar contato JoÃ£o"\nâ€¢ "Motoristas de SÃ£o Paulo"\n\nğŸ§  **Conhecimentos:**\nâ€¢ Pergunte qualquer coisa que vocÃª me ensinou!\nâ€¢ "Qual o preÃ§o do frete para SP?"\n\nğŸ’¡ **Dica:** Ensine-me mais na aba "ğŸ“š Ensinar IA"!`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PREÃ‡OS E VALORES â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (p.match(/(preco|preÃ§o|valor|custo|quanto custa|tabela)/)) {
        const precos = db.conhecimentos.filter(k => k.categoria === 'precos' || (k.tags || []).some(t => t.includes('preco') || t.includes('valor')));
        if (precos.length > 0) {
            return `ğŸ’° **InformaÃ§Ãµes de PreÃ§os:**\n\n${precos.slice(0, 3).map(p => `â€¢ **${p.titulo}**\n  ${p.conteudo.substring(0, 150)}${p.conteudo.length > 150 ? '...' : ''}`).join('\n\n')}`;
        }
        return `ğŸ’° NÃ£o tenho informaÃ§Ãµes de preÃ§os cadastradas.\n\nğŸ’¡ Dica: Adicione preÃ§os na aba "ğŸ“š Ensinar IA" com a categoria "PreÃ§os".`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• FRETES ESPECÃFICOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    if (p.match(/(frete|viagem|carga|rota)/)) {
        if (db.fretes.length === 0) {
            return `ğŸšš Nenhum frete cadastrado ainda.\n\nUse a aba "ğŸšš Fretes" para cadastrar novos fretes.`;
        }
        const ultimos = db.fretes.slice(0, 5);
        return `ğŸšš **Ãšltimos ${ultimos.length} fretes:**\n\n${ultimos.map(f => `â€¢ ${f.motorista}: ${f.origem} â†’ ${f.destino}${f.valor ? ` (R$ ${f.valor})` : ''}`).join('\n')}`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• RESPOSTA INTELIGENTE PADRÃƒO â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const sugestoes = [];
    if (db.contatosUnificados.length > 0) sugestoes.push('"Lista de motoristas"', '"Buscar contato [nome]"');
    if (db.conhecimentos.length > 0) sugestoes.push('"O que vocÃª sabe sobre [assunto]?"');
    if (db.fretes.length > 0) sugestoes.push('"Status dos fretes"');

    return `ğŸ¤” NÃ£o entendi bem sua pergunta.\n\n**Tente perguntar:**\n${sugestoes.length > 0 ? sugestoes.map(s => `â€¢ ${s}`).join('\n') : 'â€¢ "Ajuda" para ver o que posso fazer'}\n\nğŸ’¡ **Dica:** Quanto mais vocÃª me ensinar na aba "ğŸ“š Ensinar IA", mais inteligente eu fico!`;
}

function getContextoIA() {
    return `VocÃª Ã© o Enside Agent, assistente inteligente oficial da ENSIDE MADEIRAS - empresa de Minas Gerais especializada em eucalipto tratado CCA em autoclave com garantia de 10-15 anos.

## PRODUTOS E PREÃ‡OS ATUAIS:

### MOURÃ•ES (Comprimento: 2,20m):
- MourÃ£o 8-10cm: R$ 9,00/peÃ§a - Ideal para cercas de arame
- MourÃ£o 12-14cm: R$ 15,00/peÃ§a - Para cercas robustas e porteiras
- MourÃ£o 17-22cm: R$ 22,00/peÃ§a - Estrutural, curral e mangueira

### ESTACAS E POSTES (Comprimento: 2,20m):
- Estaca 6-8cm: R$ 7,32/peÃ§a - Para cercas e tutores
- Poste 13-16cm: R$ 15,00/peÃ§a - Para iluminaÃ§Ã£o rural
- Escora 9-12cm: R$ 9,00/peÃ§a - Para construÃ§Ã£o civil

### LOTES:
- Lote Misto (1 st): R$ 450,00 - EstÃ©reo misto vÃ¡rias bitolas
- Lenha Eucalipto (1 st): R$ 180,00 - Para energia/forno

## TABELA DE PREÃ‡OS POR BITOLA:
- 6-8 cm: R$ 6,50 a R$ 7,32 - Cercas, tutores
- 8-10 cm: R$ 6,50 a R$ 9,00 - Cercas de arame
- 9-12 cm: R$ 6,50 a R$ 9,00 - Escoras, construÃ§Ã£o
- 12-14 cm: R$ 12,06 a R$ 15,00 - Cercas robustas
- 13-16 cm: R$ 12,06 a R$ 15,00 - Postes, iluminaÃ§Ã£o
- 17-22 cm: R$ 18,00 a R$ 22,00 - Estrutural, curral

## PREÃ‡OS POR ESTÃ‰REO (st):
- Bitola 6-8cm: R$ 390 a R$ 439/st (~60 peÃ§as)
- Bitola 8-10cm: R$ 240 a R$ 333/st (~37 peÃ§as)
- Bitola 12-14cm: R$ 217 a R$ 270/st (~18 peÃ§as)
- Bitola 17-22cm: R$ 144 a R$ 176/st (~8 peÃ§as)

## CONVERSÃ•ES:
- 1 estÃ©reo (st) = 0,65 mÂ³ de madeira sÃ³lida
- 1 estÃ©reo = pilha de 1m x 1m x 1m (inclui ~35% de espaÃ§o vazio)
- Comprimento padrÃ£o: 2,20 metros

## TRATAMENTO CCA:
- Arseniato de Cobre Cromatado
- Processo em autoclave
- ProteÃ§Ã£o contra cupins, fungos e apodrecimento
- Garantia: 10-15 anos

## CONTATO:
- WhatsApp: (18) 99654-0492
- LocalizaÃ§Ã£o: Assis-SP / Minas Gerais

DADOS DO SISTEMA:
- ${db.contatosUnificados.length} contatos cadastrados (${db.contatos.motoristas.length} motoristas, ${db.contatos.fornecedores.length} fornecedores, ${db.contatos.clientes.length} clientes)
- ${db.fretes.length} fretes registrados
- ${db.conhecimentos.length} conhecimentos na base

BASE DE CONHECIMENTOS:
${db.conhecimentos.slice(0, 5).map(k => `- ${k.titulo}: ${k.conteudo.substring(0, 100)}`).join('\n')}

Responda de forma Ãºtil, concisa e profissional em portuguÃªs brasileiro.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SELEÃ‡ÃƒO DE MODELOS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MODELOS_IA = {
    'groq-llama-3.3-70b': { provider: 'groq', model: 'llama-3.3-70b-versatile', nome: 'Llama 3.3 70B' },
    'groq-llama-3.1-8b': { provider: 'groq', model: 'llama-3.1-8b-instant', nome: 'Llama 3.1 8B' },
    'groq-mixtral-8x7b': { provider: 'groq', model: 'mixtral-8x7b-32768', nome: 'Mixtral 8x7B' },
    'gpt-4o-mini': { provider: 'openai', model: 'gpt-4o-mini', nome: 'GPT-4o Mini' },
    'gpt-4o': { provider: 'openai', model: 'gpt-4o', nome: 'GPT-4o' },
    'gpt-3.5-turbo': { provider: 'openai', model: 'gpt-3.5-turbo', nome: 'GPT-3.5 Turbo' },
    'claude-3-haiku': { provider: 'anthropic', model: 'claude-3-haiku-20240307', nome: 'Claude 3 Haiku' },
    'claude-3-sonnet': { provider: 'anthropic', model: 'claude-3-sonnet-20240229', nome: 'Claude 3 Sonnet' },
    'claude-3-opus': { provider: 'anthropic', model: 'claude-3-opus-20240229', nome: 'Claude 3 Opus' },
    'gemini-pro': { provider: 'google', model: 'gemini-pro', nome: 'Gemini Pro' },
    'gemini-1.5-flash': { provider: 'google', model: 'gemini-1.5-flash', nome: 'Gemini 1.5 Flash' }
};

function getModeloSelecionado() {
    const select = document.getElementById('iaModeloSelecionado');
    return select ? select.value : 'auto';
}

function getTemperatura() {
    const slider = document.getElementById('iaTemperatura');
    return slider ? slider.value / 100 : 0.7;
}

function atualizarModelosDisponiveis() {
    const provider = document.getElementById('iaProviderPreferido').value;
    const modeloSelect = document.getElementById('iaModeloSelecionado');
    if (!modeloSelect) return;
    
    // Habilita/desabilita grupos baseado no provedor
    const optgroups = modeloSelect.querySelectorAll('optgroup');
    optgroups.forEach(group => {
        const options = group.querySelectorAll('option');
        options.forEach(opt => {
            const modelo = MODELOS_IA[opt.value];
            if (provider === 'auto' || !modelo || modelo.provider === provider) {
                opt.disabled = false;
            } else {
                opt.disabled = true;
            }
        });
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GROQ (Gratuito e RÃ¡pido) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function chamarGroq(mensagem, modeloOverride = null) {
    const modeloSelecionado = getModeloSelecionado();
    let modelo = 'llama-3.3-70b-versatile';
    
    if (modeloOverride) {
        modelo = modeloOverride;
    } else if (modeloSelecionado && modeloSelecionado.startsWith('groq-')) {
        const config = MODELOS_IA[modeloSelecionado];
        if (config) modelo = config.model;
    }
    
    const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${db.iaConfig.apis.groq}`
        },
        body: JSON.stringify({
            model: modelo,
            messages: [
                { role: 'system', content: getContextoIA() },
                { role: 'user', content: mensagem }
            ],
            max_tokens: 500,
            temperature: getTemperatura()
        })
    });

    if (!response.ok) throw new Error('Erro na API Groq');
    const data = await response.json();
    return data.choices[0].message.content;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GOOGLE GEMINI (Gratuito) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function chamarGoogle(mensagem) {
    const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${db.iaConfig.apis.google}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{
                parts: [{ text: getContextoIA() + '\n\nUsuÃ¡rio: ' + mensagem }]
            }],
            generationConfig: { maxOutputTokens: 500, temperature: 0.7 }
        })
    });

    if (!response.ok) throw new Error('Erro na API Google');
    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HUGGING FACE (Gratuito) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function chamarHuggingface(mensagem) {
    const response = await fetch('https://api-inference.huggingface.co/models/mistralai/Mixtral-8x7B-Instruct-v0.1', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${db.iaConfig.apis.huggingface}`
        },
        body: JSON.stringify({
            inputs: `<s>[INST] ${getContextoIA()}\n\nUsuÃ¡rio: ${mensagem} [/INST]`,
            parameters: { max_new_tokens: 500, temperature: 0.7 }
        })
    });

    if (!response.ok) throw new Error('Erro na API Hugging Face');
    const data = await response.json();
    return Array.isArray(data) ? data[0].generated_text.split('[/INST]').pop().trim() : data.generated_text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• TOGETHER AI (Gratuito) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function chamarTogether(mensagem) {
    const response = await fetch('https://api.together.xyz/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${db.iaConfig.apis.together}`
        },
        body: JSON.stringify({
            model: 'meta-llama/Llama-3-70b-chat-hf',
            messages: [
                { role: 'system', content: getContextoIA() },
                { role: 'user', content: mensagem }
            ],
            max_tokens: 500,
            temperature: 0.7
        })
    });

    if (!response.ok) throw new Error('Erro na API Together');
    const data = await response.json();
    return data.choices[0].message.content;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COHERE (Gratuito) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function chamarCohere(mensagem) {
    const response = await fetch('https://api.cohere.ai/v1/chat', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${db.iaConfig.apis.cohere}`
        },
        body: JSON.stringify({
            model: 'command',
            message: mensagem,
            preamble: getContextoIA(),
            max_tokens: 500,
            temperature: 0.7
        })
    });

    if (!response.ok) throw new Error('Erro na API Cohere');
    const data = await response.json();
    return data.text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• OPENAI (Pago) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function chamarOpenAI(mensagem, modeloOverride = null) {
    const modeloSelecionado = getModeloSelecionado();
    let modelo = 'gpt-4o-mini';
    
    if (modeloOverride) {
        modelo = modeloOverride;
    } else if (modeloSelecionado && (modeloSelecionado.startsWith('gpt-'))) {
        const config = MODELOS_IA[modeloSelecionado];
        if (config) modelo = config.model;
    }
    
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${db.iaConfig.apis.openai}`
        },
        body: JSON.stringify({
            model: modelo,
            messages: [
                { role: 'system', content: getContextoIA() },
                { role: 'user', content: mensagem }
            ],
            max_tokens: 500,
            temperature: getTemperatura()
        })
    });

    if (!response.ok) throw new Error('Erro na API OpenAI');
    const data = await response.json();
    return data.choices[0].message.content;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ANTHROPIC CLAUDE (Pago) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function chamarClaude(mensagem, modeloOverride = null) {
    const modeloSelecionado = getModeloSelecionado();
    let modelo = 'claude-3-haiku-20240307';
    
    if (modeloOverride) {
        modelo = modeloOverride;
    } else if (modeloSelecionado && modeloSelecionado.startsWith('claude-')) {
        const config = MODELOS_IA[modeloSelecionado];
        if (config) modelo = config.model;
    }
    
    const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'x-api-key': db.iaConfig.apis.anthropic,
            'anthropic-version': '2023-06-01'
        },
        body: JSON.stringify({
            model: modelo,
            max_tokens: 500,
            system: getContextoIA(),
            messages: [{ role: 'user', content: mensagem }]
        })
    });

    if (!response.ok) throw new Error('Erro na API Claude');
    const data = await response.json();
    return data.content[0].text;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRIAGEM INTELIGENTE DE CONTATOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function verNaoClassificados() {
    const naoClassificados = db.contatosUnificados.filter(c => c.tipo === 'indefinido' || !c.tipo);

    const grid = document.getElementById('triagemContatosGrid');

    if (naoClassificados.length === 0) {
        grid.innerHTML = '<div class="empty-state"><div class="icon">âœ…</div><p>Todos os contatos estÃ£o classificados!</p></div>';
        return;
    }

    grid.innerHTML = naoClassificados.map(c => `
        <div class="triagem-card pendente">
            <div class="file-icon">ğŸ‘¤</div>
            <div class="file-name">${c.nome || 'Sem nome'}</div>
            <div class="file-info">ğŸ“± ${c.whatsapp || '-'}<br>ğŸ“ ${c.cidade || '-'}</div>
            <select onchange="classificarContato(${c.id}, this.value)">
                <option value="indefinido">â“ Selecione o tipo...</option>
                <option value="motorista">ğŸšš Motorista/Frete</option>
                <option value="fornecedor">ğŸ­ Fornecedor</option>
                <option value="cliente">ğŸ‘¥ Cliente</option>
                <option value="representante">ğŸ‘” Representante</option>
                <option value="cartorio">ğŸ›ï¸ CartÃ³rio</option>
                <option value="particular">ğŸ‘¤ Particular</option>
                <option value="banco">ğŸ¦ Banco/Financeiro</option>
                <option value="servico">ğŸ› ï¸ ServiÃ§o/Profissional</option>
            </select>
        </div>
    `).join('');
}

function classificarContato(id, tipo) {
    const contato = db.contatosUnificados.find(c => c.id === id);
    if (contato && tipo !== 'indefinido') {
        contato.tipo = tipo;
        sincronizarContatosAntigos();
        ganharXP(3);
        salvarDados();
        verNaoClassificados();
    }
}

async function classificarContatosIA() {
    const naoClassificados = db.contatosUnificados.filter(c => c.tipo === 'indefinido' || !c.tipo);

    if (naoClassificados.length === 0) {
        alert('âœ… Todos os contatos jÃ¡ estÃ£o classificados!');
        return;
    }

    // SEMPRE usa classificaÃ§Ã£o local primeiro (mais rÃ¡pida e confiÃ¡vel)
    {
        // ClassificaÃ§Ã£o local MELHORADA baseada em palavras-chave expandidas
        let classificados = 0;

        // Palavras-chave expandidas para MOTORISTAS/FRETE
        const palavrasMotorista = [
            'motorista', 'frete', 'caminhÃ£o', 'caminhao', 'transp', 'carreta', 'truck', 'bitrem',
            'rodovia', 'carga', 'entrega', 'viagem', 'rota', 'frete ls', 'frete bitrem', 
            'agenciador', 'carreteiro', 'trucado', 'bi-trem', 'logistica', 'logÃ­stica', 
            'expediÃ§Ã£o', 'expedicao', 'frota', 'condutor', 'chofer', 'motorizado'
        ];

        // Palavras-chave para FORNECEDORES (sem madeiras - essas vÃ£o para representante)
        const palavrasFornecedor = [
            'fornece', 'fabrica', 'fÃ¡brica', 'industria', 'indÃºstria',
            'deposito', 'depÃ³sito', 'material', 'distribui', 'atacado', 'produtor', 'produÃ§Ã£o',
            'telha', 'tijolo', 'cimento', 'areia', 'pedra', 'ferro', 'aÃ§o', 'aco'
        ];

        // Palavras-chave para REPRESENTANTES (madeiras e vendedores)
        const palavrasRepresentante = [
            'representante', 'vendedor', 'madeira', 'serraria', 'pinus', 'eucalipto', 'mdf', 'compensado',
            'madeireira', 'laminado', 'chapa', 'prancha', 'tabua', 'tÃ¡bua', 'mourÃ£o', 'mourao',
            'estaca', 'poste', 'lenha', 'carvÃ£o', 'carvao', 'tratamento', 'autoclave'
        ];

        // Palavras-chave expandidas para CLIENTES
        const palavrasCliente = [
            'cliente', 'compra', 'comprador', 'constr', 'obra', 'loja', 'comercio', 'comÃ©rcio',
            'mercado', 'varejo', 'consumidor', 'pedido', 'encomenda', 'revenda', 'revendedor',
            'arquiteto', 'engenheiro', 'empreiteiro', 'construtora', 'incorporadora',
            'escoramento', 'reforma', 'projeto'
        ];

        // Palavras-chave para CARTÃ“RIOS
        const palavrasCartorio = [
            'cartorio', 'cartÃ³rio', 'registro', 'tabeliao', 'tabeliÃ£o', 'notas', 'escritura',
            'certidao', 'certidÃ£o', 'reconhecimento', 'firma', 'autenticacao', 'autenticaÃ§Ã£o'
        ];

        // Palavras-chave para BANCOS/FINANCEIRO
        const palavrasBanco = [
            'banco', 'financ', 'credito', 'crÃ©dito', 'emprestimo', 'emprÃ©stimo', 'investidor',
            'investimento', 'capital', 'caixa', 'bradesco', 'itau', 'itaÃº', 'santander',
            'sicredi', 'sicoob', 'nubank', 'inter', 'safra', 'topazio', 'gerente de conta'
        ];

        // Palavras-chave para SERVIÃ‡OS/PROFISSIONAIS
        const palavrasServico = [
            'advogado', 'contador', 'contabil', 'contÃ¡bil', 'dentista', 'medico', 'mÃ©dico',
            'eletricista', 'encanador', 'pedreiro', 'pintor', 'marceneiro', 'serralheiro',
            'mecanico', 'mecÃ¢nico', 'borracheiro', 'seguranca', 'seguranÃ§a', 'vigilante',
            'ti ', 'informatica', 'informÃ¡tica', 'tecnico', 'tÃ©cnico', 'operador', 'operadora',
            'agencia', 'agÃªncia', 'consultoria', 'assessoria', 'despachante'
        ];

        // Palavras-chave para PARTICULARES
        const palavrasParticular = [
            'particular', 'pessoal', 'amigo', 'primo', 'tio', 'tia', 'sobrinho', 'cunhado',
            'vizinho', 'conhecido', 'parente', 'familia', 'famÃ­lia'
        ];

        naoClassificados.forEach(contato => {
            const texto = ((contato.nome || '') + ' ' + (contato.empresa || '') + ' ' + (contato.obs || '') + ' ' + (contato.cidade || '')).toLowerCase();
            const textoNormalizado = texto.normalize('NFD').replace(/[\u0300-\u036f]/g, '');

            // Verifica CARTÃ“RIOS (prioridade alta)
            if (palavrasCartorio.some(p => texto.includes(p) || textoNormalizado.includes(p.normalize('NFD').replace(/[\u0300-\u036f]/g, '')))) {
                contato.tipo = 'cartorio';
                classificados++;
                return;
            }

            // Verifica BANCOS/FINANCEIRO
            if (palavrasBanco.some(p => texto.includes(p) || textoNormalizado.includes(p.normalize('NFD').replace(/[\u0300-\u036f]/g, '')))) {
                contato.tipo = 'banco';
                classificados++;
                return;
            }

            // Verifica MOTORISTAS
            if (palavrasMotorista.some(p => texto.includes(p) || textoNormalizado.includes(p.normalize('NFD').replace(/[\u0300-\u036f]/g, '')))) {
                contato.tipo = 'motorista';
                classificados++;
                return;
            }

            // Verifica REPRESENTANTES (madeiras e vendedores)
            if (palavrasRepresentante.some(p => texto.includes(p) || textoNormalizado.includes(p.normalize('NFD').replace(/[\u0300-\u036f]/g, '')))) {
                contato.tipo = 'representante';
                classificados++;
                return;
            }

            // Verifica FORNECEDORES
            if (palavrasFornecedor.some(p => texto.includes(p) || textoNormalizado.includes(p.normalize('NFD').replace(/[\u0300-\u036f]/g, '')))) {
                contato.tipo = 'fornecedor';
                classificados++;
                return;
            }

            // Verifica CLIENTES
            if (palavrasCliente.some(p => texto.includes(p) || textoNormalizado.includes(p.normalize('NFD').replace(/[\u0300-\u036f]/g, '')))) {
                contato.tipo = 'cliente';
                classificados++;
                return;
            }

            // Verifica SERVIÃ‡OS/PROFISSIONAIS
            if (palavrasServico.some(p => texto.includes(p) || textoNormalizado.includes(p.normalize('NFD').replace(/[\u0300-\u036f]/g, '')))) {
                contato.tipo = 'servico';
                classificados++;
                return;
            }

            // Verifica PARTICULARES
            if (palavrasParticular.some(p => texto.includes(p) || textoNormalizado.includes(p.normalize('NFD').replace(/[\u0300-\u036f]/g, '')))) {
                contato.tipo = 'particular';
                classificados++;
                return;
            }
        });

        sincronizarContatosAntigos();
        ganharXP(classificados * 2);
        salvarDados();
        verNaoClassificados();
        renderContatosTable();

        if (classificados > 0) {
            alert(`âœ… ${classificados} contatos classificados automaticamente!\n\nRestam ${naoClassificados.length - classificados} nÃ£o classificados.\n\nğŸ’¡ Dica: Configure uma API (Groq, Google) para classificaÃ§Ã£o mais inteligente.`);
        } else {
            alert('ğŸ¤” NÃ£o foi possÃ­vel classificar automaticamente.\n\nOs contatos nÃ£o possuem palavras-chave identificÃ¡veis.\n\nğŸ’¡ Dica: Configure uma API gratuita (Groq, Google) para melhor resultado!');
        }
    }
}

// Atualiza a interface para incluir novas funÃ§Ãµes
function atualizarInterfaceCompleta() {
    atualizarInterface();
    renderContatosTable();
    carregarConfigIA();
    migrarContatosAntigos();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INICIALIZAÃ‡ÃƒO COM CONHECIMENTOS BASE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function inicializarConhecimentosBase() {
    // Adiciona conhecimentos iniciais se nÃ£o existirem
    if (db.conhecimentos.length === 0) {
        const conhecimentosIniciais = [
            {
                id: Date.now() + 1,
                titulo: 'Bem-vindo ao Enside Agent',
                conteudo: 'Sou o assistente inteligente da Enside Madeiras. Posso ajudar com informaÃ§Ãµes sobre motoristas, fornecedores, clientes, fretes e muito mais. Quanto mais vocÃª me ensinar, mais inteligente eu fico!',
                categoria: 'geral',
                fonte: 'Sistema',
                tags: ['ajuda', 'inicio', 'bem-vindo'],
                dataCriacao: new Date().toISOString()
            },
            {
                id: Date.now() + 2,
                titulo: 'Como adicionar contatos',
                conteudo: 'Para adicionar contatos, vÃ¡ na aba "ğŸ“‹ Contatos Importados" e clique em "â• Novo Contato". VocÃª tambÃ©m pode importar uma planilha CSV com seus contatos. Lembre-se de classificar cada contato como Motorista, Fornecedor ou Cliente.',
                categoria: 'procedimentos',
                fonte: 'Sistema',
                tags: ['contato', 'cadastro', 'importar'],
                dataCriacao: new Date().toISOString()
            },
            {
                id: Date.now() + 3,
                titulo: 'Como cadastrar fretes',
                conteudo: 'Para cadastrar um frete, vÃ¡ na aba "ğŸšš Fretes" e clique em "â• Novo Frete". Preencha os dados do motorista, origem, destino, tipo de carga e valor. Os motoristas cadastrados ficam disponÃ­veis automaticamente para listas de WhatsApp.',
                categoria: 'logistica',
                fonte: 'Sistema',
                tags: ['frete', 'logistica', 'cadastro'],
                dataCriacao: new Date().toISOString()
            },
            {
                id: Date.now() + 4,
                titulo: 'Tipos de madeira',
                conteudo: 'Principais tipos de madeira: Pinus (construÃ§Ã£o, embalagens), Eucalipto (mÃ³veis, construÃ§Ã£o), MDF/MDP (mÃ³veis planejados), Compensado (formas, construÃ§Ã£o). Cada tipo tem caracterÃ­sticas e preÃ§os diferentes.',
                categoria: 'produtos',
                fonte: 'Sistema',
                tags: ['madeira', 'pinus', 'eucalipto', 'mdf', 'produto'],
                dataCriacao: new Date().toISOString()
            },
            {
                id: Date.now() + 5,
                titulo: 'Listas de transmissÃ£o WhatsApp',
                conteudo: 'VocÃª pode criar listas de transmissÃ£o com atÃ© 256 contatos. VÃ¡ na aba "ğŸ“± WhatsApp", crie uma lista filtrando por tipo (motoristas, fornecedores ou clientes) e exporte para usar no WhatsApp Business.',
                categoria: 'procedimentos',
                fonte: 'Sistema',
                tags: ['whatsapp', 'lista', 'transmissao'],
                dataCriacao: new Date().toISOString()
            }
        ];

        db.conhecimentos = conhecimentosIniciais;
        salvarDados();
        console.log('ğŸ“š Conhecimentos base inicializados!');
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUSCA CPF/CNPJ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function buscarDocumentos() {
    const termo = document.getElementById('buscaCpfCnpj').value.trim();
    const resultado = document.getElementById('resultadoBusca');
    
    if (!termo) {
        resultado.innerHTML = '<div class="empty-state"><div class="icon">ğŸ”</div><p>Digite um CPF ou CNPJ para buscar</p></div>';
        return;
    }
    
    // Normaliza o termo (remove pontos, traÃ§os, barras)
    const termoNormalizado = termo.replace(/[^0-9]/g, '');
    
    // Busca em arquivos organizados
    const arquivosEncontrados = db.arquivosOrganizados.filter(a => {
        const nomeNorm = (a.nome || '').replace(/[^0-9]/g, '');
        return nomeNorm.includes(termoNormalizado) || (a.nome || '').toLowerCase().includes(termo.toLowerCase());
    });
    
    // Busca em contatos
    const contatosEncontrados = db.contatosUnificados.filter(c => {
        const cpfNorm = (c.cpf || '').replace(/[^0-9]/g, '');
        const cnpjNorm = (c.cnpj || '').replace(/[^0-9]/g, '');
        return cpfNorm.includes(termoNormalizado) || cnpjNorm.includes(termoNormalizado) ||
               (c.nome || '').toLowerCase().includes(termo.toLowerCase());
    });
    
    // Busca em arquivos pendentes
    const pendentesEncontrados = db.arquivosPendentes.filter(a => {
        const nomeNorm = (a.nome || '').replace(/[^0-9]/g, '');
        return nomeNorm.includes(termoNormalizado);
    });
    
    const totalEncontrados = arquivosEncontrados.length + contatosEncontrados.length + pendentesEncontrados.length;
    
    if (totalEncontrados === 0) {
        resultado.innerHTML = `<div class="empty-state"><div class="icon">ğŸ˜”</div><p>Nenhum documento encontrado para: <strong>${termo}</strong></p></div>`;
        return;
    }
    
    let html = `<div class="alert success"><strong>âœ… ${totalEncontrados} resultado(s) encontrado(s) para: ${termo}</strong></div>`;
    
    if (arquivosEncontrados.length > 0) {
        html += `<div class="panel-title" style="font-size:1em;margin:15px 0;">ğŸ“ Arquivos Organizados (${arquivosEncontrados.length})</div>`;
        html += '<div class="triagem-grid">';
        arquivosEncontrados.forEach(a => {
            html += `<div class="triagem-card aprovado">
                <div class="file-icon">${getIconeArquivo(a.tipo)}</div>
                <div class="file-name">${a.nome}</div>
                <div class="file-info">${a.categoria} | ${a.tamanho || ''}</div>
            </div>`;
        });
        html += '</div>';
    }
    
    if (contatosEncontrados.length > 0) {
        html += `<div class="panel-title" style="font-size:1em;margin:15px 0;">ğŸ‘¥ Contatos (${contatosEncontrados.length})</div>`;
        html += '<table><thead><tr><th>Nome</th><th>Tipo</th><th>Telefone</th><th>Cidade</th></tr></thead><tbody>';
        contatosEncontrados.forEach(c => {
            html += `<tr><td>${c.nome || '-'}</td><td>${c.tipo || '-'}</td><td>${c.whatsapp || c.telefone || '-'}</td><td>${c.cidade || '-'}</td></tr>`;
        });
        html += '</tbody></table>';
    }
    
    resultado.innerHTML = html;
    ganharXP(5);
}

function limparBusca() {
    document.getElementById('buscaCpfCnpj').value = '';
    document.getElementById('resultadoBusca').innerHTML = '<div class="empty-state"><div class="icon">ğŸ”</div><p>Digite um CPF ou CNPJ para buscar documentos</p></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AGENTE IA AUTOMÃTICO - INTEGRAÃ‡ÃƒO EVOLUTION API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let agenteAutoConfig = {
    ativo: false,
    delay: 3,
    provider: 'auto',
    modo: 'completo',
    boasVindas: '',
    ignorar: [],
    logs: []
};

function carregarConfigAgenteAuto() {
    const saved = localStorage.getItem('enside_agente_auto_config');
    if (saved) {
        agenteAutoConfig = { ...agenteAutoConfig, ...JSON.parse(saved) };
        document.getElementById('agenteAutoAtivo').checked = agenteAutoConfig.ativo;
        document.getElementById('agenteAutoDelay').value = agenteAutoConfig.delay || 3;
        document.getElementById('agenteAutoProvider').value = agenteAutoConfig.provider || 'auto';
        document.getElementById('agenteAutoModo').value = agenteAutoConfig.modo || 'completo';
        document.getElementById('agenteAutoBoasVindas').value = agenteAutoConfig.boasVindas || '';
        document.getElementById('agenteAutoIgnorar').value = (agenteAutoConfig.ignorar || []).join(', ');
    }
}

function salvarConfigAgenteAuto() {
    agenteAutoConfig.ativo = document.getElementById('agenteAutoAtivo').checked;
    agenteAutoConfig.delay = parseInt(document.getElementById('agenteAutoDelay').value) || 3;
    agenteAutoConfig.provider = document.getElementById('agenteAutoProvider').value;
    agenteAutoConfig.modo = document.getElementById('agenteAutoModo').value;
    agenteAutoConfig.boasVindas = document.getElementById('agenteAutoBoasVindas').value.trim();
    agenteAutoConfig.ignorar = document.getElementById('agenteAutoIgnorar').value.split(',').map(s => s.trim().toLowerCase()).filter(s => s);
    
    localStorage.setItem('enside_agente_auto_config', JSON.stringify(agenteAutoConfig));
    
    const status = document.getElementById('statusAgenteAuto');
    status.style.display = 'block';
    status.className = 'alert success';
    status.innerHTML = 'âœ… ConfiguraÃ§Ãµes do Agente AutomÃ¡tico salvas!';
    
    if (agenteAutoConfig.ativo) {
        iniciarAgenteAuto();
    }
    
    setTimeout(() => status.style.display = 'none', 3000);
}

function toggleAgenteAuto() {
    const ativo = document.getElementById('agenteAutoAtivo').checked;
    const status = document.getElementById('statusAgenteAuto');
    
    if (ativo) {
        status.style.display = 'block';
        status.className = 'alert success';
        status.innerHTML = 'ğŸ¤– Agente AutomÃ¡tico ATIVADO! Aguardando mensagens...';
        iniciarAgenteAuto();
    } else {
        status.style.display = 'block';
        status.className = 'alert warning';
        status.innerHTML = 'âš ï¸ Agente AutomÃ¡tico DESATIVADO';
        pararAgenteAuto();
    }
}

let agenteAutoInterval = null;

function iniciarAgenteAuto() {
    if (agenteAutoInterval) clearInterval(agenteAutoInterval);
    
    // Verifica novas mensagens a cada 5 segundos
    agenteAutoInterval = setInterval(async () => {
        if (!agenteAutoConfig.ativo) return;
        await verificarNovasMensagens();
    }, 5000);
    
    adicionarLogAgente('ğŸŸ¢ Agente iniciado - Aguardando mensagens...');
}

function pararAgenteAuto() {
    if (agenteAutoInterval) {
        clearInterval(agenteAutoInterval);
        agenteAutoInterval = null;
    }
    adicionarLogAgente('ğŸ”´ Agente parado');
}

async function verificarNovasMensagens() {
    if (!CONFIG.evolutionApi?.enabled || !CONFIG.evolutionApi?.apiKey) return;
    
    try {
        // Busca mensagens nÃ£o lidas via Evolution API
        const response = await fetch(`${CONFIG.evolutionApi.baseUrl}/chat/findMessages/${CONFIG.evolutionApi.instanceName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': CONFIG.evolutionApi.apiKey
            },
            body: JSON.stringify({
                where: { fromMe: false },
                limit: 10
            })
        });
        
        if (response.ok) {
            const mensagens = await response.json();
            for (const msg of mensagens) {
                if (!msg.read && msg.body) {
                    await processarMensagemRecebida(msg);
                }
            }
        }
    } catch (error) {
        console.log('Erro ao verificar mensagens:', error.message);
    }
}

async function processarMensagemRecebida(mensagem) {
    const texto = mensagem.body?.toLowerCase() || '';
    const numero = mensagem.key?.remoteJid?.replace('@s.whatsapp.net', '') || '';
    
    // Verifica se deve ignorar
    if (agenteAutoConfig.ignorar.some(palavra => texto.includes(palavra))) {
        adicionarLogAgente(`â›” Ignorado de ${numero}: "${texto.substring(0, 50)}..."`);
        return;
    }
    
    adicionarLogAgente(`ğŸ“© Recebido de ${numero}: "${texto.substring(0, 50)}..."`);
    
    // Aguarda delay configurado
    await new Promise(resolve => setTimeout(resolve, agenteAutoConfig.delay * 1000));
    
    // Gera resposta com IA
    let resposta = '';
    
    try {
        // Usa o provedor configurado
        const provider = agenteAutoConfig.provider;
        
        if (provider === 'groq' && db.iaConfig.apis.groq) {
            resposta = await chamarGroq(texto);
        } else if (provider === 'google' && db.iaConfig.apis.google) {
            resposta = await chamarGoogle(texto);
        } else if (provider === 'openai' && db.iaConfig.apis.openai) {
            resposta = await chamarOpenAI(texto);
        } else if (provider === 'anthropic' && db.iaConfig.apis.anthropic) {
            resposta = await chamarClaude(texto);
        } else {
            // Auto - tenta na ordem de preferÃªncia
            resposta = await processarMensagemIA(texto);
        }
    } catch (error) {
        resposta = agenteAutoConfig.boasVindas || 'OlÃ¡! Recebi sua mensagem e em breve retornarei. Obrigado pelo contato!';
    }
    
    // Envia resposta via Evolution API
    if (resposta && numero) {
        await enviarRespostaEvolution(numero, resposta);
        adicionarLogAgente(`ğŸ“¤ Respondido para ${numero}: "${resposta.substring(0, 50)}..."`);
    }
}

async function enviarRespostaEvolution(numero, mensagem) {
    try {
        const response = await fetch(`${CONFIG.evolutionApi.baseUrl}/message/sendText/${CONFIG.evolutionApi.instanceName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'apikey': CONFIG.evolutionApi.apiKey
            },
            body: JSON.stringify({
                number: numero,
                text: mensagem
            })
        });
        
        if (response.ok) {
            evolutionStats.mensagensEnviadas++;
            document.getElementById('evolutionMensagensEnviadas').textContent = evolutionStats.mensagensEnviadas;
        }
    } catch (error) {
        adicionarLogAgente(`âŒ Erro ao enviar: ${error.message}`);
    }
}

function adicionarLogAgente(mensagem) {
    const timestamp = new Date().toLocaleTimeString('pt-BR');
    const log = `[${timestamp}] ${mensagem}`;
    
    agenteAutoConfig.logs = agenteAutoConfig.logs || [];
    agenteAutoConfig.logs.unshift(log);
    
    // MantÃ©m apenas os Ãºltimos 100 logs
    if (agenteAutoConfig.logs.length > 100) {
        agenteAutoConfig.logs = agenteAutoConfig.logs.slice(0, 100);
    }
    
    renderLogsAgente();
}

function renderLogsAgente() {
    const container = document.getElementById('logsAgente');
    if (!container) return;
    
    if (!agenteAutoConfig.logs || agenteAutoConfig.logs.length === 0) {
        container.innerHTML = '<div style="color:rgba(255,255,255,0.5);">Nenhum log ainda...</div>';
        return;
    }
    
    container.innerHTML = agenteAutoConfig.logs.map(log => {
        let cor = 'rgba(255,255,255,0.7)';
        if (log.includes('ğŸŸ¢')) cor = '#4ade80';
        if (log.includes('ğŸ”´')) cor = '#f87171';
        if (log.includes('ğŸ“©')) cor = '#60a5fa';
        if (log.includes('ğŸ“¤')) cor = '#4ade80';
        if (log.includes('âŒ')) cor = '#f87171';
        if (log.includes('â›”')) cor = '#fbbf24';
        return `<div style="color:${cor};margin-bottom:5px;">${log}</div>`;
    }).join('');
}

function verLogsAgente() {
    const container = document.getElementById('logsAgenteContainer');
    container.style.display = container.style.display === 'none' ? 'block' : 'none';
    renderLogsAgente();
}

async function testarAgenteAuto() {
    const status = document.getElementById('statusAgenteAuto');
    status.style.display = 'block';
    status.className = 'alert info';
    status.innerHTML = 'ğŸ§ª Testando resposta do agente...';
    
    try {
        const mensagemTeste = 'OlÃ¡, qual o preÃ§o do eucalipto tratado?';
        const resposta = await processarMensagemIA(mensagemTeste);
        
        status.className = 'alert success';
        status.innerHTML = `âœ… <strong>Teste bem-sucedido!</strong><br><br>
            <strong>Pergunta:</strong> ${mensagemTeste}<br><br>
            <strong>Resposta IA:</strong> ${resposta.substring(0, 200)}...`;
        
        adicionarLogAgente(`ğŸ§ª Teste: "${mensagemTeste}" -> "${resposta.substring(0, 50)}..."`);
    } catch (error) {
        status.className = 'alert danger';
        status.innerHTML = `âŒ Erro no teste: ${error.message}<br><br>
            <strong>Dica:</strong> Configure pelo menos uma API de IA (Groq, Google, OpenAI ou Claude).`;
    }
}

// Carrega config do agente ao iniciar
setTimeout(() => {
    carregarConfigAgenteAuto();
    if (agenteAutoConfig.ativo) {
        iniciarAgenteAuto();
    }
}, 2000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEBHOOK WHATSAPP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let webhookConfig = {
    url: '',
    token: '',
    eventos: { mensagens: true, status: false, conexao: false }
};

function carregarWebhookConfig() {
    const saved = localStorage.getItem('enside_webhook_config');
    if (saved) {
        webhookConfig = JSON.parse(saved);
        document.getElementById('webhookUrl').value = webhookConfig.url || '';
        document.getElementById('webhookToken').value = webhookConfig.token || '';
        document.getElementById('webhookMensagens').checked = webhookConfig.eventos?.mensagens ?? true;
        document.getElementById('webhookStatus').checked = webhookConfig.eventos?.status ?? false;
        document.getElementById('webhookConexao').checked = webhookConfig.eventos?.conexao ?? false;
    }
}

function salvarWebhook() {
    webhookConfig.url = document.getElementById('webhookUrl').value.trim();
    webhookConfig.token = document.getElementById('webhookToken').value.trim();
    webhookConfig.eventos = {
        mensagens: document.getElementById('webhookMensagens').checked,
        status: document.getElementById('webhookStatus').checked,
        conexao: document.getElementById('webhookConexao').checked
    };
    
    localStorage.setItem('enside_webhook_config', JSON.stringify(webhookConfig));
    
    const status = document.getElementById('statusWebhook');
    status.style.display = 'block';
    status.className = 'alert success';
    status.innerHTML = 'âœ… ConfiguraÃ§Ãµes do Webhook salvas com sucesso!';
    
    setTimeout(() => status.style.display = 'none', 3000);
}

async function testarWebhook() {
    const url = document.getElementById('webhookUrl').value.trim();
    const token = document.getElementById('webhookToken').value.trim();
    const status = document.getElementById('statusWebhook');
    
    if (!url) {
        status.style.display = 'block';
        status.className = 'alert warning';
        status.innerHTML = 'âš ï¸ Informe a URL do Webhook';
        return;
    }
    
    status.style.display = 'block';
    status.className = 'alert info';
    status.innerHTML = 'ğŸ”„ Testando conexÃ£o...';
    
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                type: 'test',
                timestamp: new Date().toISOString(),
                message: 'Teste de conexÃ£o ENSIDE SYSTEM'
            })
        });
        
        if (response.ok) {
            status.className = 'alert success';
            status.innerHTML = 'âœ… Webhook funcionando! ConexÃ£o estabelecida.';
        } else {
            status.className = 'alert warning';
            status.innerHTML = `âš ï¸ Webhook respondeu com status: ${response.status}`;
        }
    } catch (error) {
        status.className = 'alert danger';
        status.innerHTML = `âŒ Erro ao conectar: ${error.message}`;
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIMULAÃ‡ÃƒO DE CONVERSAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let conversasSimuladas = [];

function simularConversa() {
    const nome = document.getElementById('simNomeContato').value.trim() || 'Contato';
    const numero = document.getElementById('simNumero').value.trim() || '5518999999999';
    const mensagem = document.getElementById('simMensagem').value.trim();
    
    if (!mensagem) {
        alert('Digite uma mensagem para simular');
        return;
    }
    
    conversasSimuladas.push({
        tipo: 'enviada',
        nome: 'VocÃª',
        mensagem: mensagem,
        hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
    });
    
    renderSimulacao();
    document.getElementById('simMensagem').value = '';
}

async function simularResposta() {
    const nome = document.getElementById('simNomeContato').value.trim() || 'Contato';
    const ultimaMensagem = conversasSimuladas.filter(c => c.tipo === 'enviada').pop();
    
    if (!ultimaMensagem) {
        alert('Envie uma mensagem primeiro para simular uma resposta');
        return;
    }
    
    // Simula resposta da IA
    const container = document.getElementById('simulacaoContainer');
    container.innerHTML += '<div style="text-align:center;padding:10px;color:rgba(255,255,255,0.5);">ğŸ¤– Gerando resposta...</div>';
    
    try {
        const resposta = await processarMensagemIA(ultimaMensagem.mensagem);
        conversasSimuladas.push({
            tipo: 'recebida',
            nome: nome,
            mensagem: resposta,
            hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
        });
    } catch (error) {
        conversasSimuladas.push({
            tipo: 'recebida',
            nome: nome,
            mensagem: 'OlÃ¡! Recebi sua mensagem. Como posso ajudar?',
            hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
        });
    }
    
    renderSimulacao();
}

function renderSimulacao() {
    const container = document.getElementById('simulacaoContainer');
    
    if (conversasSimuladas.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ’¬</div><p>Simule uma conversa para visualizar aqui</p></div>';
        return;
    }
    
    container.innerHTML = conversasSimuladas.map(c => `
        <div style="display:flex;margin-bottom:10px;${c.tipo === 'enviada' ? 'justify-content:flex-end;' : ''}">
            <div style="max-width:70%;padding:10px 15px;border-radius:15px;${c.tipo === 'enviada' ? 'background:var(--whatsapp);color:#fff;border-bottom-right-radius:5px;' : 'background:rgba(255,255,255,0.1);border-bottom-left-radius:5px;'}">
                <div style="font-size:0.75em;opacity:0.7;margin-bottom:3px;">${c.nome} - ${c.hora}</div>
                <div>${c.mensagem}</div>
            </div>
        </div>
    `).join('');
    
    container.scrollTop = container.scrollHeight;
}

function limparSimulacao() {
    conversasSimuladas = [];
    renderSimulacao();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTROS POR UF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ESTADOS_BR = [
    'AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA',
    'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN',
    'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'
];

function popularFiltrosUF(selectId) {
    const select = document.getElementById(selectId);
    if (!select) return;
    
    select.innerHTML = '<option value="">Todos os Estados</option>';
    ESTADOS_BR.forEach(uf => {
        select.innerHTML += `<option value="${uf}">${uf}</option>`;
    });
}

function filtrarContatosPorUF(uf) {
    if (!uf) return db.contatosUnificados;
    return db.contatosUnificados.filter(c => {
        const cidade = (c.cidade || '').toUpperCase();
        return cidade.includes(uf) || cidade.endsWith(` ${uf}`) || cidade.endsWith(`-${uf}`);
    });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA DE RECOMENDAÃ‡Ã•ES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function gerarRecomendacoes() {
    const recomendacoes = [];
    const contatos = db.contatosUnificados || [];
    const naoClassificados = contatos.filter(c => !c.tipo || c.tipo === 'indefinido');
    
    // RecomendaÃ§Ã£o: Classificar contatos
    if (naoClassificados.length > 0) {
        recomendacoes.push({
            tipo: 'warning',
            icone: 'ğŸ“Š',
            titulo: 'Classificar Contatos',
            descricao: `VocÃª tem ${naoClassificados.length} contatos nÃ£o classificados. Classifique-os para melhor organizaÃ§Ã£o.`,
            acao: 'classificarContatosIA()',
            botao: 'Classificar com IA'
        });
    }
    
    // RecomendaÃ§Ã£o: Configurar APIs
    const apisConfiguradas = Object.values(db.iaConfig?.apis || {}).filter(v => v && v.length > 5).length;
    if (apisConfiguradas < 2) {
        recomendacoes.push({
            tipo: 'info',
            icone: 'ğŸ¤–',
            titulo: 'Configurar APIs de IA',
            descricao: 'Configure mais APIs para melhorar as respostas da IA. Groq e Google sÃ£o gratuitos!',
            acao: "abrirAba('agente')",
            botao: 'Configurar APIs'
        });
    }
    
    // RecomendaÃ§Ã£o: Fazer backup
    const ultimoBackup = localStorage.getItem('enside_ultimo_backup');
    const diasSemBackup = ultimoBackup ? Math.floor((Date.now() - new Date(ultimoBackup)) / (1000 * 60 * 60 * 24)) : 999;
    if (diasSemBackup > 7) {
        recomendacoes.push({
            tipo: 'danger',
            icone: 'ğŸ’¾',
            titulo: 'Fazer Backup',
            descricao: diasSemBackup > 30 ? 'VocÃª nunca fez backup! Proteja seus dados.' : `Ãšltimo backup hÃ¡ ${diasSemBackup} dias. Recomendamos backup semanal.`,
            acao: 'exportarBackup()',
            botao: 'Fazer Backup Agora'
        });
    }
    
    // RecomendaÃ§Ã£o: Evolution API
    if (!CONFIG.evolutionApi?.enabled) {
        recomendacoes.push({
            tipo: 'success',
            icone: 'ğŸ“±',
            titulo: 'Configurar Evolution API',
            descricao: 'Configure a Evolution API para enviar mensagens WhatsApp automaticamente.',
            acao: "abrirAba('whatsapp')",
            botao: 'Configurar WhatsApp'
        });
    }
    
    return recomendacoes;
}

function renderRecomendacoes(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const recomendacoes = gerarRecomendacoes();
    
    if (recomendacoes.length === 0) {
        container.innerHTML = '<div class="alert success">âœ… Tudo certo! Nenhuma recomendaÃ§Ã£o no momento.</div>';
        return;
    }
    
    container.innerHTML = recomendacoes.map(r => `
        <div class="alert ${r.tipo}" style="margin-bottom:10px;">
            <strong>${r.icone} ${r.titulo}</strong><br>
            ${r.descricao}<br>
            <button class="btn btn-${r.tipo === 'danger' ? 'danger' : r.tipo === 'warning' ? 'warning' : 'primary'}" onclick="${r.acao}" style="margin-top:10px;">${r.botao}</button>
        </div>
    `).join('');
}

function getIconeArquivo(tipo) {
    const icones = {
        'PDF': 'ğŸ“„', 'DOC': 'ğŸ“ƒ', 'DOCX': 'ğŸ“ƒ', 'TXT': 'ğŸ—’ï¸',
        'XLS': 'ğŸ“Š', 'XLSX': 'ğŸ“Š', 'CSV': 'ğŸ“Š',
        'JPG': 'ğŸ–¼ï¸', 'JPEG': 'ğŸ–¼ï¸', 'PNG': 'ğŸ–¼ï¸', 'GIF': 'ğŸ–¼ï¸',
        'MP4': 'ğŸ¬', 'MOV': 'ğŸ¬', 'AVI': 'ğŸ¬',
        'PY': 'ğŸ', 'JS': 'ğŸŸ¨', 'HTML': 'ğŸŒ', 'CSS': 'ğŸ¨',
        'ZIP': 'ğŸ“¦', 'RAR': 'ğŸ“¦'
    };
    return icones[tipo?.toUpperCase()] || 'ğŸ“';
}

function abrirPasta(pasta) {
    const caminho = `/Users/andersonenside/ENSIDE_MASTER/ğŸ“‚ DOCUMENTOS_ORGANIZADOS/${pasta}`;
    alert(`Abrir pasta: ${caminho}\n\nNo Mac, use o Finder para navegar atÃ© esta pasta.`);
}

function filtrarCategoria(categoria) {
    abrirAba('organizados');
    // Filtra arquivos pela categoria
    const filtro = document.getElementById('filtroCategoria');
    if (filtro) filtro.value = categoria;
    renderArquivosOrganizados();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function atualizarDashboard() {
    const contatos = db.contatosUnificados || [];
    const motoristas = contatos.filter(c => c.tipo === 'motorista').length;
    const fornecedores = contatos.filter(c => c.tipo === 'fornecedor').length;
    const clientes = contatos.filter(c => c.tipo === 'cliente').length;
    
    document.getElementById('dashContatos').textContent = contatos.length;
    document.getElementById('dashMotoristas').textContent = motoristas;
    document.getElementById('dashFornecedores').textContent = fornecedores;
    document.getElementById('dashClientes').textContent = clientes;
    document.getElementById('dashFretes').textContent = (db.fretes || []).length;
    document.getElementById('dashArquivos').textContent = (db.arquivosOrganizados || []).length;
    document.getElementById('dashConhecimentos').textContent = (db.conhecimentos || []).length;
}

function novoContato() {
    abrirAba('contatos');
    // Abre modal de novo contato se existir
}

function novoFrete() {
    abrirAba('fretes');
    // Abre modal de novo frete se existir
}

function exportarBackup() {
    const backup = {
        sistema: 'ENSIDE_SYSTEM_v10.0_INTEGRADO',
        versao: '10.0',
        data: new Date().toISOString(),
        contatosUnificados: db.contatosUnificados,
        arquivosOrganizados: db.arquivosOrganizados,
        arquivosPendentes: db.arquivosPendentes,
        fretes: db.fretes,
        conhecimentos: db.conhecimentos,
        listas: db.listas,
        iaConfig: db.iaConfig,
        agente: db.agente
    };
    
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `enside_backup_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
    alert('âœ… Backup exportado com sucesso!');
}

// Atualiza dashboard ao carregar
function atualizarInterfaceCompletaComDashboard() {
    atualizarInterfaceCompleta();
    atualizarDashboard();
}

// InicializaÃ§Ã£o assÃ­ncrona com IndexedDB
(async function() {
    await carregarDados();
    carregarConfig();
    carregarConfigWA();
    migrarContatosAntigos();
    inicializarConhecimentosBase();
    atualizarInterfaceCompletaComDashboard();
})();

// Sincroniza com servidor ao carregar
sincronizarComServidor().then(r => {
    if (r && r.success) console.log(`ğŸ“ ${r.total} arquivos sincronizados do servidor`);
});

console.log('âœ… ENSIDE SYSTEM v10.0 INTEGRADO pronto!');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SISTEMA DE TEMAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('enside-theme', theme);
    
    // Atualiza botÃµes de tema
    document.querySelectorAll('.theme-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.textContent = '';
        if (btn.dataset.theme === theme) {
            btn.classList.add('active');
            btn.textContent = 'âœ”';
        }
    });
    
    console.log(`ğŸ¨ Tema alterado para: ${theme}`);
}

function setMode(mode) {
    document.documentElement.setAttribute('data-mode', mode);
    localStorage.setItem('enside-mode', mode);
    
    // Atualiza botÃµes de modo
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.mode === mode) {
            btn.classList.add('active');
        }
    });
    
    console.log(`ğŸŒ™ Modo alterado para: ${mode}`);
}

function carregarPreferenciasTema() {
    const savedTheme = localStorage.getItem('enside-theme') || 'green';
    const savedMode = localStorage.getItem('enside-mode') || 'dark';
    
    setTheme(savedTheme);
    setMode(savedMode);
}

// Carrega preferÃªncias de tema ao iniciar
carregarPreferenciasTema();

</script>
</body>
</html>
